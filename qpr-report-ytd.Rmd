---
title: "Quarterly Performance Report"
output: 
  powerpoint_presentation:
    reference_doc: template.pptx
---

```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 10000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
})

```

```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```

```{r Productivity Data Import, echo = FALSE, warning = FALSE, message = FALSE}

# productivity_raw <- read_excel("C:/Users/kweons01/Desktop/Strategic Initiatives - So Youn/Github/performance-report/All Productivity 2021-Jun 2022 by dept.xlsx")
productivity_raw <- read_excel("All Productivity Jan-Dec23.xlsx")
productivity_raw <- productivity_raw %>%
  filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
  filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
  filter(!is.na(`Master Dept`)) %>%
  mutate(NPI = as.character(NPI)) %>%
  pivot_longer(18:length(productivity_raw),
               names_to = "Quarter",
               values_to = "Productivity") %>%
  mutate(Quarter = as.yearqtr(Quarter))

# waitTime_prov <- merge(waitTime_prov, 
#                        productivity_raw %>%
#                          dplyr::select(NPI, `2022 Calculate %`, `2023 Calulate 2023`) %>%
#                          pitvot_longer(2:3,
#                                        values_to ),
#                        by.x = c("NPI", "Appt.Made.YearQtr"),
#                        by.y = c("NPI", "Quarter"), all.x = TRUE, all.y = FALSE)

# productivity_raw <- merge(productivity_raw,
#                          waitTime_prov[,c("NPI", "Appt.Made.YearQtr", "Campus.Specialty.Group", "Campus.Specialty.SubGroup", "Site", "med_wait")],
#                           by.x = c("NPI", "Quarter"),
#                           by.y = c("NPI", "Appt.Made.YearQtr"))

productivity_raw <- productivity_raw %>%
  arrange(Productivity) %>%
  mutate(`wRVU Percent Increase/Decrease (Jan-Dec)` = `wRVU Percent Increase/Decrease (Jan-Dec)`*100,
        `Collections Percent Increase/Decrease (Jan-Dec)` = `Collections Percent Increase/Decrease (Jan-Dec)`*100)
  

```

```{r Reactable Theme, echo = FALSE, warning = FALSE, message = FALSE}

# Flextable Custom Theme
theme_design <- function(x) {
  x <- border_remove(x)
  x <- fontsize(x, size = 10, part = "all")
  x <- font(x, fontname = "Calibri", part = "all")
  x <- align(x, align = "center", part = "all")
  x <- align(x, align = "left", part = "footer")
  x <- bold(x, bold = TRUE, part = "header")
  x <- color(x, color = "white", part = "header")
  x <- padding(x, padding = 6, part = "all")
  x <- border_inner_h(x, border = fp_border_default(width = 1, color = "white"), part="all")
  x <- border_inner_v(x, border =fp_border_default(width = 4, color = "white"), part="all")
  x <- set_table_properties(x, layout = "fixed")
  x
}

theme_new_line <- function(base_size = 12,
                           base_family = "Calibri",
                           base_line_size = base_size / 170,
                           base_rect_size = base_size / 170) {
  theme_bw(
    base_size = base_size,
    base_family = base_family,
    base_line_size = base_line_size
  ) %+replace%
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 20),
          plot.subtitle = element_text(hjust=0.5,vjust=-1, size = 16, face = "italic"),
          plot.caption = element_text(hjust = 0, size = 14, face = "italic"),
          legend.position = "top",
          legend.text = element_text(size="12"),
          legend.direction = "horizontal",
          legend.key.size = unit(1.0,"cm"),
          legend.title = element_blank(),
          axis.title = element_text(size="14"),
          axis.text = element_text(size="12"),
          axis.title.x = element_blank(),
          axis.title.y = element_blank(),
          panel.grid.minor = element_blank(),
          axis.line = element_line(size = 0.3, colour = "black"),
          plot.margin = margin(10,10,10,10))
}


# Heat Map Conditional Formatting Example 
# colourer <- col_numeric(
#   palette = c("wheat", "red"),
#   domain = c(0, 1))
# 
# bg(ft_2, 
#     i = 1:2,
#     j = c("Sepal.Length", "Sepal.Width",
#           "Petal.Length", "Petal.Width"),
#     bg = colourer)

```

```{r}

specialties <- c(
  "Cardiovascular Institute/Cardiology",
  "Cardiovascular Surgery",
  "Dermatology",
  "Genetics & Genomic Sciences",
  "Geriatrics",
  "Neurology",
  "Neurosurgery",
  "OB-GYN",
  "Ophthalmology",
  "Orthopedics",
  "Otolaryngology",
  "Rehabilitation and Human Performance",
  "Surgery",
  "Thoracic Surgery",
  "Tisch Institute/Hematology Oncology",
  "Transplant Institute",
  "Breast Surgery",
  "Urology"
  )

# for(i in specialties){
#   # print(dept_monthly_vol_function(i))
#   print(dept_payer_mix_ytd("Otolaryngology"))
#   # print(site_time_to_appt_function(i))
#   # print(overall_time_to_appt_dist_function(i))
# }


```

```{r Monthly Volume Graph Output, echo = FALSE, warning = FALSE, message = FALSE}

dept_monthly_vol_function <- function(department){
  # department <- "Dermatology"
  dept_vol <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method != "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Campus.Specialty.Group, Appt.Year, Appt.Month, Visit.Method) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0))
  
  
  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  
  ggplot(dept_vol, aes(x= factor(Appt.Month, levels = monthOptions),
                       y=monthly_vol, group=Visit.Method, fill=Visit.Method))+
    geom_bar(position="stack",stat="identity", width=0.7)+
    facet_grid(.~Appt.Year, scales = "free", space = "free_x") + 
    scale_fill_manual(values=c("#212070","#d80b8c","#00aeef","#7f7f7f","#ffc000","#7030a0","#5753d0","#5cd3ff"))+
    scale_y_continuous(limits=c(0, max((dept_vol %>% group_by(Appt.Year, Appt.Month) %>% summarise(total = sum(monthly_vol)))$total)*1.1), 
                       labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    labs(title = "Ambulatory Visit Volume",
         subtitle = department,
         x = NULL, y = NULL, fill = "Site")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_blank(),
            axis.text = element_text(size="10"),
            axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label=paste0(prettyNum(monthly_vol, big.mark = ','),"\n","(",perc,")")), color="white", 
                size=3, fontface="bold", position = position_stack(vjust = 0.5))+
    stat_summary(fun.y = sum, vjust = -1, aes(label=ifelse(..y.. == 0,"",prettyNum(..y.., big.mark = ',')), group = Appt.Month), geom="text", color="black", 
                 size=3)+
    guides(fill = guide_legend(nrow = 1))
    
}


dept_monthly_vol_function_sub <- function(department, subspecialty){

  # department <- "Otolaryngology"
  # subspecialty <- "Audiology"
  dept_vol <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method != "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Campus.Specialty.SubGroup, Appt.Year, Appt.Month, Visit.Method) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0))


  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

  ggplot(dept_vol, aes(x= factor(Appt.Month, levels = monthOptions),
                       y=monthly_vol, group=Visit.Method, fill=Visit.Method))+
    geom_bar(position="stack",stat="identity", width=0.7)+
    facet_grid(.~Appt.Year, scales = "free", space = "free_x") +
    scale_fill_manual(values=c("#212070","#d80b8c","#00aeef","#7f7f7f","#ffc000","#7030a0","#5753d0","#5cd3ff"))+
    scale_y_continuous(limits=c(0, max((dept_vol %>% group_by(Appt.Year, Appt.Month) %>% summarise(total = sum(monthly_vol)))$total)*1.1),
                       labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    labs(title = "Ambulatory Visit Volume",
         subtitle = paste0(department, " - ", subspecialty),
         x = NULL, y = NULL, fill = "Site")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_blank(),
            axis.text = element_text(size="10"),
            axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label=paste0(prettyNum(monthly_vol, big.mark = ','),"\n","(",perc,")")), color="white",
                size=3, fontface="bold", position = position_stack(vjust = 0.5))+
    stat_summary(fun.y = sum, vjust = -1, aes(label=ifelse(..y.. == 0,"",prettyNum(..y.., big.mark = ',')), group = Appt.Month), geom="text", color="black",
                 size=3)+
    guides(fill = guide_legend(nrow = 1))

}

```

```{r Monthly Volume Graph Output (Office Visits), echo = FALSE, warning = FALSE, message = FALSE}

dept_monthly_vol_office_function <- function(department){
  # department <- "Dermatology"
  dept_vol <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method != "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Campus.Specialty.Group, Appt.Year, Appt.Month, Visit.Method) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0))
  
  
  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  
  ggplot(dept_vol, aes(x= factor(Appt.Month, levels = monthOptions),
                       y=monthly_vol, group=Visit.Method, fill=Visit.Method))+
    geom_bar(position="stack",stat="identity", width=0.7)+
    facet_grid(.~Appt.Year, scales = "free", space = "free_x") + 
    scale_fill_manual(values=c("#212070","#d80b8c","#00aeef","#7f7f7f","#ffc000","#7030a0","#5753d0","#5cd3ff"))+
    scale_y_continuous(limits=c(0, max((dept_vol %>% group_by(Appt.Year, Appt.Month) %>% summarise(total = sum(monthly_vol)))$total)*1.1), 
                       labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    labs(title = "Ambulatory Visit Volume",
         subtitle = department,
         x = NULL, y = NULL, fill = "Site")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_blank(),
            axis.text = element_text(size="10"),
            axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label=paste0(prettyNum(monthly_vol, big.mark = ','),"\n","(",perc,")")), color="white", 
                size=2, fontface="bold", position = position_stack(vjust = 0.5))+
    stat_summary(fun.y = sum, vjust = -1, aes(label=ifelse(..y.. == 0,"",prettyNum(..y.., big.mark = ',')), group = Appt.Month), geom="text", color="black", 
                 size=3)+
    guides(fill = guide_legend(nrow = 1))
    
}


dept_monthly_vol_office_function_sub <- function(department, subspecialty){

  # department <- i
  # subspecialty <- "Audiology"
  dept_vol <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method != "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Campus.Specialty.SubGroup, Appt.Year, Appt.Month, Visit.Method) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0))


  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")

  ggplot(dept_vol, aes(x= factor(Appt.Month, levels = monthOptions),
                       y=monthly_vol, group=Visit.Method, fill=Visit.Method))+
    geom_bar(position="stack",stat="identity", width=0.7)+
    facet_grid(.~Appt.Year, scales = "free", space = "free_x") +
    scale_fill_manual(values=c("#212070","#d80b8c","#00aeef","#7f7f7f","#ffc000","#7030a0","#5753d0","#5cd3ff"))+
    scale_y_continuous(limits=c(0, max((dept_vol %>% group_by(Appt.Year, Appt.Month) %>% summarise(total = sum(monthly_vol)))$total)*1.1),
                       labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    labs(title = "Ambulatory Visit Volume",
         subtitle = paste0(department, " - ", subspecialty),
         x = NULL, y = NULL, fill = "Site")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_blank(),
            axis.text = element_text(size="10"),
            axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label=paste0(prettyNum(monthly_vol, big.mark = ','),"\n","(",perc,")")), color="white",
                size=2.5, fontface="bold", position = position_stack(vjust = 0.5))+
    stat_summary(fun.y = sum, vjust = -1, aes(label=ifelse(..y.. == 0,"",prettyNum(..y.., big.mark = ',')), group = Appt.Month), geom="text", color="black",
                 size=3.5)+
    guides(fill = guide_legend(nrow = 1))

}

```

```{r Monthly Volume Table Output, echo = FALSE, warning = FALSE, message = FALSE}

dept_monthly_vol_tbl <- function(department){
  
  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  
  vol_trending <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    group_by(Site, Appt.Year, Appt.Month) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = monthly_vol) %>%
    arrange(factor(Appt.Month, levels = monthOptions)) %>%
    arrange(Site) %>%
    group_by(Appt.Month) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"Total"))) %>%
    ungroup()

  ytd_total <- vol_trending[!is.na(vol_trending[length(vol_trending)]),]
  ytd_total <- ytd_total %>%
    group_by(Site) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"YTD Total"))) %>%
    filter(Appt.Month == "YTD Total")

  vol_trending <- bind_rows(vol_trending, ytd_total)
  vol_trending$perc_change <- round((vol_trending$`2023` - vol_trending$`2022`)/vol_trending$`2022`,2)*100

  vol_trending <- vol_trending %>%
    pivot_longer(3:5,
                 names_to = "variable",
                 values_to = "value") %>%
    pivot_wider(names_from = c("Site","variable"),
                values_from = value) 

  vol_trending <- vol_trending %>%
    mutate_at(vars(contains('change')), ~ifelse(is.na(.),.,paste0(.,"%")))
  
  
  # Table Output
  tbl_output <- 
    vol_trending %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 14, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    align(j = c(2:(length(vol_trending))), align = "center", part = "all") %>%
    vline(j = 1, border = fp_border(color="grey", width = 0.5), part="body") %>%
    vline(j = c((length(vol_trending)-3)), border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = nrow(vol_trending)-1, border = fp_border(color="grey", width = 2), part="body") %>%
    bold(j = c(1:(length(vol_trending))), part = "header") %>%
    bg(j = c(1:(length(vol_trending))), bg = "#212070", part = "header") %>%
    bg(j = c((length(vol_trending)-2):(length(vol_trending))), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:length(vol_trending)), color = "white", part = "header")
  
  return(tbl_output)
  
}


dept_monthly_vol_tbl_sub <- function(department, subspecialty){
  
  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  
  vol_trending <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    group_by(Site, Appt.Year, Appt.Month) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = monthly_vol) %>%
    arrange(factor(Appt.Month, levels = monthOptions)) %>%
    arrange(Site) %>%
    group_by(Appt.Month) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"Total"))) %>%
    ungroup()

  ytd_total <- vol_trending[!is.na(vol_trending[length(vol_trending)]),]
  ytd_total <- ytd_total %>%
    group_by(Site) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"YTD Total"))) %>%
    filter(Appt.Month == "YTD Total")

  vol_trending <- bind_rows(vol_trending, ytd_total)
  vol_trending$perc_change <- round((vol_trending$`2023` - vol_trending$`2022`)/vol_trending$`2022`,2)*100

  vol_trending <- vol_trending %>%
    pivot_longer(3:5,
                 names_to = "variable",
                 values_to = "value") %>%
    pivot_wider(names_from = c("Site","variable"),
                values_from = value) 

  vol_trending <- vol_trending %>%
    mutate_at(vars(contains('change')), ~ifelse(is.na(.),.,paste0(.,"%")))
  
  
  # Table Output
  tbl_output <- 
    vol_trending %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 14, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    align(j = c(2:(length(vol_trending))), align = "center", part = "all") %>%
    vline(j = 1, border = fp_border(color="grey", width = 0.5), part="body") %>%
    vline(j = c((length(vol_trending)-3)), border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = nrow(vol_trending)-1, border = fp_border(color="grey", width = 2), part="body") %>%
    bold(j = c(1:(length(vol_trending))), part = "header") %>%
    bg(j = c(1:(length(vol_trending))), bg = "#212070", part = "header") %>%
    bg(j = c((length(vol_trending)-2):(length(vol_trending))), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:length(vol_trending)), color = "white", part = "header")
  
  return(tbl_output)
  
}

```

```{r Monthly Volume Table Output (Office), echo = FALSE, warning = FALSE, message = FALSE}

dept_monthly_vol_office_tbl <- function(department){
  
  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  
  vol_trending <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    group_by(Site, Appt.Year, Appt.Month) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = monthly_vol) %>%
    arrange(factor(Appt.Month, levels = monthOptions)) %>%
    arrange(Site) %>%
    group_by(Appt.Month) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"Total"))) %>%
    ungroup()

  ytd_total <- vol_trending[!is.na(vol_trending[length(vol_trending)]),]
  ytd_total <- ytd_total %>%
    group_by(Site) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"YTD Total"))) %>%
    filter(Appt.Month == "YTD Total")

  vol_trending <- bind_rows(vol_trending, ytd_total)
  vol_trending$perc_change <- round((vol_trending$`2023` - vol_trending$`2022`)/vol_trending$`2022`,2)*100

  vol_trending <- vol_trending %>%
    pivot_longer(3:5,
                 names_to = "variable",
                 values_to = "value") %>%
    pivot_wider(names_from = c("Site","variable"),
                values_from = value) 

  vol_trending <- vol_trending %>%
    mutate_at(vars(contains('change')), ~ifelse(is.na(.),.,paste0(.,"%")))
  
  
  # Table Output
  tbl_output <- 
    vol_trending %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 14, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    align(j = c(2:(length(vol_trending))), align = "center", part = "all") %>%
    vline(j = 1, border = fp_border(color="grey", width = 0.5), part="body") %>%
    vline(j = c((length(vol_trending)-3)), border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = nrow(vol_trending)-1, border = fp_border(color="grey", width = 2), part="body") %>%
    bold(j = c(1:(length(vol_trending))), part = "header") %>%
    bg(j = c(1:(length(vol_trending))), bg = "#212070", part = "header") %>%
    bg(j = c((length(vol_trending)-2):(length(vol_trending))), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:length(vol_trending)), color = "white", part = "header")
  
  return(tbl_output)
  
}


dept_monthly_vol_office_tbl_sub <- function(department, subspecialty){
  
  monthOptions <- c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  
  vol_trending <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    group_by(Site, Appt.Year, Appt.Month) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = monthly_vol) %>%
    arrange(factor(Appt.Month, levels = monthOptions)) %>%
    arrange(Site) %>%
    group_by(Appt.Month) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"Total"))) %>%
    ungroup()

  ytd_total <- vol_trending[!is.na(vol_trending[length(vol_trending)]),]
  ytd_total <- ytd_total %>%
    group_by(Site) %>%
    bind_rows(summarise(.,
                        across(where(is.numeric), sum),
                        across(where(is.character), ~"YTD Total"))) %>%
    filter(Appt.Month == "YTD Total")

  vol_trending <- bind_rows(vol_trending, ytd_total)
  vol_trending$perc_change <- round((vol_trending$`2023` - vol_trending$`2022`)/vol_trending$`2022`,2)*100

  vol_trending <- vol_trending %>%
    pivot_longer(3:5,
                 names_to = "variable",
                 values_to = "value") %>%
    pivot_wider(names_from = c("Site","variable"),
                values_from = value) 

  vol_trending <- vol_trending %>%
    mutate_at(vars(contains('change')), ~ifelse(is.na(.),.,paste0(.,"%")))
  
  
  # Table Output
  tbl_output <- 
    vol_trending %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 14, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    align(j = c(2:(length(vol_trending))), align = "center", part = "all") %>%
    vline(j = 1, border = fp_border(color="grey", width = 0.5), part="body") %>%
    vline(j = c((length(vol_trending)-3)), border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = nrow(vol_trending)-1, border = fp_border(color="grey", width = 2), part="body") %>%
    bold(j = c(1:(length(vol_trending))), part = "header") %>%
    bg(j = c(1:(length(vol_trending))), bg = "#212070", part = "header") %>%
    bg(j = c((length(vol_trending)-2):(length(vol_trending))), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:length(vol_trending)), color = "white", part = "header")
  
  return(tbl_output)
  
}

```

```{r Monthly Volume Graph Key Takeaways, echo = FALSE, warning = FALSE, message = FALSE}

dept_monthly_vol_takeaway <- function(department){
  
  ytd_vol_var <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  ytd_vol <- as.character(prettyNum(ytd_vol_var[[2]], big.mark = ','))
  var_last_yr <- as.character(ifelse(ytd_vol_var[[3]] > 0, paste0("+",ytd_vol_var[[3]]), as.character(ytd_vol_var[[3]])))
  
  # MSHS Overall
  mshs_ytd_vol_var <- monthly_vol %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  mshs_ytd_vol <- as.character(prettyNum(mshs_ytd_vol_var[[2]], big.mark = ','))
  mshs_var_last_yr <- as.character(ifelse(mshs_ytd_vol_var[[3]] > 0, paste0("+",mshs_ytd_vol_var[[3]]), as.character(mshs_ytd_vol_var[[3]])))
  
  # Median % Change across all departments
  dept_ytd_vol_var <- monthly_vol %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year, Campus.Specialty.Group) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[3]]/.[[2]])-1,1))
  
 
  dept_var_last_yr <- as.character(ifelse(median(dept_ytd_vol_var[[4]]) > 0, 
                                          paste0("+",median(dept_ytd_vol_var[[4]])), as.character(median(dept_ytd_vol_var[[4]]))))
  
  avg_monthly <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Month) %>%
    summarise(total = sum(monthly_vol)) 
  
  avg_month <- as.character(prettyNum(round(mean(avg_monthly$total)), big.mark = ','))
  
  visit_method_vol <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    filter(Visit.Method != "Total") %>%
    group_by(Campus.Specialty.Group, Visit.Method) %>%
    summarise(total = sum(monthly_vol)) %>%
    ungroup() %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(perc = percent(total/sum(total),0))
  
  in_person <- as.character(visit_method_vol$perc[which(visit_method_vol$Visit.Method == "IN PERSON")])
  
  site_vol <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Year, Site) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    group_by(Campus.Specialty.Group, Appt.Year) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0)) %>%
    filter(perc == max(perc))
  
  max_vol <- as.character(prettyNum(site_vol$monthly_vol, big.mark = ','))
  max_vol_perc <- as.character(site_vol$perc, big.mark = ',')
  max_site <- as.character(site_vol$Site)
  
  key_list <- list(in_person, ytd_vol, avg_month, var_last_yr, max_site, max_vol, max_vol_perc, 
                  mshs_var_last_yr, dept_var_last_yr)
  
  return(key_list)
}


dept_monthly_vol_takeaway_sub <- function(department, subspecialty){

 # department <- i
 # subspecialty <- j
 ytd_vol_var <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total)
 
 nms <- c("2022", "2023")
 Missing <- setdiff(nms, names(ytd_vol_var))  # Find names of missing columns
 ytd_vol_var[Missing] <- 0                    # Add them, filled with '0's
 ytd_vol_var <- ytd_vol_var[nms]
 
 
 ytd_vol_var <- ytd_vol_var %>%
   mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  ytd_vol <- as.character(prettyNum(ytd_vol_var[[2]], big.mark = ','))
  var_last_yr <- as.character(ifelse(ytd_vol_var[[3]] > 0, paste0("+",ytd_vol_var[[3]]), as.character(ytd_vol_var[[3]])))
  
  # MSHS Overall
  mshs_ytd_vol_var <- monthly_vol %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  mshs_ytd_vol <- as.character(prettyNum(mshs_ytd_vol_var[[2]], big.mark = ','))
  mshs_var_last_yr <- as.character(ifelse(mshs_ytd_vol_var[[3]] > 0, paste0("+",mshs_ytd_vol_var[[3]]), as.character(mshs_ytd_vol_var[[3]])))
  
  # Median % Change across all departments
  dept_ytd_vol_var <- monthly_vol %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year, Campus.Specialty.Group) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[3]]/.[[2]])-1,1))
  
 
  dept_var_last_yr <- as.character(ifelse(median(dept_ytd_vol_var[[4]]) > 0, 
                                          paste0("+",median(dept_ytd_vol_var[[4]])), as.character(median(dept_ytd_vol_var[[4]]))))
  
  avg_monthly <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Month) %>%
    summarise(total = sum(monthly_vol)) 
  
  avg_month <- as.character(prettyNum(round(mean(avg_monthly$total)), big.mark = ','))
  
  visit_method_vol <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    filter(Visit.Method != "Total") %>%
    group_by(Campus.Specialty.Group, Visit.Method) %>%
    summarise(total = sum(monthly_vol)) %>%
    ungroup() %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(perc = percent(total/sum(total),0))
  
  in_person <- as.character(visit_method_vol$perc[which(visit_method_vol$Visit.Method == "IN PERSON")])
  
  site_vol <- monthly_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Year, Site) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    group_by(Campus.Specialty.Group, Appt.Year) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0)) %>%
    filter(perc == max(perc))
  
  max_vol <- as.character(prettyNum(site_vol$monthly_vol, big.mark = ','))
  max_vol_perc <- as.character(site_vol$perc, big.mark = ',')
  max_site <- as.character(site_vol$Site)
  
  key_list <- list(in_person, ytd_vol, avg_month, var_last_yr, max_site, max_vol, max_vol_perc, 
                  mshs_var_last_yr, dept_var_last_yr)
  
  return(key_list)
}

```

```{r Monthly Volume Graph Key Takeaways (Office Visits), echo = FALSE, warning = FALSE, message = FALSE}

dept_monthly_vol_office_takeaway <- function(department){
  
  ytd_vol_var <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  ytd_vol <- as.character(prettyNum(ytd_vol_var[[2]], big.mark = ','))
  var_last_yr <- as.character(ifelse(ytd_vol_var[[3]] > 0, paste0("+",ytd_vol_var[[3]]), as.character(ytd_vol_var[[3]])))
  
  # MSHS Overall
  mshs_ytd_vol_var <- monthly_vol_office %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  mshs_ytd_vol <- as.character(prettyNum(mshs_ytd_vol_var[[2]], big.mark = ','))
  mshs_var_last_yr <- as.character(ifelse(mshs_ytd_vol_var[[3]] > 0, paste0("+",mshs_ytd_vol_var[[3]]), as.character(mshs_ytd_vol_var[[3]])))
  
  # Median % Change across all departments
  dept_ytd_vol_var <- monthly_vol_office %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year, Campus.Specialty.Group) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[3]]/.[[2]])-1,1))
  
 
  dept_var_last_yr <- as.character(ifelse(median(dept_ytd_vol_var[[4]]) > 0, 
                                          paste0("+",median(dept_ytd_vol_var[[4]])), as.character(median(dept_ytd_vol_var[[4]]))))
  
  avg_monthly <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Month) %>%
    summarise(total = sum(monthly_vol)) 
  
  avg_month <- as.character(prettyNum(round(mean(avg_monthly$total)), big.mark = ','))
  
  visit_method_vol <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    filter(Visit.Method != "Total") %>%
    group_by(Campus.Specialty.Group, Visit.Method) %>%
    summarise(total = sum(monthly_vol)) %>%
    ungroup() %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(perc = percent(total/sum(total),0))
  
  in_person <- as.character(visit_method_vol$perc[which(visit_method_vol$Visit.Method == "IN PERSON")])
  
  site_vol <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Year, Site) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    group_by(Campus.Specialty.Group, Appt.Year) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0)) %>%
    filter(perc == max(perc))
  
  max_vol <- as.character(prettyNum(site_vol$monthly_vol, big.mark = ','))
  max_vol_perc <- as.character(site_vol$perc, big.mark = ',')
  max_site <- as.character(site_vol$Site)
  
  key_list <- list(in_person, ytd_vol, avg_month, var_last_yr, max_site, max_vol, max_vol_perc, 
                  mshs_var_last_yr, dept_var_last_yr)
  
  return(key_list)
}


dept_monthly_vol_office_takeaway_sub <- function(department, subspecialty){

 # department <- i
 # subspecialty <- j
 ytd_vol_var <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total)
 
 nms <- c("2022", "2023")
 Missing <- setdiff(nms, names(ytd_vol_var))  # Find names of missing columns
 ytd_vol_var[Missing] <- 0                    # Add them, filled with '0's
 ytd_vol_var <- ytd_vol_var[nms]
 
 
 ytd_vol_var <- ytd_vol_var %>%
   mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  ytd_vol <- as.character(prettyNum(ytd_vol_var[[2]], big.mark = ','))
  var_last_yr <- as.character(ifelse(ytd_vol_var[[3]] > 0, paste0("+",ytd_vol_var[[3]]), as.character(ytd_vol_var[[3]])))
  
  # MSHS Overall
  mshs_ytd_vol_var <- monthly_vol_office %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[2]]/.[[1]])-1,1))
  
  mshs_ytd_vol <- as.character(prettyNum(mshs_ytd_vol_var[[2]], big.mark = ','))
  mshs_var_last_yr <- as.character(ifelse(mshs_ytd_vol_var[[3]] > 0, paste0("+",mshs_ytd_vol_var[[3]]), as.character(mshs_ytd_vol_var[[3]])))
  
  # Median % Change across all departments
  dept_ytd_vol_var <- monthly_vol_office %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    group_by(Appt.Year, Campus.Specialty.Group) %>%
    summarise(total = sum(monthly_vol)) %>%
    pivot_wider(names_from = Appt.Year,
                values_from = total) %>%
    mutate(var_last_yr = percent((.[[3]]/.[[2]])-1,1))
  
 
  dept_var_last_yr <- as.character(ifelse(median(dept_ytd_vol_var[[4]]) > 0, 
                                          paste0("+",median(dept_ytd_vol_var[[4]])), as.character(median(dept_ytd_vol_var[[4]]))))
  
  avg_monthly <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Month) %>%
    summarise(total = sum(monthly_vol)) 
  
  avg_month <- as.character(prettyNum(round(mean(avg_monthly$total)), big.mark = ','))
  
  visit_method_vol <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    filter(Visit.Method != "Total") %>%
    group_by(Campus.Specialty.Group, Visit.Method) %>%
    summarise(total = sum(monthly_vol)) %>%
    ungroup() %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(perc = percent(total/sum(total),0))
  
  in_person <- as.character(visit_method_vol$perc[which(visit_method_vol$Visit.Method == "IN PERSON")])
  
  site_vol <- monthly_vol_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Visit.Method == "Total") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Appt.Year, Site) %>%
    summarise(monthly_vol = sum(monthly_vol)) %>%
    group_by(Campus.Specialty.Group, Appt.Year) %>%
    mutate(perc = percent(monthly_vol/sum(monthly_vol),0)) %>%
    filter(perc == max(perc))
  
  max_vol <- as.character(prettyNum(site_vol$monthly_vol, big.mark = ','))
  max_vol_perc <- as.character(site_vol$perc, big.mark = ',')
  max_site <- as.character(site_vol$Site)
  
  key_list <- list(in_person, ytd_vol, avg_month, var_last_yr, max_site, max_vol, max_vol_perc, 
                  mshs_var_last_yr, dept_var_last_yr)

  return(key_list)
}

```

```{r Monthly Volume Heat Map Graph Output, echo = FALSE, warning = FALSE, message = FALSE}

dept_heat_map_function <- function(department){
  # department <- "Otolaryngology"
  # department <- i
  dept_vol_zip_code <- vol_zip_code %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, dept_zip_code, lat, lng) %>%
    summarise(total_vol = sum(total_vol))
  
  # Create a color palette with handmade bins.
      mybins <- round(seq(0 , round_any(max(dept_vol_zip_code$total_vol), as.numeric(str_count(max(dept_vol_zip_code$total_vol))), f = ceiling) , length.out=5),0)
      mypalette <- colorBin(palette=MountSinai_palettes$pinkBlue, domain=quakes$mag, na.color="transparent", bins=mybins)
      
      # Prepare the text for the tooltip:
      mytext <- paste(
        "Total Visit Volume: ", dept_vol_zip_code$total_vol, "<br/>") %>%
        lapply(htmltools::HTML)
      
      icons <- awesomeIcons(
      icon = 'hospital-o',
      lib = 'fa',
      iconColor = "white",
      markerColor = "lightgray")
      
      map <-
        leaflet(data = dept_vol_zip_code) %>%
        addProviderTiles("CartoDB.Positron", options = providerTileOptions(noWrap = TRUE)) %>%
        setView(lng=-73.99181, lat=40.76719, zoom = 12) %>%
        addCircleMarkers(lng = ~lng, lat = ~lat, 
                         fillColor = ~mypalette(total_vol), fillOpacity = 0.9, color="white", stroke=FALSE,
                         # color = ~groupColors(SITE),
                         # group = ~SITE, 
                         radius= 21,
                         # label = mytext,
                         # labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "18px", direction = "auto")
                         ) %>%
        addLabelOnlyMarkers(~lng, ~lat, label =  ~prettyNum(total_vol, big.mark = ','), 
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, textsize = "22px",
                                                  style = list("font-weight" = "bold", padding = "3px 8px"))) %>%
        leaflet::addLegend(pal=mypalette, values=~total_vol, opacity=0.9, title = "Total Visit Volume", position = "topright")
      
      
      map <- map %>%
      addAwesomeMarkers(
        lng=-73.943324, lat=40.79171,
        # label='MSH',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.92606, lat=40.77084,
        # label='MSQ',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.98840, lat=40.73139,
        # label='MSUS',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.99181, lat=40.76719,
        # label='MSW',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.96316, lat=40.79834,
        # label="MSM",
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold')))
       
      
      # Save as a png
      saveWidget(map, "vol_heat_map.html", selfcontained = FALSE)
      webshot("vol_heat_map.html", file = "vol_heat_map.png", cliprect = "viewport")
               # c(0, 200, 1000, 1400)
      
      # vol_heat_map_graph <- readPNG("vol_heat_map.png")
      # 
      # return(vol_heat_map_graph)
}


dept_heat_map_function_sub <- function(department, subspecialty){

  # department <- i
  dept_vol_zip_code <- vol_zip_code %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    # mutate(Appt.Year = format(Appt.YearQtr, "%Y")) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, dept_zip_code, lat, lng) %>%
    summarise(total_vol = sum(total_vol))

  # Create a color palette with handmade bins.
      mybins <- unique(round(seq(0 , round_any(max(dept_vol_zip_code$total_vol), as.numeric(str_count(max(dept_vol_zip_code$total_vol))), f = ceiling) , length.out=5),0))
      mypalette <- colorBin(palette=MountSinai_palettes$pinkBlue, domain=quakes$mag, na.color="transparent", bins=mybins)

      # Prepare the text for the tooltip:
      mytext <- paste(
        "Total Visit Volume: ", dept_vol_zip_code$total_vol, "<br/>") %>%
        lapply(htmltools::HTML)

      icons <- awesomeIcons(
      icon = 'hospital-o',
      lib = 'fa',
      iconColor = "white",
      markerColor = "lightgray")

      map <-
        leaflet(data = dept_vol_zip_code) %>%
        addProviderTiles("CartoDB.Positron", options = providerTileOptions(noWrap = TRUE)) %>%
        setView(lng=-73.99181, lat=40.76719, zoom = 12) %>%
        addCircleMarkers(lng = ~lng, lat = ~lat,
                         fillColor = ~mypalette(total_vol), fillOpacity = 0.9, color="white", stroke=FALSE,
                         # color = ~groupColors(SITE),
                         # group = ~SITE,
                         radius= 21,
                         # label = mytext,
                         # labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "18px", direction = "auto")
                         ) %>%
        addLabelOnlyMarkers(~lng, ~lat, label =  ~prettyNum(total_vol, big.mark = ','),
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, textsize = "22px",
                                                  style = list("font-weight" = "bold", padding = "3px 8px"))) %>%
        leaflet::addLegend(pal=mypalette, values=~total_vol, opacity=0.9, title = "Total Visit Volume", position = "topright")


      map <- map %>%
      addAwesomeMarkers(
        lng=-73.943324, lat=40.79171,
        # label='MSH',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.92606, lat=40.77084,
        # label='MSQ',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.98840, lat=40.73139,
        # label='MSUS',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.99181, lat=40.76719,
        # label='MSW',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.96316, lat=40.79834,
        # label="MSM",
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold')))


      # Save as a png
      saveWidget(map, "vol_heat_map.html", selfcontained = FALSE)
      webshot("vol_heat_map.html", file = "vol_heat_map.png", cliprect = "viewport")
               # c(0, 200, 1000, 1400)

      # vol_heat_map_graph <- readPNG("vol_heat_map.png")
      #
      # return(vol_heat_map_graph)
}

```

```{r Monthly Volume Heat Map Graph Output (Office Visits), echo = FALSE, warning = FALSE, message = FALSE}

dept_heat_map_office_function <- function(department){
  # department <- "Cardiovascular Institute/Cardiology"
  # department <- i
  dept_vol_zip_code <- vol_zip_code_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    # mutate(Appt.Year = format(Appt.YearQtr, "%Y")) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, dept_zip_code, lat, lng) %>%
    summarise(total_vol = sum(total_vol))
  
  # Create a color palette with handmade bins.
      mybins <- round(seq(0 , round_any(max(dept_vol_zip_code$total_vol), as.numeric(str_count(max(dept_vol_zip_code$total_vol))), f = ceiling) , length.out=5),0)
      mypalette <- colorBin(palette=MountSinai_palettes$pinkBlue, domain=quakes$mag, na.color="transparent", bins=mybins)
      
      # Prepare the text for the tooltip:
      mytext <- paste(
        "Total Visit Volume: ", dept_vol_zip_code$total_vol, "<br/>") %>%
        lapply(htmltools::HTML)
      
      icons <- awesomeIcons(
      icon = 'hospital-o',
      lib = 'fa',
      iconColor = "white",
      markerColor = "lightgray")
      
      map <-
        leaflet(data = dept_vol_zip_code) %>%
        addProviderTiles("CartoDB.Positron", options = providerTileOptions(noWrap = TRUE)) %>%
        setView(lng=-73.99181, lat=40.76719, zoom = 12) %>%
        addCircleMarkers(lng = ~lng, lat = ~lat, 
                         fillColor = ~mypalette(total_vol), fillOpacity = 0.9, color="white", stroke=FALSE,
                         # color = ~groupColors(SITE),
                         # group = ~SITE, 
                         radius= 21,
                         # label = mytext,
                         # labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "18px", direction = "auto")
                         ) %>%
        addLabelOnlyMarkers(~lng, ~lat, label =  ~prettyNum(total_vol, big.mark = ','), 
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, textsize = "22px",
                                                  style = list("font-weight" = "bold", padding = "3px 8px"))) %>%
        leaflet::addLegend(pal=mypalette, values=~total_vol, opacity=0.9, title = "Total Visit Volume", position = "topright")
      
      
      map <- map %>%
      addAwesomeMarkers(
        lng=-73.943324, lat=40.79171,
        # label='MSH',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.92606, lat=40.77084,
        # label='MSQ',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.98840, lat=40.73139,
        # label='MSUS',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.99181, lat=40.76719,
        # label='MSW',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.96316, lat=40.79834,
        # label="MSM",
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold')))
       
      
      # Save as a png
      saveWidget(map, "vol_heat_map.html", selfcontained = FALSE)
      webshot("vol_heat_map.html", file = "vol_heat_map.png", cliprect = "viewport")
               # c(0, 200, 1000, 1400)
      
      # vol_heat_map_graph <- readPNG("vol_heat_map.png")
      # 
      # return(vol_heat_map_graph)
}


dept_heat_map_office_function_sub <- function(department, subspecialty){

  # department <- i
  dept_vol_zip_code <- vol_zip_code_office %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    # mutate(Appt.Year = format(Appt.YearQtr, "%Y")) %>%
    filter(Appt.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, dept_zip_code, lat, lng) %>%
    summarise(total_vol = sum(total_vol))

  # Create a color palette with handmade bins.
      mybins <- unique(round(seq(0 , round_any(max(dept_vol_zip_code$total_vol), as.numeric(str_count(max(dept_vol_zip_code$total_vol))), f = ceiling) , length.out=5),0))
      mypalette <- colorBin(palette=MountSinai_palettes$pinkBlue, domain=quakes$mag, na.color="transparent", bins=mybins)

      # Prepare the text for the tooltip:
      mytext <- paste(
        "Total Visit Volume: ", dept_vol_zip_code$total_vol, "<br/>") %>%
        lapply(htmltools::HTML)

      icons <- awesomeIcons(
      icon = 'hospital-o',
      lib = 'fa',
      iconColor = "white",
      markerColor = "lightgray")

      map <-
        leaflet(data = dept_vol_zip_code) %>%
        addProviderTiles("CartoDB.Positron", options = providerTileOptions(noWrap = TRUE)) %>%
        setView(lng=-73.99181, lat=40.76719, zoom = 12) %>%
        addCircleMarkers(lng = ~lng, lat = ~lat,
                         fillColor = ~mypalette(total_vol), fillOpacity = 0.9, color="white", stroke=FALSE,
                         # color = ~groupColors(SITE),
                         # group = ~SITE,
                         radius= 21,
                         # label = mytext,
                         # labelOptions = labelOptions(style = list("font-weight" = "normal", padding = "3px 8px"), textsize = "18px", direction = "auto")
                         ) %>%
        addLabelOnlyMarkers(~lng, ~lat, label =  ~prettyNum(total_vol, big.mark = ','),
                      labelOptions = labelOptions(noHide = T, direction = 'center', textOnly = T, textsize = "22px",
                                                  style = list("font-weight" = "bold", padding = "3px 8px"))) %>%
        leaflet::addLegend(pal=mypalette, values=~total_vol, opacity=0.9, title = "Total Visit Volume", position = "topright")


      map <- map %>%
      addAwesomeMarkers(
        lng=-73.943324, lat=40.79171,
        # label='MSH',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.92606, lat=40.77084,
        # label='MSQ',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.98840, lat=40.73139,
        # label='MSUS',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.99181, lat=40.76719,
        # label='MSW',
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold'))) %>%
      addAwesomeMarkers(
        lng=-73.96316, lat=40.79834,
        # label="MSM",
        label=NULL,
        icon = icons,
        labelOptions = labelOptions(noHide = T, textsize='14px', textOnly = TRUE, direction = 'right',
                                    style=list('font-weight'= 'bold')))


      # Save as a png
      saveWidget(map, "vol_heat_map.html", selfcontained = FALSE)
      webshot("vol_heat_map.html", file = "vol_heat_map.png", cliprect = "viewport")
               # c(0, 200, 1000, 1400)

      # vol_heat_map_graph <- readPNG("vol_heat_map.png")
      #
      # return(vol_heat_map_graph)
}

```

```{r Time to Appointment Distribution Table Output, echo = FALSE, warning = FALSE, message = FALSE}

overall_time_to_appt_dist_function <- function(department){
  # department <- "Urology"
  wait_time <- waitTime_dist_specialty_group_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))
  
  graph <- ggplot(wait_time, aes(x=factor(group, levels=c(">30","15-30","8-14","0-7")), y=perc, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    scale_y_continuous(limits=c(0, 1.1),
                       labels = scales::percent_format(accuracy = 1),
                       expand = c(0,0))+
    coord_flip()+
    facet_grid(Appt.Made.Year ~ Visit.Method, scales = "free_y", switch = "y")+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment Horizon",
         subtitle = department,
         x = NULL, y = "% of Total Appointments Scheduled", fill = NULL)+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= paste0(perc, " (", prettyNum(total, big.mark = ','),")")), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")
  
  return(graph)
  
}


overall_time_to_appt_dist_function_sub <- function(department, subspecialty){

  wait_time <- waitTime_dist_specialty_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))

  graph <- ggplot(wait_time, aes(x=factor(group, levels=c(">30","15-30","8-14","0-7")), y=perc, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    scale_y_continuous(limits=c(0, 1.1),
                       labels = scales::percent_format(accuracy = 1),
                       expand = c(0,0))+
    coord_flip()+
    facet_grid(Appt.Made.Year ~ Visit.Method, scales = "free_y", switch = "y")+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment Horizon",
         subtitle = paste0(department, " - ", subspecialty),
         x = NULL, y = "% of Total Appointments Scheduled", fill = NULL)+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= paste0(perc, " (", prettyNum(total, big.mark = ','),")")), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")

  return(graph)

}

```

```{r Time to Appointment Distribution Table Output (Office Visits), echo = FALSE, warning = FALSE, message = FALSE}

overall_time_to_appt_dist_office_function <- function(department){
  
  wait_time <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))
  
  graph <- ggplot(wait_time, aes(x=factor(group, levels=c(">30","15-30","8-14","0-7")), y=perc, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    scale_y_continuous(limits=c(0, 1.1),
                       labels = scales::percent_format(accuracy = 1),
                       expand = c(0,0))+
    coord_flip()+
    facet_grid(Appt.Made.Year ~ Visit.Method, scales = "free_y", switch = "y")+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment Horizon",
         subtitle = department,
         x = NULL, y = "% of Total Appointments Scheduled", fill = NULL)+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= paste0(perc, " (", prettyNum(total, big.mark = ','),")")), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")
  
  return(graph)
  
}


overall_time_to_appt_dist_office_function_sub <- function(department, subspecialty){

  wait_time <- waitTime_dist_specialty_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))

  graph <- ggplot(wait_time, aes(x=factor(group, levels=c(">30","15-30","8-14","0-7")), y=perc, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    scale_y_continuous(limits=c(0, 1.1),
                       labels = scales::percent_format(accuracy = 1),
                       expand = c(0,0))+
    coord_flip()+
    facet_grid(Appt.Made.Year ~ Visit.Method, scales = "free_y", switch = "y")+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment Horizon",
         subtitle = paste0(department, " - ", subspecialty),
         x = NULL, y = "% of Total Appointments Scheduled", fill = NULL)+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= paste0(perc, " (", prettyNum(total, big.mark = ','),")")), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")

  return(graph)

}

```

```{r Time to Appointment Table Output, echo = FALSE, warning = FALSE, message = FALSE}

site_time_to_appt_function <- function(department){
  
  wait_time <- waitTime_site_group_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = round(as.numeric(med_wait))) %>%
    pivot_wider(names_from = New.PT2,
                values_from = med_wait,
                values_fill = 0) %>%
    pivot_longer(4,
                 names_to = "New.PT2",
                 values_to = "med_wait") %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))
  
  graph <- ggplot(wait_time, aes(x=reorder(Site, med_wait), y=med_wait, group = New.PT2, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    geom_hline(yintercept = 14, linetype="dashed", color = "red", size = 1)+
    coord_flip()+
    facet_grid(. ~ Appt.Made.Year)+
    scale_y_continuous(limits=c(0, max(wait_time$med_wait)*1.1), 
                       # labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment (Median Days) by Site",
         subtitle = department,
         x = NULL, y = "Median Days", fill = "Site",
         caption = "*Target: 14 days")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
          plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
          plot.caption = element_text(size = 8, face = "bold.italic", color = "red"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= ifelse(med_wait == 0, "", med_wait)), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")
  
  return(graph)
    
}


site_time_to_appt_function_sub <- function(department, subspecialty){

  # department <- "Pediatrics"
  # subspecialty <- "Allergy"
  
  wait_time <- waitTime_site_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = as.numeric(med_wait)) %>%
    pivot_wider(names_from = New.PT2,
                values_from = med_wait,
                values_fill = 0) %>%
    ungroup() %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))
  
  nms <- c("Campus.Specialty.SubGroup", "Appt.Made.Year", "Site", "New")
  Missing <- setdiff(nms, names(wait_time))  # Find names of missing columns
  wait_time[Missing] <- 0                    # Add them, filled with '0's
  wait_time <- wait_time[nms]
    
  wait_time <- wait_time %>%
    pivot_longer(4,
                 names_to = "New.PT2",
                 values_to = "med_wait")

  graph <- ggplot(wait_time, aes(x=reorder(Site, med_wait), y=med_wait, group = New.PT2, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    geom_hline(yintercept = 14, linetype="dashed", color = "red", size = 1)+
    coord_flip()+
    facet_grid(. ~ Appt.Made.Year)+
    scale_y_continuous(limits=c(0, max(wait_time$med_wait)*1.1),
                       # labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment by Site",
         subtitle = paste0(department, " - ", subspecialty),
         x = NULL, y = "Median Days", fill = "Site",
         caption = "*Target: 14 days")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
          plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
          plot.caption = element_text(size = 8, face = "bold.italic", color = "red"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= ifelse(med_wait == 0, "", med_wait)), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")

  return(graph)

}

```

```{r Time to Appointment Table Output (Office Visits), echo = FALSE, warning = FALSE, message = FALSE}

site_time_to_appt_office_function <- function(department){
  # department <- "Urology"
  wait_time <- waitTime_site_group_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = round(as.numeric(med_wait))) %>%
    pivot_wider(names_from = New.PT2,
                values_from = med_wait,
                values_fill = 0) %>%
    pivot_longer(4,
                 names_to = "New.PT2",
                 values_to = "med_wait") %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))
  
  graph <- ggplot(wait_time, aes(x=reorder(Site, med_wait), y=med_wait, group = New.PT2, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    geom_hline(yintercept = 14, linetype="dashed", color = "red", size = 1)+
    coord_flip()+
    facet_grid(. ~ Appt.Made.Year)+
    scale_y_continuous(limits=c(0, max(wait_time$med_wait)*1.1), 
                       # labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment (Median Days) by Site",
         subtitle = department,
         x = NULL, y = "Median Days", fill = "Site",
         caption = "*Target: 14 days")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
          plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
          plot.caption = element_text(size = 8, face = "bold.italic", color = "red"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= ifelse(med_wait == 0, "", med_wait)), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")
  
  return(graph)
    
}


site_time_to_appt_office_function_sub <- function(department, subspecialty){

  wait_time <- waitTime_site_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    # filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = as.numeric(med_wait)) %>%
    pivot_wider(names_from = New.PT2,
                values_from = med_wait,
                values_fill = 0) %>%
    ungroup() %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    mutate(Appt.Made.Year = as.character(Appt.Made.Year))
  
  nms <- c("Campus.Specialty.SubGroup", "Appt.Made.Year", "Site", "New")
  Missing <- setdiff(nms, names(wait_time))  # Find names of missing columns
  wait_time[Missing] <- 0                    # Add them, filled with '0's
  wait_time <- wait_time[nms]
    
  wait_time <- wait_time %>%
    pivot_longer(4,
                 names_to = "New.PT2",
                 values_to = "med_wait")

  graph <- ggplot(wait_time, aes(x=reorder(Site, med_wait), y=med_wait, group = New.PT2, fill = Appt.Made.Year)) +
    geom_col(width = 0.8)+
    geom_hline(yintercept = 14, linetype="dashed", color = "red", size = 1)+
    coord_flip()+
    facet_grid(. ~ Appt.Made.Year)+
    scale_y_continuous(limits=c(0, max(wait_time$med_wait)*1.1),
                       # labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    scale_fill_manual(values=c("#212070","#d80b8c"))+
    labs(title = "Time to Appointment by Site",
         subtitle = paste0(department, " - ", subspecialty),
         x = NULL, y = "Median Days", fill = "Site",
         caption = "*Target: 14 days")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
          plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
          plot.caption = element_text(size = 8, face = "bold.italic", color = "red"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_text(size="8"),
            axis.text = element_text(size="8"),
            # axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label= ifelse(med_wait == 0, "", med_wait)), hjust = -.1, vjust=.5, color="black", size=3, font.face = "bold")

  return(graph)

}

```

```{r Access Graph Key Takeaways, echo = FALSE, warning = FALSE, message = FALSE}

dept_access_takeaway <- function(department){
  
  # Department
  wait_time_new <- waitTime_dist_specialty_group_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  new_pt_vol <- as.character(prettyNum(sum((wait_time_new %>% filter(New.PT2 == "New"))$total), big.mark = ','))
  new_pt_vol_perc <- as.character(percent((sum((wait_time_new %>% filter(New.PT2 == "New"))$total) / sum((wait_time_new$total))),0))
  new_inPerson_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  new_tele_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  dept_med_waitTime <- as.character(unique(as.numeric((wait_time_new %>% filter(New.PT2 == "New"))$med_wait)))
  
  
  # MSHS
  mshs_wait_time_new <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = total/sum(total))
  
  mshs_new_pt_vol_perc <- as.character(percent(mshs_wait_time_new$new_perc[which(mshs_wait_time_new$New.PT2 == "New")],0))
  

  mshs_new_pt_14days <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method, group) %>%
    summarise(total = sum(total)) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) 
    
  mshs_new_inPerson_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  
  mshs_new_tele_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  
  # Across Departments
  specialty_wait_time_new <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  specialty_new_pt_vol <- specialty_wait_time_new %>%
    group_by(Campus.Specialty.Group, New.PT2) %>%
    summarise(total = sum(total)) %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(new_perc = total/sum(total)) %>%
    filter(New.PT2 == "New")
  specialty_new_pt_vol_perc <- as.character(median(percent(specialty_new_pt_vol$new_perc,0)))
  

  specialty_new_pt_14days <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_inPerson_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  specialty_new_pt_14days <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_tele_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  
  
  key_list <- list(new_pt_vol, new_pt_vol_perc, new_inPerson_14days, new_tele_14days, dept_med_waitTime,
                   mshs_new_pt_vol_perc, mshs_new_inPerson_14days,  mshs_new_tele_14days,
                   specialty_new_pt_vol_perc, specialty_new_inPerson_14days, specialty_new_tele_14days)
  
  return(key_list)
}


dept_access_takeaway_sub <- function(department, subspecialty){
  
  # Department
  wait_time_new <- waitTime_dist_specialty_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  new_pt_vol <- as.character(prettyNum(sum((wait_time_new %>% filter(New.PT2 == "New"))$total), big.mark = ','))
  new_pt_vol_perc <- as.character(percent((sum((wait_time_new %>% filter(New.PT2 == "New"))$total) / sum((wait_time_new$total))),0))
  new_inPerson_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  new_tele_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  dept_med_waitTime <- as.character(unique(as.numeric((wait_time_new %>% filter(New.PT2 == "New"))$med_wait)))
  
  
  # MSHS
  mshs_wait_time_new <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = total/sum(total))
  
  mshs_new_pt_vol_perc <- as.character(percent(mshs_wait_time_new$new_perc[which(mshs_wait_time_new$New.PT2 == "New")],0))
  

  mshs_new_pt_14days <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method, group) %>%
    summarise(total = sum(total)) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) 
    
  mshs_new_inPerson_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  
  mshs_new_tele_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  
  # Across Departments
  specialty_wait_time_new <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  specialty_new_pt_vol <- specialty_wait_time_new %>%
    group_by(Campus.Specialty.Group, New.PT2) %>%
    summarise(total = sum(total)) %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(new_perc = total/sum(total)) %>%
    filter(New.PT2 == "New")
  specialty_new_pt_vol_perc <- as.character(median(percent(specialty_new_pt_vol$new_perc,0)))
  

  specialty_new_pt_14days <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_inPerson_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  specialty_new_pt_14days <- waitTime_dist_specialty_group_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_tele_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  
  
  key_list <- list(new_pt_vol, new_pt_vol_perc, new_inPerson_14days, new_tele_14days, dept_med_waitTime,
                   mshs_new_pt_vol_perc, mshs_new_inPerson_14days,  mshs_new_tele_14days,
                   specialty_new_pt_vol_perc, specialty_new_inPerson_14days, specialty_new_tele_14days)
  
  return(key_list)
}

```

```{r Access Graph Key Takeaways (Office Visits), echo = FALSE, warning = FALSE, message = FALSE}

dept_access_takeaway_office <- function(department){
  
   # Department
  wait_time_new <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  new_pt_vol <- as.character(prettyNum(sum((wait_time_new %>% filter(New.PT2 == "New"))$total), big.mark = ','))
  new_pt_vol_perc <- as.character(percent((sum((wait_time_new %>% filter(New.PT2 == "New"))$total) / sum((wait_time_new$total))),0))
  new_inPerson_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  new_tele_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  dept_med_waitTime <- as.character(unique(as.numeric((wait_time_new %>% filter(New.PT2 == "New"))$med_wait)))
  
  
  # MSHS
  mshs_wait_time_new <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = total/sum(total))
  
  mshs_new_pt_vol_perc <- as.character(percent(mshs_wait_time_new$new_perc[which(mshs_wait_time_new$New.PT2 == "New")],0))
  

  mshs_new_pt_14days <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method, group) %>%
    summarise(total = sum(total)) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) 
    
  mshs_new_inPerson_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  
  mshs_new_tele_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  
  # Across Departments
  specialty_wait_time_new <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  specialty_new_pt_vol <- specialty_wait_time_new %>%
    group_by(Campus.Specialty.Group, New.PT2) %>%
    summarise(total = sum(total)) %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(new_perc = total/sum(total)) %>%
    filter(New.PT2 == "New")
  specialty_new_pt_vol_perc <- as.character(median(percent(specialty_new_pt_vol$new_perc,0)))
  

  specialty_new_pt_14days <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_inPerson_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  specialty_new_pt_14days <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_tele_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  
  
  key_list <- list(new_pt_vol, new_pt_vol_perc, new_inPerson_14days, new_tele_14days, dept_med_waitTime,
                   mshs_new_pt_vol_perc, mshs_new_inPerson_14days,  mshs_new_tele_14days,
                   specialty_new_pt_vol_perc, specialty_new_inPerson_14days, specialty_new_tele_14days)
  
  return(key_list)
}


dept_access_takeaway_office_sub <- function(department, subspecialty){
  
  # Department
  wait_time_new <- waitTime_dist_specialty_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  new_pt_vol <- as.character(prettyNum(sum((wait_time_new %>% filter(New.PT2 == "New"))$total), big.mark = ','))
  new_pt_vol_perc <- as.character(percent((sum((wait_time_new %>% filter(New.PT2 == "New"))$total) / sum((wait_time_new$total))),0))
  new_inPerson_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  new_tele_14days <- as.character(sum((wait_time_new %>% filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  dept_med_waitTime <- as.character(unique(as.numeric((wait_time_new %>% filter(New.PT2 == "New"))$med_wait)))
  
  
  # MSHS
  mshs_wait_time_new <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = total/sum(total))
  
  mshs_new_pt_vol_perc <- as.character(percent(mshs_wait_time_new$new_perc[which(mshs_wait_time_new$New.PT2 == "New")],0))
  

  mshs_new_pt_14days <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method, group) %>%
    summarise(total = sum(total)) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) 
    
  mshs_new_inPerson_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")))$perc))
  
  mshs_new_tele_14days <- as.character(sum((mshs_new_pt_14days %>%
                                                  filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")))$perc))
  
  
  # Across Departments
  specialty_wait_time_new <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0))
  
  specialty_new_pt_vol <- specialty_wait_time_new %>%
    group_by(Campus.Specialty.Group, New.PT2) %>%
    summarise(total = sum(total)) %>%
    group_by(Campus.Specialty.Group) %>%
    mutate(new_perc = total/sum(total)) %>%
    filter(New.PT2 == "New")
  specialty_new_pt_vol_perc <- as.character(median(percent(specialty_new_pt_vol$new_perc,0)))
  

  specialty_new_pt_14days <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "IN PERSON" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_inPerson_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  specialty_new_pt_14days <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Appt.Made.Year == reporting_year) %>%
    group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    mutate(perc = formattable::percent(total/sum(total),0)) %>%
    filter(New.PT2 == "New" & Visit.Method == "TELEHEALTH" & group %in% c("0-7","8-14")) %>%
   group_by(Campus.Specialty.Group, New.PT2, Visit.Method) %>%
    summarise(perc = sum(perc))
  specialty_new_tele_14days <- as.character(median(specialty_new_pt_14days$perc))
  
  
  
  key_list <- list(new_pt_vol, new_pt_vol_perc, new_inPerson_14days, new_tele_14days, dept_med_waitTime,
                   mshs_new_pt_vol_perc, mshs_new_inPerson_14days,  mshs_new_tele_14days,
                   specialty_new_pt_vol_perc, specialty_new_inPerson_14days, specialty_new_tele_14days)
  
  return(key_list)
}

```

```{r Referral Volume Table Output, echo = FALSE, warning = FALSE, message = FALSE}

conversion_rate_function <- function(department){
  
  # department <- "Medicine - Liver"
  conversion_data <- monthly_referral_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Received.MonNum %in% ytd_month_list) %>%
    filter(Received.Year == reporting_year)
    
  
  conversion_rate <- conversion_data %>%
    group_by(Site, ApptStatusFinal) %>%
    summarise(total = sum(total)) %>%
    group_by(Site) %>%
    pivot_wider(names_from = ApptStatusFinal,
                values_from = total, 
                values_fill = 0) %>%
    mutate(Total = rowSums(across(where(is.numeric)))) %>%
    mutate(Closed = Total - Pending) %>%
    mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
           `Completion Rate` = round(Arrived/Total,2)*100) 
  col_order <- c("Site", "Total", "Closed", "Arrived", "No Show", "Canceled", "Scheduled", "Conversion Rate", "Completion Rate")
  col_order <- col_order[which(col_order %in% colnames(conversion_rate))]
  
  conversion_rate <- conversion_rate[,match(col_order, colnames(conversion_rate))]
  
  conversion_rate_mshs <- conversion_data %>%
    mutate(Site = "Total") %>%
    group_by(Site, ApptStatusFinal) %>%
    summarise(total = sum(total)) %>%
    group_by(Site) %>%
    pivot_wider(names_from = ApptStatusFinal,
                values_from = total, 
                values_fill = 0) %>%
    mutate(Total = rowSums(across(where(is.numeric)))) %>%
    mutate(Closed = Total - Pending) %>%
    mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
           `Completion Rate` = round(Arrived/Total,2)*100)
  col_order <- c("Site", "Total", "Closed", "Arrived", "No Show", "Canceled", "Scheduled", "Conversion Rate", "Completion Rate")
  col_order <- col_order[which(col_order %in% colnames(conversion_rate))]
  
  conversion_rate_mshs <- conversion_rate_mshs[,match(col_order, colnames(conversion_rate_mshs))]

  
  conversion_rate <- bind_rows(conversion_rate, conversion_rate_mshs)
  conversion_rate <- conversion_rate %>%
    rename(`Total Referrals Received` = Total,
           `Total Referrals Scheduled` = Closed,
           `Conversion Rate (Scheduled Appts)` = `Conversion Rate`,
           `Completion Rate (Arrived Appts)` = `Completion Rate`)
  
  # Table Output
  tbl_output <- 
    conversion_rate %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 14, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    vline(j = length(conversion_rate)-2, border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = nrow(conversion_rate)-1, border = fp_border(color="grey", width = 2), part="body") %>%
    bold(j = c(1:(length(conversion_rate))), part = "header") %>%
    bold(j = c(1,(length(conversion_rate)-1):(length(conversion_rate))), part = "all") %>%
    # surround(border.bottom = fp_border(color = "gray"), part = "all") %>%
    # surround(i = 1, border.bottom = fp_border(color = "black"), part = "header") %>%
    # surround(j = c(3:(length(overview_tbl)-1)), border.left = fp_border(color = "gray"), part = "all") %>%
    colformat_double(
     j = c((length(conversion_rate)-1):(length(conversion_rate))),
     digits = 0,
     suffix = "%") %>%
    align(j = c(2:(length(conversion_rate))), align = "center", part = "all") %>%
    bg(j = c(1:7), bg = "#212070", part = "header") %>%
    bg(j = c((length(conversion_rate)-1):(length(conversion_rate))), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:length(conversion_rate)), color = "white", part = "header") %>%
    width(j = 1, width = 1.8) %>%
    width(j = c(2:3), width = 1.5) %>%
    width(j = c((length(conversion_rate)-1):(length(conversion_rate))), width = 1.8) %>%
    width(j = c(4:(length(conversion_rate)-2)), width = 1) 
  
  return(tbl_output)
}


conversion_rate_function_sub <- function(department, subspecialty){
  
  # department <- "Medicine - Liver"
  conversion_data <- monthly_referral_vol %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Received.MonNum %in% ytd_month_list) %>%
    filter(Received.Year == reporting_year)
    
  
  conversion_rate <- conversion_data %>%
    group_by(Site, ApptStatusFinal) %>%
    summarise(total = sum(total)) %>%
    group_by(Site) %>%
    pivot_wider(names_from = ApptStatusFinal,
                values_from = total, 
                values_fill = 0)
  
  nms <- c("Site", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate))  # Find names of missing columns
  conversion_rate[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate <- conversion_rate[nms]
  
  conversion_rate <- conversion_rate %>%
    mutate(Total = rowSums(across(where(is.numeric)))) %>%
    mutate(Closed = Total - Pending) %>%
    mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
           `Completion Rate` = round(Arrived/Total,2)*100) 
  col_order <- c("Site", "Total", "Closed", "Arrived", "No Show", "Canceled", "Scheduled", "Conversion Rate", "Completion Rate")
  col_order <- col_order[which(col_order %in% colnames(conversion_rate))]
  
  conversion_rate <- conversion_rate[,match(col_order, colnames(conversion_rate))]
  
  conversion_rate_mshs <- conversion_data %>%
    mutate(Site = "Total") %>%
    group_by(Site, ApptStatusFinal) %>%
    summarise(total = sum(total)) %>%
    group_by(Site) %>%
    pivot_wider(names_from = ApptStatusFinal,
                values_from = total, 
                values_fill = 0) 
  
  nms <- c("Site", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate_mshs))  # Find names of missing columns
  conversion_rate_mshs[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate_mshs <- conversion_rate_mshs[nms]
  
  
  conversion_rate_mshs <- conversion_rate_mshs %>%
    mutate(Total = rowSums(across(where(is.numeric)))) %>%
    mutate(Closed = Total - Pending) %>%
    mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
           `Completion Rate` = round(Arrived/Total,2)*100)
  col_order <- c("Site", "Total", "Closed", "Arrived", "No Show", "Canceled", "Scheduled", "Conversion Rate", "Completion Rate")
  col_order <- col_order[which(col_order %in% colnames(conversion_rate))]
  
  conversion_rate_mshs <- conversion_rate_mshs[,match(col_order, colnames(conversion_rate_mshs))]

  
  conversion_rate <- bind_rows(conversion_rate, conversion_rate_mshs)
  conversion_rate <- conversion_rate %>%
    rename(`Total Referrals Received` = Total,
           `Total Referrals Scheduled` = Closed,
           `Conversion Rate (Scheduled Appts)` = `Conversion Rate`,
           `Completion Rate (Arrived Appts)` = `Completion Rate`)
  
  # Table Output
  tbl_output <- 
    conversion_rate %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 14, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    vline(j = length(conversion_rate)-2, border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = nrow(conversion_rate)-1, border = fp_border(color="grey", width = 2), part="body") %>%
    bold(j = c(1:(length(conversion_rate))), part = "header") %>%
    bold(j = c(1,(length(conversion_rate)-1):(length(conversion_rate))), part = "all") %>%
    # surround(border.bottom = fp_border(color = "gray"), part = "all") %>%
    # surround(i = 1, border.bottom = fp_border(color = "black"), part = "header") %>%
    # surround(j = c(3:(length(overview_tbl)-1)), border.left = fp_border(color = "gray"), part = "all") %>%
    colformat_double(
     j = c((length(conversion_rate)-1):(length(conversion_rate))),
     digits = 0,
     suffix = "%") %>%
    align(j = c(2:(length(conversion_rate))), align = "center", part = "all") %>%
    bg(j = c(1:7), bg = "#212070", part = "header") %>%
    bg(j = c((length(conversion_rate)-1):(length(conversion_rate))), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:length(conversion_rate)), color = "white", part = "header") %>%
    width(j = 1, width = 1.8) %>%
    width(j = c(2:3), width = 1.5) %>%
    width(j = c((length(conversion_rate)-1):(length(conversion_rate))), width = 1.8) %>%
    width(j = c(4:(length(conversion_rate)-2)), width = 1) 
  
  return(tbl_output)
}

```

```{r Physician Productivity Summary Output, echo = FALSE, warning = FALSE, message = FALSE}

productivity_summary_function <- function(department){

  provider_list <- unique((waitTime_prov_group_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # filter(!is.na(Campus.Specialty.Group)) %>%
    # dplyr::select(-Campus.Specialty.Group) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  productivity_summary_current_year <- productivity_tbl %>% 
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    group_by(Campus) %>%
    summarise(`Total Physicians 2023` = length(unique(Physician)),
           `Total cFTE 2023` = sum(`2023 Reported CFTE`, na.rm = T),
           `Jan-Dec 2023 wRVUs` = round(sum(`Jan-Dec 2023 wRVUs`)))
  
  
  productivity_summary_prior_year <- productivity_tbl %>% 
    # filter(`2022 Reported CFTE` >= 0.25) %>%
    group_by(Campus) %>%
    summarise(`Total Physicians 2022` = length(unique(Physician)),
           `Total cFTE 2022` = sum(`2022 Reported CFTE`, na.rm = T),
           `Jan-Dec 2022 wRVUs` = round(sum(`Jan-Dec 2022 wRVUs`))) 
  
  
  productivity_summary <- merge(productivity_summary_prior_year, productivity_summary_current_year)
  
  productivity_summary <- productivity_summary %>% 
    adorn_totals("row") %>%
    rename(Site = Campus) %>%
    mutate(`Total Physician Variance` = `Total Physicians 2023` - `Total Physicians 2022`,
           `CFTE Variance` = `Total cFTE 2023` - `Total cFTE 2022`,
           `wRVU Variance` = `Jan-Dec 2023 wRVUs` - `Jan-Dec 2022 wRVUs`)
  
  
  tbl_output <-
    productivity_summary %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 12, part = "all") %>%
    theme_vanilla() %>%
    bg(j = c(1:7), bg = "#212070", part = "header") %>%
    bg(j = c(8:10), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:10), color = "white", part = "header") %>%
    bold(j = c(1:10), part = "header") %>%
    height(height = .4, part = "body")  %>%
    align(align = "center", part = "all") %>%
    vline(j = c(1,4,7), border = fp_border(color="black", width = 0.3), part="body")
      
  return(tbl_output)
  
}


productivity_summary_function_sub <- function(department, subspecialty){

  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # filter(!is.na(Campus.Specialty.Group)) %>%
    # dplyr::select(-Campus.Specialty.Group) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  productivity_summary_current_year <- productivity_tbl %>% 
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    group_by(Campus) %>%
    summarise(`Total Physicians 2023` = length(unique(Physician)),
           `Total cFTE 2023` = sum(`2023 Reported CFTE`, na.rm = T),
           `Jan-Dec 2023 wRVUs` = round(sum(`Jan-Dec 2023 wRVUs`)))
  
  
  productivity_summary_prior_year <- productivity_tbl %>% 
    # filter(`2022 Reported CFTE` >= 0.25) %>%
    group_by(Campus) %>%
    summarise(`Total Physicians 2022` = length(unique(Physician)),
           `Total cFTE 2022` = sum(`2022 Reported CFTE`, na.rm = T),
           `Jan-Dec 2022 wRVUs` = round(sum(`Jan-Dec 2022 wRVUs`))) 
  
  
  productivity_summary <- merge(productivity_summary_prior_year, productivity_summary_current_year)
  
  productivity_summary <- productivity_summary %>% 
    adorn_totals("row") %>%
    rename(Site = Campus) %>%
    mutate(`Total Physician Variance` = `Total Physicians 2023` - `Total Physicians 2022`,
           `CFTE Variance` = `Total cFTE 2023` - `Total cFTE 2022`,
           `wRVU Variance` = `Jan-Dec 2023 wRVUs` - `Jan-Dec 2022 wRVUs`)
  
  
  tbl_output <-
    productivity_summary %>%
    flextable() %>%
    autofit() %>%
    fontsize(size = 12, part = "all") %>%
    theme_vanilla() %>%
    bg(j = c(1:7), bg = "#212070", part = "header") %>%
    bg(j = c(8:10), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:10), color = "white", part = "header") %>%
    bold(j = c(1:10), part = "header") %>%
    height(height = .4, part = "body")  %>%
    align(align = "center", part = "all") %>%
    vline(j = c(1,4,7), border = fp_border(color="black", width = 0.3), part="body")
      
  return(tbl_output)
  
}

```

```{r Physician Productivity Improvement Output, echo = FALSE, warning = FALSE, message = FALSE}

productivity_comparison_function <- function(department){
  
  provider_list <- unique((waitTime_prov_group_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    # dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
    distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # filter(!is.na(Campus.Specialty.Group)) %>%
    # dplyr::select(-Campus.Specialty.Group) %>%
    distinct()
  
  
  
  productivity_comparison <- productivity_tbl %>% 
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    mutate(productivity_group_2022 = case_when(`2022 Calculate %` < 25 ~ "P0-24",
                            `2022 Calculate %` >= 25 & `2022 Calculate %` < 50 ~ "P25-49",
                             `2022 Calculate %` >= 50 & `2022 Calculate %` < 75 ~ "P50-74",
                             `2022 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    mutate(productivity_group_2023 = case_when(`2023 Calculate %` < 25 ~ "P0-24",
                            `2023 Calculate %` >= 25 & `2023 Calculate %` < 50 ~ "P25-49",
                             `2023 Calculate %` >= 50 & `2023 Calculate %` < 75 ~ "P50-74",
                             `2023 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    group_by(productivity_group_2022, productivity_group_2023) %>%
    summarise(total = n()) %>%
    pivot_wider(names_from = productivity_group_2023,
                values_from = total,
                values_fill = 0) %>%
    rename(Productivity = productivity_group_2022)
  
  nms <- c("Productivity", "P0-24", "P25-49", "P50-74", "Above P74")
  Missing <- setdiff(nms, names(productivity_comparison))  # Find names of missing columns
  productivity_comparison[Missing] <- 0                    # Add them, filled with '0's
  productivity_comparison <- productivity_comparison[nms]
  
  missing_rows <- data.frame(Productivity = c("P0-24", "P25-49", "P50-74", "Above P74"))
  
  productivity_comparison <- left_join(missing_rows, productivity_comparison)
  productivity_comparison[is.na(productivity_comparison)] <- 0
  
  productivity_comparison <- productivity_comparison %>%
    mutate(Total = rowSums(.[2:5])) %>%
    adorn_totals("row","Total")
  
  tbl_output <-
    productivity_comparison %>%
    flextable() %>%
    fontsize(size = 12, part = "all") %>%
    autofit() %>%
    theme_vanilla() %>%
    bg(j = c(1:6), bg = "#212070", part = "header") %>%
    bold(j = c(1:6), part = "header") %>%
    bold(j = 1, part = "all") %>%
    color(j = c(1:6), color = "white", part = "header") %>%
    height(height = .4, part = "body") %>%
    add_header_row(values = c("2022 Productivity", "2023 Productivity"), colwidths = c(1,5)) %>%
    merge_h(part = "header") %>% 
    align(align = "center", part = "all") %>%
    vline(j = c(1, length(productivity_comparison)-1), border = fp_border(color="black", width = 0.3), part="body")
    
  return(tbl_output)
  
  
}


productivity_comparison_function_sub <- function(department, subspecialty){
  
  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
    distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site.x) %>%
    filter(!is.na(Campus.Specialty.SubGroup)) %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    distinct()
  
  
  
  productivity_comparison <- productivity_tbl %>% 
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    mutate(productivity_group_2022 = case_when(`2022 Calculate %` < 25 ~ "P0-24",
                            `2022 Calculate %` >= 25 & `2022 Calculate %` < 50 ~ "P25-49",
                             `2022 Calculate %` >= 50 & `2022 Calculate %` < 75 ~ "P50-74",
                             `2022 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    mutate(productivity_group_2023 = case_when(`2023 Calculate %` < 25 ~ "P0-24",
                            `2023 Calculate %` >= 25 & `2023 Calculate %` < 50 ~ "P25-49",
                             `2023 Calculate %` >= 50 & `2023 Calculate %` < 75 ~ "P50-74",
                             `2023 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    group_by(productivity_group_2022, productivity_group_2023) %>%
    summarise(total = n()) %>%
    pivot_wider(names_from = productivity_group_2023,
                values_from = total,
                values_fill = 0) %>%
    rename(Productivity = productivity_group_2022)
  
  nms <- c("Productivity", "P0-24", "P25-49", "P50-74", "Above P74")
  Missing <- setdiff(nms, names(productivity_comparison))  # Find names of missing columns
  productivity_comparison[Missing] <- 0                    # Add them, filled with '0's
  productivity_comparison <- productivity_comparison[nms]
  
  missing_rows <- data.frame(Productivity = c("P0-24", "P25-49", "P50-74", "Above P74"))
  
  productivity_comparison <- left_join(missing_rows, productivity_comparison)
  productivity_comparison[is.na(productivity_comparison)] <- 0
  
  productivity_comparison <- productivity_comparison %>%
    mutate(Total = rowSums(.[2:5])) %>%
    adorn_totals("row","Total")
  
  tbl_output <-
    productivity_comparison %>%
    flextable() %>%
    fontsize(size = 12, part = "all") %>%
    autofit() %>%
    theme_vanilla() %>%
    bg(j = c(1:6), bg = "#212070", part = "header") %>%
    bold(j = c(1:6), part = "header") %>%
    bold(j = 1, part = "all") %>%
    color(j = c(1:6), color = "white", part = "header") %>%
    height(height = .4, part = "body") %>%
    add_header_row(values = c("2022 Productivity", "2023 Productivity"), colwidths = c(1,5)) %>%
    merge_h(part = "header") %>% 
    align(align = "center", part = "all") %>%
    vline(j = c(1, length(productivity_comparison)-1), border = fp_border(color="black", width = 0.3), part="body")
    
  return(tbl_output)
  
  
}


productivity_summary_graph_function <- function(department){
  
  provider_list <- unique((waitTime_prov_group_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
    distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site.x) %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    distinct() %>%
    mutate(color = case_when((`2023 Calculate %` > 74 | `2023 Calculate %` > `2022 Calculate %`) ~ "limegreen",
                             TRUE ~ "red"))
  

  ggplot(productivity_tbl, aes(x=`2023 Calculate %`, y=`2022 Calculate %`, colour = color)) +
    geom_point(size=4)+
    scale_color_identity(guide = 'legend',
                         labels=c("Above P75 or Improvement since 2022","Below P75 and No Improvement since 2022"))+
    # scale_fill_discrete(values = c("limegreen", "red"), labels=c("high","low"))+
    # # geom_line(aes(linetype=Specialty))+
    # geom_point(size=2.5)+
    # scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
    # scale_colour_manual(name = '> P75', values = setNames(c('red','green'),c(T, F)))+
    # scale_color_MountSinai("main")+
    scale_x_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2023 Calculate %`), 20))+
    scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2022 Calculate %`), 20))+
    # scale_color_manual(values=c('#212070','#d80b8c'))+
    # scale_linetype_manual(values = c("dashed","solid"))+
    ggtitle(paste0("2022 vs. 2023 Productivity % Comparison: ",department))+
    theme_bw()+
    theme(axis.text = element_text(size=10),
          plot.title = element_text(size=14, hjust=0.5, face="bold"),
          plot.caption = element_text(size = 12, hjust = 0, face = "italic"),
          legend.position = "top",
          legend.title = element_blank(),
          legend.text = element_text(size=12),)+
    labs(caption = "Graph represents individual providers",
         x = "\n2023 % Productivity", y = "2022 % Productivity\n")

}


productivity_summary_graph_function_sub <- function(department, subspecialty){
  
  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
    distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site.x) %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    distinct() %>%
    mutate(color = case_when((`2023 Calculate %` > 74 | `2023 Calculate %` > `2022 Calculate %`) ~ "limegreen",
                             TRUE ~ "red"))
  
  
  if(nrow(productivity_tbl) <1){
    productivity_tbl[1,] <- 0
    
  }
  

  ggplot(productivity_tbl, aes(x=`2023 Calculate %`, y=`2022 Calculate %`, colour = color)) +
    geom_point(size=4)+
    scale_color_identity(guide = 'legend',
                         labels=c("Above P75 or Improvement since 2022","Below P75 and No Improvement since 2022"))+
    # scale_fill_discrete(values = c("limegreen", "red"), labels=c("high","low"))+
    # # geom_line(aes(linetype=Specialty))+
    # geom_point(size=2.5)+
    # scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
    # scale_colour_manual(name = '> P75', values = setNames(c('red','green'),c(T, F)))+
    # scale_color_MountSinai("main")+
    scale_x_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2023 Calculate %`), 20))+
    scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2022 Calculate %`), 20))+
    # scale_color_manual(values=c('#212070','#d80b8c'))+
    # scale_linetype_manual(values = c("dashed","solid"))+
    ggtitle(paste0("2022 vs. 2023 Productivity % Comparison: ",department))+
    theme_bw()+
    theme(axis.text = element_text(size=10),
          plot.title = element_text(size=14, hjust=0.5, face="bold"),
          plot.caption = element_text(size = 12, hjust = 0, face = "italic"),
          legend.position = "top",
          legend.title = element_blank(),
          legend.text = element_text(size=12),)+
    labs(caption = "Graph represents individual providers",
         x = "\n2023 % Productivity", y = "2022 % Productivity\n")

}

```

```{r Physician Productivity Improvement Output, echo = FALSE, warning = FALSE, message = FALSE}

productivity_comparison_function <- function(department){
  
  provider_list <- unique((waitTime_prov_group_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    # dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
    distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # filter(!is.na(Campus.Specialty.Group)) %>%
    # dplyr::select(-Campus.Specialty.Group) %>%
    distinct()
  
  
  
  productivity_comparison <- productivity_tbl %>% 
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    mutate(productivity_group_2022 = case_when(`2022 Calculate %` < 25 ~ "P0-24",
                            `2022 Calculate %` >= 25 & `2022 Calculate %` < 50 ~ "P25-49",
                             `2022 Calculate %` >= 50 & `2022 Calculate %` < 75 ~ "P50-74",
                             `2022 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    mutate(productivity_group_2023 = case_when(`2023 Calculate %` < 25 ~ "P0-24",
                            `2023 Calculate %` >= 25 & `2023 Calculate %` < 50 ~ "P25-49",
                             `2023 Calculate %` >= 50 & `2023 Calculate %` < 75 ~ "P50-74",
                             `2023 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    group_by(productivity_group_2022, productivity_group_2023) %>%
    summarise(total = n()) %>%
    pivot_wider(names_from = productivity_group_2023,
                values_from = total,
                values_fill = 0) %>%
    rename(Productivity = productivity_group_2022)
  
  nms <- c("Productivity", "P0-24", "P25-49", "P50-74", "Above P74")
  Missing <- setdiff(nms, names(productivity_comparison))  # Find names of missing columns
  productivity_comparison[Missing] <- 0                    # Add them, filled with '0's
  productivity_comparison <- productivity_comparison[nms]
  
  missing_rows <- data.frame(Productivity = c("P0-24", "P25-49", "P50-74", "Above P74"))
  
  productivity_comparison <- left_join(missing_rows, productivity_comparison)
  productivity_comparison[is.na(productivity_comparison)] <- 0
  
  productivity_comparison <- productivity_comparison %>%
    mutate(Total = rowSums(.[2:5])) %>%
    adorn_totals("row","Total")
  
  tbl_output <-
    productivity_comparison %>%
    flextable() %>%
    fontsize(size = 12, part = "all") %>%
    autofit() %>%
    theme_vanilla() %>%
    bg(j = c(1:6), bg = "#212070", part = "header") %>%
    bold(j = c(1:6), part = "header") %>%
    bold(j = 1, part = "all") %>%
    color(j = c(1:6), color = "white", part = "header") %>%
    height(height = .4, part = "body") %>%
    add_header_row(values = c("2022 Productivity", "2023 Productivity"), colwidths = c(1,5)) %>%
    merge_h(part = "header") %>% 
    align(align = "center", part = "all") %>%
    vline(j = c(1, length(productivity_comparison)-1), border = fp_border(color="black", width = 0.3), part="body")
    
  return(tbl_output)
  
  
}


productivity_comparison_function_sub <- function(department, subspecialty){
  
  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    # dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
    distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # filter(!is.na(Campus.Specialty.SubGroup)) %>%
    # dplyr::select(-Campus.Specialty.Group) %>%
    distinct()
  
  
  
  productivity_comparison <- productivity_tbl %>% 
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    mutate(productivity_group_2022 = case_when(`2022 Calculate %` < 25 ~ "P0-24",
                            `2022 Calculate %` >= 25 & `2022 Calculate %` < 50 ~ "P25-49",
                             `2022 Calculate %` >= 50 & `2022 Calculate %` < 75 ~ "P50-74",
                             `2022 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    mutate(productivity_group_2023 = case_when(`2023 Calculate %` < 25 ~ "P0-24",
                            `2023 Calculate %` >= 25 & `2023 Calculate %` < 50 ~ "P25-49",
                             `2023 Calculate %` >= 50 & `2023 Calculate %` < 75 ~ "P50-74",
                             `2023 Calculate %` >= 75 ~ "Above P74",
                             TRUE ~ "Pending")) %>%
    group_by(productivity_group_2022, productivity_group_2023) %>%
    summarise(total = n()) %>%
    pivot_wider(names_from = productivity_group_2023,
                values_from = total,
                values_fill = 0) %>%
    rename(Productivity = productivity_group_2022)
  
  nms <- c("Productivity", "P0-24", "P25-49", "P50-74", "Above P74")
  Missing <- setdiff(nms, names(productivity_comparison))  # Find names of missing columns
  productivity_comparison[Missing] <- 0                    # Add them, filled with '0's
  productivity_comparison <- productivity_comparison[nms]
  
  missing_rows <- data.frame(Productivity = c("P0-24", "P25-49", "P50-74", "Above P74"))
  
  productivity_comparison <- left_join(missing_rows, productivity_comparison)
  productivity_comparison[is.na(productivity_comparison)] <- 0
  
  productivity_comparison <- productivity_comparison %>%
    mutate(Total = rowSums(.[2:5])) %>%
    adorn_totals("row","Total")
  
  tbl_output <-
    productivity_comparison %>%
    flextable() %>%
    fontsize(size = 12, part = "all") %>%
    autofit() %>%
    theme_vanilla() %>%
    bg(j = c(1:6), bg = "#212070", part = "header") %>%
    bold(j = c(1:6), part = "header") %>%
    bold(j = 1, part = "all") %>%
    color(j = c(1:6), color = "white", part = "header") %>%
    height(height = .4, part = "body") %>%
    add_header_row(values = c("2022 Productivity", "2023 Productivity"), colwidths = c(1,5)) %>%
    merge_h(part = "header") %>% 
    align(align = "center", part = "all") %>%
    vline(j = c(1, length(productivity_comparison)-1), border = fp_border(color="black", width = 0.3), part="body")
    
  return(tbl_output)
  
  
}


# productivity_summary_graph_function <- function(department){
#   
#   provider_list <- unique((waitTime_prov_group_ytd %>% 
#                              filter(Campus.Specialty.Group == department) %>%
#                              filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
#   provider_list <- provider_list %>% filter(!is.na(NPI))
#   
#   
#   productivity_tbl <- productivity_raw %>%
#     filter(`2023 Reported CFTE` >= 0.25) %>%
#     filter(NPI %in% unique(provider_list$NPI)) %>%
#     # dplyr::select(-c(NPI, Quarter, Productivity, Site, med_wait)) %>%
#     distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
#     # filter(`2022 Reported CFTE` >=0.25) %>%
#     mutate(`2022 Calculate %` = `2022 Calculate %`*100,
#            `2023 Calculate %` = `2023 Calculate %`*100,
#            `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
#            `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
#            Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
#     rename(Campus = Site) %>%
#     # dplyr::select(-Campus.Specialty.Group) %>%
#     distinct() %>%
#     mutate(color = case_when((`2023 Calculate %` > 74 | `2023 Calculate %` > `2022 Calculate %`) ~ "limegreen",
#                              TRUE ~ "red"))
#   
# 
#   ggplot(productivity_tbl, aes(x=`2023 Calculate %`, y=`2022 Calculate %`, colour = color)) +
#     geom_point(size=4)+
#     scale_color_identity(guide = 'legend',
#                          labels=c("Above P75 or Improvement since 2022","Below P75 and No Improvement since 2022"))+
#     # scale_fill_discrete(values = c("limegreen", "red"), labels=c("high","low"))+
#     # # geom_line(aes(linetype=Specialty))+
#     # geom_point(size=2.5)+
#     # scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
#     # scale_colour_manual(name = '> P75', values = setNames(c('red','green'),c(T, F)))+
#     # scale_color_MountSinai("main")+
#     scale_x_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2023 Calculate %`), 20))+
#     scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2022 Calculate %`), 20))+
#     # scale_color_manual(values=c('#212070','#d80b8c'))+
#     # scale_linetype_manual(values = c("dashed","solid"))+
#     ggtitle(paste0("2022 vs. 2023 Productivity % Comparison: ",department))+
#     theme_bw()+
#     theme(axis.text = element_text(size=10),
#           plot.title = element_text(size=14, hjust=0.5, face="bold"),
#           plot.caption = element_text(size = 12, hjust = 0, face = "italic"),
#           legend.position = "top",
#           legend.title = element_blank(),
#           legend.text = element_text(size=12),)+
#     labs(caption = "Graph represents individual providers",
#          x = "\n2023 % Productivity", y = "2022 % Productivity\n")
# 
# }
# 
# 
# productivity_summary_graph_function_sub <- function(department, subspecialty){
#   
#   provider_list <- unique((waitTime_prov_ytd %>% 
#                              filter(Campus.Specialty.Group == department) %>%
#                              filter(Campus.Specialty.SubGroup == subspecialty) %>%
#                              filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
#   provider_list <- provider_list %>% filter(!is.na(NPI))
#   
#   
#   productivity_tbl <- productivity_raw %>%
#     filter(`2023 Reported CFTE` >= 0.25) %>%
#     filter(NPI %in% unique(provider_list$NPI)) %>%
#     # dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
#     distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
#     # filter(`2022 Reported CFTE` >=0.25) %>%
#     mutate(`2022 Calculate %` = `2022 Calculate %`*100,
#            `2023 Calculate %` = `2023 Calculate %`*100,
#            `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
#            `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
#            Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
#     rename(Campus = Site.x) %>%
#     # dplyr::select(-Campus.Specialty.Group) %>%
#     distinct() %>%
#     mutate(color = case_when((`2023 Calculate %` > 74 | `2023 Calculate %` > `2022 Calculate %`) ~ "limegreen",
#                              TRUE ~ "red"))
#   
#   
#   if(nrow(productivity_tbl) <1){
#     productivity_tbl[1,] <- 0
#     
#   }
#   
# 
#   ggplot(productivity_tbl, aes(x=`2023 Calculate %`, y=`2022 Calculate %`, colour = color)) +
#     geom_point(size=4)+
#     scale_color_identity(guide = 'legend',
#                          labels=c("Above P75 or Improvement since 2022","Below P75 and No Improvement since 2022"))+
#     # scale_fill_discrete(values = c("limegreen", "red"), labels=c("high","low"))+
#     # # geom_line(aes(linetype=Specialty))+
#     # geom_point(size=2.5)+
#     # scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
#     # scale_colour_manual(name = '> P75', values = setNames(c('red','green'),c(T, F)))+
#     # scale_color_MountSinai("main")+
#     scale_x_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2023 Calculate %`), 20))+
#     scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2022 Calculate %`), 20))+
#     # scale_color_manual(values=c('#212070','#d80b8c'))+
#     # scale_linetype_manual(values = c("dashed","solid"))+
#     ggtitle(paste0("2022 vs. 2023 Productivity % Comparison: ",department))+
#     theme_bw()+
#     theme(axis.text = element_text(size=10),
#           plot.title = element_text(size=14, hjust=0.5, face="bold"),
#           plot.caption = element_text(size = 12, hjust = 0, face = "italic"),
#           legend.position = "top",
#           legend.title = element_blank(),
#           legend.text = element_text(size=12),)+
#     labs(caption = "Graph represents individual providers",
#          x = "\n2023 % Productivity", y = "2022 % Productivity\n")
# 
# }

```

```{r Physician Productivity Improvement Graph Output, echo = FALSE, warning = FALSE, message = FALSE}

# productivity_summary_graph_function <- function(department){
#   
#   provider_list <- unique((waitTime_prov_group_ytd %>% 
#                              filter(Campus.Specialty.Group == department) %>%
#                              filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
#   provider_list <- provider_list %>% filter(!is.na(NPI))
#   
#   
#   productivity_tbl <- productivity_raw %>%
#     filter(`2023 Reported CFTE` >= 0.25) %>%
#     filter(NPI %in% unique(provider_list$NPI)) %>%
#     # dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
#     distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
#     # filter(`2022 Reported CFTE` >=0.25) %>%
#     mutate(`2022 Calculate %` = `2022 Calculate %`*100,
#            `2023 Calculate %` = `2023 Calculate %`*100,
#            `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
#            `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
#            Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
#     rename(Campus = Site) %>%
#     # dplyr::select(-Campus.Specialty.Group) %>%
#     distinct() %>%
#     mutate(color = case_when((`2023 Calculate %` > 74 | `2023 Calculate %` > `2022 Calculate %`) ~ "limegreen",
#                              TRUE ~ "red"))
#   
# 
#   ggplot(productivity_tbl, aes(x=`2023 Calculate %`, y=`2022 Calculate %`, colour = color)) +
#     geom_point(size=4)+
#     scale_color_identity(guide = 'legend',
#                          labels=c("Above P75 or Improvement since 2022","Below P75 and No Improvement since 2022"))+
#     # scale_fill_discrete(values = c("limegreen", "red"), labels=c("high","low"))+
#     # # geom_line(aes(linetype=Specialty))+
#     # geom_point(size=2.5)+
#     # scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
#     # scale_colour_manual(name = '> P75', values = setNames(c('red','green'),c(T, F)))+
#     # scale_color_MountSinai("main")+
#     scale_x_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2023 Calculate %`), 20))+
#     scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2022 Calculate %`), 20))+
#     # scale_color_manual(values=c('#212070','#d80b8c'))+
#     # scale_linetype_manual(values = c("dashed","solid"))+
#     ggtitle(paste0("2022 vs. 2023 Productivity % Comparison: ",department))+
#     theme_bw()+
#     theme(axis.text = element_text(size=10),
#           plot.title = element_text(size=14, hjust=0.5, face="bold"),
#           plot.caption = element_text(size = 12, hjust = 0, face = "italic"),
#           legend.position = "top",
#           legend.title = element_blank(),
#           legend.text = element_text(size=12),)+
#     labs(caption = "Graph represents individual providers",
#          x = "\n2023 % Productivity", y = "2022 % Productivity\n")
# 
# }
# 
# 
# productivity_summary_graph_function_sub <- function(department, subspecialty){
#   
#   provider_list <- unique((waitTime_prov_ytd %>% 
#                              filter(Campus.Specialty.Group == department) %>%
#                              filter(Campus.Specialty.SubGroup == subspecialty) %>%
#                              filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
#   provider_list <- provider_list %>% filter(!is.na(NPI))
#   
#   
#   productivity_tbl <- productivity_raw %>%
#     filter(`2023 Reported CFTE` >= 0.25) %>%
#     filter(NPI %in% unique(provider_list$NPI)) %>%
#     # dplyr::select(-c(NPI, Quarter, Productivity, Site.y, med_wait)) %>%
#     distinct(`Master Dept`, `CPSC Specialty`, `Physician`, .keep_all = TRUE) %>%
#     # filter(`2022 Reported CFTE` >=0.25) %>%
#     mutate(`2022 Calculate %` = `2022 Calculate %`*100,
#            `2023 Calculate %` = `2023 Calculate %`*100,
#            `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
#            `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
#            Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
#     rename(Campus = Site) %>%
#     # dplyr::select(-Campus.Specialty.Group) %>%
#     distinct() %>%
#     mutate(color = case_when((`2023 Calculate %` > 74 | `2023 Calculate %` > `2022 Calculate %`) ~ "limegreen",
#                              TRUE ~ "red"))
#   
#   
#   if(nrow(productivity_tbl) <1){
#     # productivity_tbl[1,] <- NA
#     ggplot()
#     
#   } else {
#     
#     ggplot(productivity_tbl, aes(x=`2023 Calculate %`, y=`2022 Calculate %`, colour = color)) +
#     geom_point(size=4)+
#     scale_color_identity(guide = 'legend',
#                          labels=c("Above P75 or Improvement since 2022","Below P75 and No Improvement since 2022"))+
#     # scale_fill_discrete(values = c("limegreen", "red"), labels=c("high","low"))+
#     # # geom_line(aes(linetype=Specialty))+
#     # geom_point(size=2.5)+
#     # scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
#     # scale_colour_manual(name = '> P75', values = setNames(c('red','green'),c(T, F)))+
#     # scale_color_MountSinai("main")+
#     scale_x_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2023 Calculate %`), 20))+
#     scale_y_continuous(labels = scales::percent_format(scale = 1), breaks = seq(0, max(productivity_tbl$`2022 Calculate %`), 20))+
#     # scale_color_manual(values=c('#212070','#d80b8c'))+
#     # scale_linetype_manual(values = c("dashed","solid"))+
#     ggtitle(paste0("2022 vs. 2023 Productivity % Comparison: ",department))+
#     theme_bw()+
#     theme(axis.text = element_text(size=10),
#           plot.title = element_text(size=14, hjust=0.5, face="bold"),
#           plot.caption = element_text(size = 12, hjust = 0, face = "italic"),
#           legend.position = "top",
#           legend.title = element_blank(),
#           legend.text = element_text(size=12),)+
#     labs(caption = "Graph represents individual providers",
#          x = "\n2023 % Productivity", y = "2022 % Productivity\n")
#     
#   }
#   
# }

```

```{r Physician Productivity Output, echo = FALSE, warning = FALSE, message = FALSE}

productivity_provider_50_function <- function(department){
  # department <- "Thoracic Surgery"
  provider_list <- unique((waitTime_prov_group_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.SubGroup)) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  if(nrow(productivity_tbl) <1){
    productivity_tbl[1,] <- NA
    
  }
  
    
  tbl_output_50 <-
    productivity_tbl %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` <50) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5:7),
        big.mark=",",
        digits = 0) %>%
    colformat_double(
        j = c(13:14),
        digits = 2) %>%
    colformat_double(
        j = c(12,15:17),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(9:11),
        digits = 0,
        prefix = "$") %>%
    colformat_double(
        ~ Variance >=0, ~ Variance,
        prefix = "+",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ Variance <0, ~ Variance,
        # prefix = "-",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Variance (Jan-Dec)` >=0, ~ `wRVU Variance (Jan-Dec)`,
        prefix = "+",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    theme_vanilla() %>%
    bg(j = c(1:4), bg = "#212070", part = "header") %>%
    bg(j = c(5:8), bg = "#a5a7a5", part = "header") %>%
    bg(j = c(9:12), bg = "#00aeef", part = "header") %>%
    bg(j = c(13:17), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:17), part = "header") %>%
    color(j = c(1:17), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(8,12,15:17), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `2022 Calculate %` >=75, ~ `2022 Calculate %`, color = "#00b800") %>%
    color(~ `2022 Calculate %` <75, ~ `2022 Calculate %`, color = "red") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    color(~ Variance >=0, ~ Variance, color = "#00b800") %>%
    color(~ Variance <0, ~ Variance, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(1,4), 1.3) %>%
    width(j = c(5:11), width = 0.7) %>%
    width(j = c(12:17), width = 0.6) 
    
    
  return(tbl_output_50)
 
}


productivity_provider_50_function_sub <- function(department, subspecialty){
  # department <- "OB-GYN"
  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.SubGroup)) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  if(nrow(productivity_tbl) <1){
    productivity_tbl[1,] <- NA
    
  }
  
    
  tbl_output_50 <-
    productivity_tbl %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` <50) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5:7),
        big.mark=",",
        digits = 0) %>%
    colformat_double(
        j = c(13:14),
        digits = 2) %>%
    colformat_double(
        j = c(12,15:17),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(9:11),
        digits = 0,
        prefix = "$") %>%
    colformat_double(
        ~ Variance >=0, ~ Variance,
        prefix = "+",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ Variance <0, ~ Variance,
        # prefix = "-",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Variance (Jan-Dec)` >=0, ~ `wRVU Variance (Jan-Dec)`,
        prefix = "+",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    theme_vanilla() %>%
    bg(j = c(1:4), bg = "#212070", part = "header") %>%
    bg(j = c(5:8), bg = "#a5a7a5", part = "header") %>%
    bg(j = c(9:12), bg = "#00aeef", part = "header") %>%
    bg(j = c(13:17), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:17), part = "header") %>%
    color(j = c(1:17), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(8,12,15:17), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `2022 Calculate %` >=75, ~ `2022 Calculate %`, color = "#00b800") %>%
    color(~ `2022 Calculate %` <75, ~ `2022 Calculate %`, color = "red") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    color(~ Variance >=0, ~ Variance, color = "#00b800") %>%
    color(~ Variance <0, ~ Variance, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(1,4), 1.3) %>%
    width(j = c(5:11), width = 0.7) %>%
    width(j = c(12:17), width = 0.6) 
    
    
  return(tbl_output_50)
 
}



productivity_provider_75_function <- function(department){
  
  provider_list <- unique((waitTime_prov_group_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.SubGroup)) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  if(nrow(productivity_tbl) <1){
    productivity_tbl[1,] <- NA
    
  }
  
    
  tbl_output_75 <-
    productivity_tbl %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` >=50 & `2023 Calculate %` <75) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5:7),
        big.mark=",",
        digits = 0) %>%
    colformat_double(
        j = c(13:14),
        digits = 2) %>%
    colformat_double(
        j = c(12,15:17),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(9:11),
        digits = 0,
        prefix = "$") %>%
    colformat_double(
        ~ Variance >=0, ~ Variance,
        prefix = "+",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ Variance <0, ~ Variance,
        # prefix = "-",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Variance (Jan-Dec)` >=0, ~ `wRVU Variance (Jan-Dec)`,
        prefix = "+",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    theme_vanilla() %>%
    bg(j = c(1:4), bg = "#212070", part = "header") %>%
    bg(j = c(5:8), bg = "#a5a7a5", part = "header") %>%
    bg(j = c(9:12), bg = "#00aeef", part = "header") %>%
    bg(j = c(13:17), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:17), part = "header") %>%
    color(j = c(1:17), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(8,12,15:17), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `2022 Calculate %` >=75, ~ `2022 Calculate %`, color = "#00b800") %>%
    color(~ `2022 Calculate %` <75, ~ `2022 Calculate %`, color = "red") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    color(~ Variance >=0, ~ Variance, color = "#00b800") %>%
    color(~ Variance <0, ~ Variance, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(1,4), 1.3) %>%
    width(j = c(5:11), width = 0.7) %>%
    width(j = c(12:17), width = 0.6) 
    
    
  return(tbl_output_75)
 
}

productivity_provider_75_function_sub <- function(department, subspecialty){
  
  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.SubGroup)) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  if(nrow(productivity_tbl) <1){
    productivity_tbl[1,] <- NA
    
  }
  
    
  tbl_output_75 <-
    productivity_tbl %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` >=50 & `2023 Calculate %` <75) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5:7),
        big.mark=",",
        digits = 0) %>%
    colformat_double(
        j = c(13:14),
        digits = 2) %>%
    colformat_double(
        j = c(12,15:17),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(9:11),
        digits = 0,
        prefix = "$") %>%
    colformat_double(
        ~ Variance >=0, ~ Variance,
        prefix = "+",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ Variance <0, ~ Variance,
        # prefix = "-",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Variance (Jan-Dec)` >=0, ~ `wRVU Variance (Jan-Dec)`,
        prefix = "+",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    theme_vanilla() %>%
    bg(j = c(1:4), bg = "#212070", part = "header") %>%
    bg(j = c(5:8), bg = "#a5a7a5", part = "header") %>%
    bg(j = c(9:12), bg = "#00aeef", part = "header") %>%
    bg(j = c(13:17), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:17), part = "header") %>%
    color(j = c(1:17), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(8,12,15:17), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `2022 Calculate %` >=75, ~ `2022 Calculate %`, color = "#00b800") %>%
    color(~ `2022 Calculate %` <75, ~ `2022 Calculate %`, color = "red") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    color(~ Variance >=0, ~ Variance, color = "#00b800") %>%
    color(~ Variance <0, ~ Variance, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(1,4), 1.3) %>%
    width(j = c(5:11), width = 0.7) %>%
    width(j = c(12:17), width = 0.6) 
    
    
  return(tbl_output_75)
 
}


productivity_provider_100_function <- function(department){
  # department <- i
  provider_list <- unique((waitTime_prov_group_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.SubGroup)) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  if(nrow(productivity_tbl) <1){
    productivity_tbl[1,] <- NA
    
  }
  
    
  tbl_output_100 <-
    productivity_tbl %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` >=75) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5:7),
        big.mark=",",
        digits = 0) %>%
    colformat_double(
        j = c(13:14),
        digits = 2) %>%
    colformat_double(
        j = c(12,15:17),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(9:11),
        digits = 0,
        prefix = "$") %>%
    colformat_double(
        ~ Variance >=0, ~ Variance,
        prefix = "+",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ Variance <0, ~ Variance,
        # prefix = "-",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Variance (Jan-Dec)` >=0, ~ `wRVU Variance (Jan-Dec)`,
        prefix = "+",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    theme_vanilla() %>%
    bg(j = c(1:4), bg = "#212070", part = "header") %>%
    bg(j = c(5:8), bg = "#a5a7a5", part = "header") %>%
    bg(j = c(9:12), bg = "#00aeef", part = "header") %>%
    bg(j = c(13:17), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:17), part = "header") %>%
    color(j = c(1:17), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(8,12,15:17), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `2022 Calculate %` >=75, ~ `2022 Calculate %`, color = "#00b800") %>%
    color(~ `2022 Calculate %` <75, ~ `2022 Calculate %`, color = "red") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    color(~ Variance >=0, ~ Variance, color = "#00b800") %>%
    color(~ Variance <0, ~ Variance, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(1,4), 1.3) %>%
    width(j = c(5:11), width = 0.7) %>%
    width(j = c(12:17), width = 0.6) 
    
  return(tbl_output_100)
 
}

productivity_provider_100_function_sub <- function(department, subspecialty){
  # department <- i
  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
  
  productivity_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(NPI, Quarter, Productivity)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2022 Calculate %` = `2022 Calculate %`*100,
           `2023 Calculate %` = `2023 Calculate %`*100,
           `2022 Reported CFTE` = round(as.numeric(`2022 Reported CFTE`),2),
           `2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           Variance = `2023 Calculate %`-`2022 Calculate %`) %>%
    rename(Campus = Site) %>%
    # dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.SubGroup)) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    distinct()
  
  
  if(nrow(productivity_tbl) <1){
    productivity_tbl[1,] <- NA
    
  }
  
    
  tbl_output_100 <-
    productivity_tbl %>%
    filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` >=75) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5:7),
        big.mark=",",
        digits = 0) %>%
    colformat_double(
        j = c(13:14),
        digits = 2) %>%
    colformat_double(
        j = c(12,15:17),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(9:11),
        digits = 0,
        prefix = "$") %>%
    colformat_double(
        ~ Variance >=0, ~ Variance,
        prefix = "+",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ Variance <0, ~ Variance,
        # prefix = "-",
        suffix = "%",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Variance (Jan-Dec)` >=0, ~ `wRVU Variance (Jan-Dec)`,
        prefix = "+",
        digit = 0) %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        prefix = "+",
        digits = 1,
        suffix = "%") %>%
    colformat_double(
        ~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`,
        digits = 1,
        suffix = "%") %>%
    theme_vanilla() %>%
    bg(j = c(1:4), bg = "#212070", part = "header") %>%
    bg(j = c(5:8), bg = "#a5a7a5", part = "header") %>%
    bg(j = c(9:12), bg = "#00aeef", part = "header") %>%
    bg(j = c(13:17), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:17), part = "header") %>%
    color(j = c(1:17), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(8,12,15:17), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` >=0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `wRVU Percent Increase/Decrease (Jan-Dec)` <0, ~ `wRVU Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` >=0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "#00b800") %>%
    color(~ `Collections Percent Increase/Decrease (Jan-Dec)` <0, ~ `Collections Percent Increase/Decrease (Jan-Dec)`, color = "red") %>%
    color(~ `2022 Calculate %` >=75, ~ `2022 Calculate %`, color = "#00b800") %>%
    color(~ `2022 Calculate %` <75, ~ `2022 Calculate %`, color = "red") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    color(~ Variance >=0, ~ Variance, color = "#00b800") %>%
    color(~ Variance <0, ~ Variance, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(1,4), 1.3) %>%
    width(j = c(5:11), width = 0.7) %>%
    width(j = c(12:17), width = 0.6) 
    
  return(tbl_output_100)
 
}

```

```{r Provider Access Output, echo = FALSE, warning = FALSE, message = FALSE}

access_provider_50_function <- function(department){
# 
  # department <- "Dermatology"

  provider_list <- waitTime_prov_group_office_ytd %>%
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year)
  
  productivity_wait_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(Quarter, Productivity, Site.x, med_wait)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           `2023 Calculate %` = `2023 Calculate %`*100) %>%
    dplyr::select(`Master Dept`, `CPSC Specialty`, NPI, Physician, `2023 Reported CFTE`, `Jan-Dec 2023 wRVUs`, `2023 Calculate %`) %>%
    filter(!is.na(NPI))
  
  productivity_wait_tbl <- merge(productivity_wait_tbl, provider_list[,c("NPI","Site","Campus.Specialty.Group","med_wait")], by = c("NPI"))
  productivity_wait_tbl <- productivity_wait_tbl %>%
    distinct() %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    pivot_wider(names_from = Site:Campus.Specialty.Group,
                values_from = med_wait) %>%
    dplyr::select(-c(NPI))
  
  
  
  if(nrow(productivity_wait_tbl) <= 0){
    
   productivity_wait_tbl[1,] <- NA
   productivity_wait_tbl$`Median Wait Time` <- NA
  
  } 

  

  tbl_output_50 <-
    productivity_wait_tbl %>%
    # filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` <50) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5),
        digits = 0) %>%
    colformat_double(
        j = c(6),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(7:length(productivity_wait_tbl)),
        digits = 0,
        suffix = " days") %>%
    theme_vanilla() %>%
    bg(j = c(1:3), bg = "#212070", part = "header") %>%
    bg(j = c(4:6), bg = "#00aeef", part = "header") %>%
    bg(j = c(7:length(productivity_wait_tbl)), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:length(productivity_wait_tbl)), part = "header") %>%
    color(j = c(1:length(productivity_wait_tbl)), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(7:length(productivity_wait_tbl)), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(2:3), width = 1.8) %>%
    width(j = c(7:length(productivity_wait_tbl)), width = 0.8)
    
    
  return(tbl_output_50)
  
  
 
}



access_provider_75_function <- function(department){
  
   provider_list <- waitTime_prov_group_office_ytd %>%
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year)
  
  productivity_wait_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(Quarter, Productivity, Site.x, med_wait)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           `2023 Calculate %` = `2023 Calculate %`*100) %>%
    dplyr::select(`Master Dept`, `CPSC Specialty`, NPI, Physician, `2023 Reported CFTE`, `Jan-Dec 2023 wRVUs`, `2023 Calculate %`) %>%
    filter(!is.na(NPI))
  
  productivity_wait_tbl <- merge(productivity_wait_tbl, provider_list[,c("NPI","Site","Campus.Specialty.Group","med_wait")], by = c("NPI"))
  productivity_wait_tbl <- productivity_wait_tbl %>%
    distinct() %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    pivot_wider(names_from = Site:Campus.Specialty.Group,
                values_from = med_wait) %>%
    dplyr::select(-c(NPI))
  
  
  if(nrow(productivity_wait_tbl) <= 0){
    
   productivity_wait_tbl[1,] <- NA
   productivity_wait_tbl$`Median Wait Time` <- NA
  
  } 

  

  tbl_output_75 <-
    productivity_wait_tbl %>%
    filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` >=50 & `2023 Calculate %` <75) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5),
        digits = 0) %>%
    colformat_double(
        j = c(6),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(7:length(productivity_wait_tbl)),
        digits = 0,
        suffix = " days") %>%
    theme_vanilla() %>%
    bg(j = c(1:3), bg = "#212070", part = "header") %>%
    bg(j = c(4:6), bg = "#00aeef", part = "header") %>%
    bg(j = c(7:length(productivity_wait_tbl)), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:length(productivity_wait_tbl)), part = "header") %>%
    color(j = c(1:length(productivity_wait_tbl)), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(7:length(productivity_wait_tbl)), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(2:3), width = 1.8) %>%
    width(j = c(7:length(productivity_wait_tbl)), width = 0.8)
    
    
  return(tbl_output_75)
 
}


access_provider_100_function <- function(department){
  
  provider_list <- waitTime_prov_group_office_ytd %>%
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year)
  
  productivity_wait_tbl <- productivity_raw %>%
    filter(NPI %in% unique(provider_list$NPI)) %>%
    dplyr::select(-c(Quarter, Productivity, Site.x, med_wait)) %>%
    distinct() %>%
    # filter(`2022 Reported CFTE` >=0.25) %>%
    mutate(`2023 Reported CFTE` = round(as.numeric(`2023 Reported CFTE`),2),
           `2023 Calculate %` = `2023 Calculate %`*100) %>%
    dplyr::select(`Master Dept`, `CPSC Specialty`, NPI, Physician, `2023 Reported CFTE`, `Jan-Dec 2023 wRVUs`, `2023 Calculate %`) %>%
    filter(!is.na(NPI))
  
  productivity_wait_tbl <- merge(productivity_wait_tbl, provider_list[,c("NPI","Site","Campus.Specialty.Group","med_wait")], by = c("NPI"))
  productivity_wait_tbl <- productivity_wait_tbl %>%
    distinct() %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    pivot_wider(names_from = Site:Campus.Specialty.Group,
                values_from = med_wait) %>%
    dplyr::select(-c(NPI))
  
  
  if(nrow(productivity_wait_tbl) <= 0){
    
   productivity_wait_tbl[1,] <- NA
   productivity_wait_tbl$`Median Wait Time` <- NA
  
  } 

  

  tbl_output_100 <-
    productivity_wait_tbl %>%
    filter(`2023 Reported CFTE` >= 0.25) %>%
    filter(`2023 Calculate %` >=75) %>%
    arrange(`Master Dept`, `CPSC Specialty`, `Physician`) %>%
    flextable() %>%
    fontsize(size = 8, part = "all") %>%
    autofit() %>%
    colformat_double(
        j = c(5),
        digits = 0) %>%
    colformat_double(
        j = c(6),
        digits = 0,
        suffix = "%") %>%
    colformat_double(
        j = c(7:length(productivity_wait_tbl)),
        digits = 0,
        suffix = " days") %>%
    theme_vanilla() %>%
    bg(j = c(1:3), bg = "#212070", part = "header") %>%
    bg(j = c(4:6), bg = "#00aeef", part = "header") %>%
    bg(j = c(7:length(productivity_wait_tbl)), bg = "#d80b8c", part = "header") %>%
    bold(j = c(1:length(productivity_wait_tbl)), part = "header") %>%
    color(j = c(1:length(productivity_wait_tbl)), color = "white", part = "header") %>%
    # bg(j = c(12:13), bg = colourer, part = "body") %>%
    bold(j = c(7:length(productivity_wait_tbl)), part = "body") %>%
    # color(~ `Percent Increase/Decrease` < 0, ~ `Percent Increase/Decrease`, color = "red") %>%
    # color(~ `Percent Increase/Decrease` > 0, ~ `Percent Increase/Decrease`, color = "#00b800") %>%
    # color(~ `2021 Calculated %` < 75, ~ `2021 Calculated %`, color = "red") %>%
    # color(~ `2021 Calculated %` >= 75, ~ `2021 Calculated %`, color = "#00b800") %>%
    # color(~ `2022 Calculated %` < 75, ~ `2022 Calculated %`, color = "red") %>%
    # color(~ `2022 Calculated %` >= 75, ~ `2022 Calculated %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` >=75, ~ `2023 Calculate %`, color = "#00b800") %>%
    color(~ `2023 Calculate %` <75, ~ `2023 Calculate %`, color = "red") %>%
    height(height = .3, part = "body") %>%
    width(j = c(2:3), width = 1.8) %>%
    width(j = c(7:length(productivity_wait_tbl)), width = 0.8)
    
    
  return(tbl_output_100)
 
}

```

```{r}

# saveRDS(payer_mix_ytd, "payer_mix_ytd.rds")
# payer_mix_ytd <- readRDS("payer_mix_ytd.rds")

```

```{r Payer Mix YTD Output, echo=FALSE, message=FALSE, warning=FALSE}

dept_payer_mix_ytd <- function(department){
  # department <- "OB-GYN"
  
  payer_mix_ytd_mshs <- payer_mix_ytd %>%
    mutate(Campus.Specialty.Group = "All MSHS") %>%
    mutate(Site = "All MSHS") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    mutate(Appt.Year = ifelse(length(ytd_month_list) == 12, 
                              Appt.Year,
                              paste0(Appt.Year, " YTD"))) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year, Coverage) %>%
    summarise(payer = sum(payer)) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
    mutate(payer_perc = (payer/sum(payer))*100) %>%
    dplyr::select(-payer) %>%
    # pivot_wider(names_from = Coverage,
    #             values_from = payer_perc) %>%
    ungroup() %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    rename(Year = Appt.Year)
  
  
  payer_mix_ytd_site <- payer_mix_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    mutate(Appt.Year = ifelse(length(ytd_month_list) == 12, 
                              Appt.Year,
                              paste0(Appt.Year, " YTD"))) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year, Coverage) %>%
    summarise(payer = sum(payer)) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
    mutate(payer_perc = (payer/sum(payer))*100) %>%
    dplyr::select(-payer) %>%
    # pivot_wider(names_from = Coverage,
    #             values_from = payer_perc) %>%
    ungroup() %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    rename(Year = Appt.Year)
  
  payer_mix_ytd_site <- bind_rows(payer_mix_ytd_mshs, payer_mix_ytd_site)
  
  payer_mix_ytd_site %>%
    mutate(Year = as.character(Year)) %>%
    ggplot() + aes(Year, payer_perc, fill=Coverage) +
    geom_bar(stat="identity") +
    facet_grid(~Site) +
    theme(legend.position="bottom") +
    geom_text(aes(label=paste0(sprintf("%1.0f", payer_perc),"%")),
              position=position_stack(vjust=0.5),
              color = "white") +
    scale_fill_MountSinai("main") + 
    scale_y_continuous(limit = c(0,100))+
    ggtitle(paste0("Payer Mix by Site: ", department))+
    theme_bw()+
    theme(axis.text = element_text(size=10),
          plot.title = element_text(size=14, hjust=0.5, face="bold"),
          legend.position = "top",
          legend.title = element_blank(),
          legend.text = element_text(size=10))+
    labs(x = "", y = "")
    # geom_text(aes(label=paste0(payer_perc,"%")), color="black",
    #             size=4, fontface="bold", nudge_y = 7)
  
  # ggsave("graph.png", dpi = 100, units = "in", device='png')
  
 # tbl_output <- 
 #   flextable(payer_mix_ytd) %>%
 #   font(fontname = "Calibri", part = "all") %>%
 #   fontsize(size = 12, part = "all") %>%
 #   align(align = "center", part = "all") %>%
 #  align(j = c(1,2), align = "left", part = "all") %>%
 #   colformat_double(
 #     j = c(3:length(payer_mix_ytd)), 
 #     digits = 0,
 #     suffix = "%") %>%
 #   autofit() %>%
 #   bold(j = c(1), part = "all") %>%
 #   bold(j = c(1:length(payer_mix_ytd)), part = "header") %>%
 #   bold(j = c(3:length(payer_mix_ytd)), part = "body") %>%
 #   bg(bg = "#212070", part = "header") %>%
 #   # bg(j = c(4:5), bg = "#d80b8c", part = "header") %>%
 #   color(color = "white", part = "header") %>%
 #   vline(j = c(2), border = fp_border(width = 1, color = "#656765")) %>%
 #   width(j = c(3:length(payer_mix_ytd)), width = 1.6) %>%
 #   height(height = .3, part = "body")

 # return(tbl_output)

}


dept_payer_mix_ytd_sub <- function(department, subspecialty){
  # department <- "Pediatrics"
  # subspecialty <- "Chest"
  
  payer_mix_ytd_mshs <- payer_mix_ytd %>%
    mutate(Campus.Specialty.Group = "All MSHS") %>%
    mutate(Site = "All MSHS") %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    mutate(Appt.Year = ifelse(length(ytd_month_list) == 12, 
                              Appt.Year,
                              paste0(Appt.Year, " YTD"))) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year, Coverage) %>%
    summarise(payer = sum(payer)) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
    mutate(payer_perc = (payer/sum(payer))*100) %>%
    dplyr::select(-payer) %>%
    # pivot_wider(names_from = Coverage,
    #             values_from = payer_perc) %>%
    ungroup() %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    rename(Year = Appt.Year)
  
  # Department YTD Payer Mix
  payer_mix_ytd_site <- payer_mix_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    filter(Appt.MonNum %in% ytd_month_list) %>%
    mutate(Appt.Year = ifelse(length(ytd_month_list) == 12, 
                              Appt.Year,
                              paste0(Appt.Year, " YTD"))) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year, Coverage) %>%
    summarise(payer = sum(payer)) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
    mutate(payer_perc = round(payer/sum(payer),2)*100) %>%
    dplyr::select(-payer) %>%
    # pivot_wider(names_from = Coverage,
    #             values_from = payer_perc) %>%
    ungroup() %>%
    dplyr::select(-Campus.Specialty.Group) %>%
    rename(Year = Appt.Year)
  
  
  payer_mix_ytd_site <- bind_rows(payer_mix_ytd_mshs, payer_mix_ytd_site)
  
  
  
    payer_mix_ytd_site %>%
    mutate(Year = as.character(Year)) %>%
    ggplot() + aes(Year, payer_perc, fill=Coverage) +
    geom_bar(stat="identity") +
    facet_grid(~Site) +
    theme(legend.position="bottom") +
    geom_text(aes(label=paste0(sprintf("%1.0f", payer_perc),"%")),
              position=position_stack(vjust=0.5),
              color = "white") +
    scale_fill_MountSinai("main") + 
    scale_y_continuous(limit = c(0,100))+
    ggtitle(paste0("Payer Mix by Site: ", department, " ", subspecialty))+
    theme_bw()+
    theme(axis.text = element_text(size=10),
          plot.title = element_text(size=14, hjust=0.5, face="bold"),
          legend.position = "top",
          legend.title = element_blank(),
          legend.text = element_text(size=10))+
    labs(x = "", y = "")
    # geom_text(aes(label=paste0(payer_perc,"%")), color="black",
    #             size=4, fontface="bold", nudge_y = 7)
  
  
  # ggsave("graph.png", dpi = 100, units = "in", device='png')
  
  
  
 # tbl_output <- 
 #   flextable(payer_mix_ytd) %>%
 #   font(fontname = "Calibri", part = "all") %>%
 #   fontsize(size = 12, part = "all") %>%
 #   align(align = "center", part = "all") %>%
 #  align(j = c(1,2), align = "left", part = "all") %>%
 #   colformat_double(
 #     j = c(3:length(payer_mix_ytd)), 
 #     digits = 0,
 #     suffix = "%") %>%
 #   autofit() %>%
 #   bold(j = c(1), part = "all") %>%
 #   bold(j = c(1:length(payer_mix_ytd)), part = "header") %>%
 #   bold(j = c(3:length(payer_mix_ytd)), part = "body") %>%
 #   bg(bg = "#212070", part = "header") %>%
 #   # bg(j = c(4:5), bg = "#d80b8c", part = "header") %>%
 #   color(color = "white", part = "header") %>%
 #   vline(j = c(2), border = fp_border(width = 1, color = "#656765")) %>%
 #   width(j = c(3:length(payer_mix_ytd)), width = 1.6) %>%
 #   height(height = .3, part = "body")
 # 
 # return(tbl_output)

}

```

```{r Payer Mix Trending Output, echo=FALSE, message=FALSE, warning=FALSE}

# dept_payer_mix_trending <- function(department){
#   # department <- "Surgery"
#   
#   # Commercial and Self-Pay combined for Ortho run -----------------------------
#   payer_mix_trend <- payer_mix_quarter_site %>%
#     filter(Campus.Specialty.Group == department) %>%
#     mutate(Coverage = ifelse(Coverage %in% c("COMMERCIAL/ MANAGED CARE", "SELF-PAY"),
#                              "COMMERCIAL/ MANAGED CARE and SELF-PAY", Coverage)) %>%
#     mutate(Appt.YearQtr = as.character(Appt.YearQtr)) %>%
#     group_by(Campus.Specialty.Group, Appt.YearQtr, Coverage) %>%
#     summarise(payer = sum(payer)) %>%
#     group_by(Campus.Specialty.Group, Appt.YearQtr) %>%
#     mutate(total_vol = sum(payer),
#            payer_perc = round(payer/sum(payer),2)*100) %>%
#     filter(Coverage == "COMMERCIAL/ MANAGED CARE and SELF-PAY")
# 
#   payer_mix_trend_mshs <- payer_mix_quarter_site %>%
#     mutate(Campus.Specialty.Group = "All MSHS") %>%
#     mutate(Coverage = ifelse(Coverage %in% c("COMMERCIAL/ MANAGED CARE", "SELF-PAY"),
#                              "COMMERCIAL/ MANAGED CARE and SELF-PAY", Coverage)) %>%
#     mutate(Appt.YearQtr = as.character(Appt.YearQtr)) %>%
#     group_by(Campus.Specialty.Group, Appt.YearQtr, Coverage) %>%
#     summarise(payer = sum(payer)) %>%
#     group_by(Campus.Specialty.Group , Appt.YearQtr) %>%
#     mutate(total_vol = sum(payer),
#            payer_perc = round(payer/sum(payer),2)*100) %>%
#     filter(Coverage == "COMMERCIAL/ MANAGED CARE and SELF-PAY")
# 
#   
#   
#   payer_mix_trend_tbl <- bind_rows(payer_mix_trend, payer_mix_trend_mshs)
#   payer_mix_trend_tbl <- payer_mix_trend_tbl %>%
#     mutate(Appt.YearQtr = as.character(Appt.YearQtr)) 
# 
#   
#   ggplot(payer_mix_trend_tbl, aes(x=Appt.YearQtr, y=payer_perc, group=Campus.Specialty.Group, color=Campus.Specialty.Group)) +
#     geom_line(size=1)+
#     # geom_line(aes(linetype=Specialty))+
#     geom_point(size=2.5)+
#     scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
#     scale_color_manual(values=c('#212070','#d80b8c'))+
#     # scale_linetype_manual(values = c("dashed","solid"))+
#     # ggtitle(paste0("% of Commercial Volume: ",department," vs. ","All MSHS"))+
#     ggtitle(paste0("% of Commercial and Self-Pay Volume: ",department," vs. ","All MSHS"))+
#     theme_bw()+
#     theme(axis.text = element_text(size=10),
#           plot.title = element_text(size=14, hjust=0.5, face="bold"),
#           legend.position = "top",
#           legend.title = element_blank(),
#           legend.text = element_text(size=10))+
#     labs(x = "", y = "")+
#     geom_text(aes(label=paste0(payer_perc,"%")), color="black",
#                 size=4, fontface="bold", nudge_y = 7)
# 
# }


# dept_payer_mix_trending_sub <- function(department, subspecialty){
#   # department <- "Medicine"
#   # subspecialty <- "Rheumatology"
#   
#     # Department YTD Payer Mix for Commercial and Self-Pay
#   payer_mix_trend <- payer_mix_quarter_site %>%
#     pivot_wider(names_from = Coverage,
#                 values_from = payer,
#                 values_fill = 0) %>%
#     pivot_longer(7:11,
#                  names_to = "Coverage",
#                  values_to = "payer") %>%
#     filter(Campus.Specialty.Group == department) %>%
#     filter(Campus.Specialty.SubGroup == subspecialty) %>%
#     mutate(Appt.YearQtr = as.character(Appt.YearQtr)) %>%
#     mutate(Coverage = ifelse(Coverage %in% c("COMMERCIAL/ MANAGED CARE", "SELF-PAY"),
#                              "COMMERCIAL/ MANAGED CARE and SELF-PAY", Coverage)) %>%
#     group_by(Campus.Specialty.Group, Appt.YearQtr, Coverage) %>%
#     summarise(payer = sum(payer)) %>%
#     group_by(Campus.Specialty.Group, Appt.YearQtr) %>%
#     mutate(total_vol = sum(payer),
#            payer_perc = round(payer/sum(payer),2)*100) %>%
#     filter(Coverage == "COMMERCIAL/ MANAGED CARE and SELF-PAY")
# 
#   payer_mix_trend_mshs <- payer_mix_quarter_site %>%
#     mutate(Campus.Specialty.Group = "All MSHS") %>%
#     mutate(Appt.YearQtr = as.character(Appt.YearQtr)) %>%
#     mutate(Coverage = ifelse(Coverage %in% c("COMMERCIAL/ MANAGED CARE", "SELF-PAY"),
#                              "COMMERCIAL/ MANAGED CARE and SELF-PAY", Coverage)) %>%
#     group_by(Campus.Specialty.Group, Appt.YearQtr, Coverage) %>%
#     summarise(payer = sum(payer)) %>%
#     group_by(Campus.Specialty.Group , Appt.YearQtr) %>%
#     mutate(total_vol = sum(payer),
#            payer_perc = round(payer/sum(payer),2)*100) %>%
#     filter(Coverage == "COMMERCIAL/ MANAGED CARE and SELF-PAY")
# 
#   
#   payer_mix_trend_tbl <- bind_rows(payer_mix_trend, payer_mix_trend_mshs)
#   payer_mix_trend_tbl <- payer_mix_trend_tbl %>%
#     mutate(Appt.YearQtr = as.character(Appt.YearQtr)) 
# 
#   
#   ggplot(payer_mix_trend_tbl, aes(x=Appt.YearQtr, y=payer_perc, group=Campus.Specialty.Group, color=Campus.Specialty.Group)) +
#     geom_line(size=1)+
#     # geom_line(aes(linetype=Specialty))+
#     geom_point(size=2.5)+
#     scale_y_continuous(limit = c(0,100), labels = function(x) paste0(x, "%"))+
#     scale_color_manual(values=c('#212070','#d80b8c'))+
#     # scale_linetype_manual(values = c("dashed","solid"))+
#     ggtitle(paste0("% of Commercial and Self-Pay Volume: ",subspecialty," vs. ","All MSHS"))+
#     theme_bw()+
#     theme(axis.text = element_text(size=10),
#           plot.title = element_text(size=14, hjust=0.5, face="bold"),
#           legend.position = "top",
#           legend.title = element_blank(),
#           legend.text = element_text(size=10))+
#     labs(x = "", y = "")+
#     geom_text(aes(label=paste0(payer_perc,"%")), color="black",
#                 size=4, fontface="bold", nudge_y = 7)
# 
# }

```

```{r Open Encounters Output, echo = FALSE, warning = FALSE, message = FALSE}

dept_open_enc_function <- function(department){
  # department <- "Dermatology"
  dept_open_enc <- missing_chg_data %>%
    filter(Campus.Specialty.Group == department) %>%
    group_by(Campus.Specialty.Group, Appt.YearQtr, group) %>%
    summarise(total = sum(total)) %>%
    mutate(perc = percent(total/sum(total),0))
  
  
  ggplot(dept_open_enc, aes(x= factor(Appt.YearQtr),
                       y=total, group=group, fill=group))+
    geom_bar(position="stack",stat="identity", width=0.7)+
    facet_grid(.~Appt.YearQtr, scales = "free", space = "free_x") + 
    scale_fill_manual(values=c("#212070","#d80b8c","#00aeef","#7f7f7f","#ffc000","#7030a0","#5753d0","#5cd3ff"))+
    scale_y_continuous(limits=c(0, max((dept_open_enc %>% group_by(Appt.YearQtr) %>% summarise(total = sum(total)))$total)*1.1), 
                       labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    labs(title = "EPIC Open Encounters",
         subtitle = department,
         x = NULL, y = NULL, fill = "Site")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_blank(),
            axis.text = element_text(size="10"),
            axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label=paste0(prettyNum(total, big.mark = ','),"\n","(",perc,")")), color="white", 
                size=4, fontface="bold", position = position_stack(vjust = 0.5))+
    stat_summary(fun.y = sum, vjust = -1, aes(label=ifelse(..y.. == 0,"",prettyNum(..y.., big.mark = ',')), group = Appt.YearQtr), geom="text", color="black", 
                 size=4)+
    guides(fill = guide_legend(nrow = 1))
    
}


dept_open_enc_function_sub <- function(department, subspecialty){

  # department <- "Otolaryngology"
  # subspecialty <- "Audiology"
  
  dept_open_enc <- missing_chg_data %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup == subspecialty) %>%
    group_by(Campus.Specialty.Group, Appt.YearQtr, group) %>%
    summarise(total = sum(total)) %>%
    mutate(perc = percent(total/sum(total),0))
  
  ggplot(dept_open_enc, aes(x= factor(Appt.YearQtr),
                       y=total, group=group, fill=group))+
    geom_bar(position="stack",stat="identity", width=0.7)+
    facet_grid(.~Appt.YearQtr, scales = "free", space = "free_x") + 
    scale_fill_manual(values=c("#212070","#d80b8c","#00aeef","#7f7f7f","#ffc000","#7030a0","#5753d0","#5cd3ff"))+
    scale_y_continuous(limits=c(0, max((dept_open_enc %>% group_by(Appt.YearQtr) %>% summarise(total = sum(total)))$total)*1.1), 
                       labels = scales::number_format(accuracy = 1),
                       expand = c(0,0))+
    labs(title = "EPIC Open Encounters",
         subtitle = paste0(department, " - ", subspecialty),
         x = NULL, y = NULL, fill = "Site")+
    theme_bw()+
    theme(plot.title = element_text(hjust=0.5, face = "bold", size = 14),
            plot.subtitle = element_text(hjust=0.5, size = 12, face = "italic"),
            legend.position = "bottom",
            legend.text = element_text(size="8"),
            legend.direction = "horizontal",
            legend.title = element_blank(),
            axis.title = element_blank(),
            axis.text = element_text(size="10"),
            axis.title.x = element_blank(),
            axis.line = element_line(size = 0.3, colour = "black"))+
    geom_text(aes(label=paste0(prettyNum(total, big.mark = ','),"\n","(",perc,")")), color="white", 
                size=3, fontface="bold", position = position_stack(vjust = 0.5))+
    stat_summary(fun.y = sum, vjust = -1, aes(label=ifelse(..y.. == 0,"",prettyNum(..y.., big.mark = ',')), group = Appt.YearQtr), geom="text", color="black", 
                 size=4)+
    guides(fill = guide_legend(nrow = 1))
  
}

```

```{r Metrics Overview Output, echo = FALSE, warning = FALSE, message = FALSE}

metrics_overview_tbl <- function(department){
# department <- "Cardiovascular Institute/Cardiology"
    # Median Time to New Appointment
  waitTime_mshs_summary <- waitTime_mshs_group_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    dplyr::select(med_wait) %>%
    mutate(med_wait = as.numeric(med_wait))
  
  waitTime_site_summary <- waitTime_site_group_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = as.numeric(med_wait)) %>%
    pivot_wider(names_from = Site,
                values_from = med_wait,
                values_fill = NA) %>%
    dplyr::select(-New.PT2)
  
  waitTime_overall <- merge(waitTime_mshs_summary, waitTime_site_summary)
  waitTime_overall <- waitTime_overall %>% 
      rename(Year = Appt.Made.Year,
             Overall = med_wait) %>%
    mutate(Metric = "waitTime")
  
  # New Patients Scheduled <=14 days 
  newPTs_mshs <- waitTime_dist_specialty_group_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100)
  
  newPTs_site <- waitTime_dist_site_group_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100) %>%
    pivot_wider(names_from = Site,
                values_from = new_perc)
  
  newPTs_overall <- merge(newPTs_mshs, newPTs_site)
  newPTs_overall <- newPTs_overall %>% 
      rename(Quarter = Appt.Made.Year,
             Overall = new_perc) %>%
      mutate(Metric = "newPTs")
  
  
  # Quarterly Volume Change
  vol_var_mshs <- monthly_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Visit.Method == "Total") %>%
      # mutate(Appt.Year = format(as.Date(Appt.YearQtr), "%Y")) %>%
      group_by(Campus.Specialty.Group, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total) %>%
      mutate(var_last_yr = round((.[[3]]-.[[2]])/.[[2]]*100)) %>%
      rename(Overall = var_last_yr) %>%
      mutate(Metric ="var_last_yr") %>%
      dplyr::select(Campus.Specialty.Group, Metric, Overall)
    
    vol_var_site <- monthly_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Visit.Method == "Total") %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      # mutate(Appt.Year = format(as.Date(Appt.YearQtr), "%Y")) %>%
      group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total) %>%
      ungroup() %>%
      mutate(var_last_yr = round((.[[4]]-.[[3]])/.[[3]]*100)) %>%
      dplyr::select(Campus.Specialty.Group, Site, var_last_yr) %>%
      pivot_wider(names_from = Site,
                  values_from = var_last_yr)
    
    
    vol_var_overall <- merge(vol_var_mshs, vol_var_site)
    
    
    # Referrals Conversion Rate
    conversion_data <- monthly_referral_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Received.MonNum %in% ytd_month_list) %>%
      filter(Received.Year == reporting_year)
      
    
    conversion_rate_mshs <- conversion_data %>%
      mutate(Campus = "Overall") %>%
      group_by(Campus, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Campus) %>%
      pivot_wider(names_from = ApptStatusFinal,
                  values_from = total, 
                  values_fill = 0) %>%
      mutate(Total = rowSums(across(where(is.numeric)))) %>%
      mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
             `Completion Rate` = round(Arrived/Total,2)*100) %>%
      dplyr::select(Campus, `Conversion Rate`) %>%
      pivot_wider(names_from = Campus,
                  values_from = `Conversion Rate`)
    
    conversion_rate_site <- conversion_data %>%
      group_by(Site, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Site) %>%
     pivot_wider(names_from = ApptStatusFinal,
                 values_from = total, 
                 values_fill = 0) %>%
     mutate(Total = rowSums(across(where(is.numeric)))) %>%
     mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
            `Completion Rate` = round(Arrived/Total,2)*100) %>%
     dplyr::select(Site, `Conversion Rate`) %>%
     pivot_wider(names_from = Site,
                values_from = `Conversion Rate`) 
  
  
  conversion_rate_all <- cbind(conversion_rate_mshs, conversion_rate_site)
  
  if(nrow(conversion_rate_all) <1){
    conversion_rate_all[1,] <- NA
    
  }
  
  conversion_rate_all$Metric <- "Conversion"
    
    
  # Productivity 
  provider_list <- waitTime_prov_group_ytd %>%
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Appt.Made.Year == reporting_year)
  
    # % Physicians >=P50
    P50_mshs <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    P50_site <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p50_overall <- merge(P50_mshs, P50_site)
    p50_overall <- p50_overall %>%
      mutate(Metric = "p50")
    
    
    # % Physicians >=P75
    P75_mshs <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      # filter(Campus.Specialty.Group == department) %>%
      filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    
    # Physicians Above >=P75
    P75_site <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p75_overall <- merge(P75_mshs, P75_site)
    p75_overall <- p75_overall %>%
      mutate(Metric = "p75")
    
    
    # Open Encounters ---------------------------------------
    open_enc_mshs <- missing_chg_data %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Appt.Year == reporting_year) %>%
      group_by(group) %>%
      summarise(total = sum(total)) %>%
      mutate(perc = round(total/sum(total),2)*100) %>%
      filter(group == "Closed <=5 Days") %>%
      dplyr::select(-c(group, total)) %>%
      rename(Overall = perc)
    
    
    open_enc_site <- missing_chg_data %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Appt.Year == reporting_year) %>%
      group_by(SITE, group) %>%
      summarise(total = sum(total)) %>%
      mutate(perc = round(total/sum(total),2)*100) %>%
      filter(group == "Closed <=5 Days") %>%
      dplyr::select(-c(group, total)) %>%
      pivot_wider(names_from = SITE,
                  values_from = perc)
    
    open_enc_all <- cbind(open_enc_mshs, open_enc_site)
    open_enc_all$Metric <- "Open"
    
    
    metrics_merged <- bind_rows(waitTime_overall, newPTs_overall, vol_var_overall, open_enc_all, conversion_rate_all, p50_overall, p75_overall)
    metrics_merged <- metrics_merged %>%
      dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.Group , Quarter))
    
    # Metrics Overview Table Output ----------------------------------------------  
  overview_tbl <- data.frame(
    Metric = c("waitTime",
              "newPTs",
              "var_last_yr",
              "Open",
              "Conversion",
              "p50",
              "p75"),
    `Metric Group` = c(rep("Access & Volume",3),
                       rep("EPIC Open Encounters",1),
                       rep("Referrals", 1),
                       rep("Physician Productivity", 2)),
    `Metric Name` = c("Median Time to New Appointment",
              "% of New Patients Scheduled <=14 Days",
              "% of Volume Increase/Decrease from Prior Year",
              "% of Encounters Closed within 5 Days",
              "% of Referrals Converted to Scheduled Appointments (YTD)",
              "% of Physicians Above P50",
              "% of Physicians Above P75"),
    Benchmark = c("14 days",
                  "80%",
                  "TBD",
                  "100%",
                  "TBD",
                  "100%",
                  "100%")
  )
    
  overview_tbl <- left_join(overview_tbl, metrics_merged, by = "Metric")
  overview_tbl <- overview_tbl %>%
    dplyr::select(-c("Year")) 

  # Format table output 
  tbl_output <- 
    overview_tbl %>%
    arrange(factor(Metric.Group, levels = c("Access & Volume","Referrals","EPIC Open Encounters",
                                            "Physician Productivity",
                                            "Space"))) %>%
    dplyr::select(-Metric) %>%
    rename(Metric = Metric.Group) %>%
    flextable() %>%
    autofit() %>%
    merge_v(j = ~Metric) %>%
    merge_at(j = c(1:2), part = "header") %>%
    fontsize(size = 12, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    hline(border = fp_border(color="grey", width = 2), part="header") %>%
    hline_bottom(border = fp_border(color="grey", width = 2), part="all") %>%
    vline(j = 3, border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = c(3,4,5,7), border = fp_border(color="grey", width = 2), part="body") %>%
    fix_border_issues() %>%
    # bold(j = c(1:(length(overview_tbl)-1)), part = "header") %>%
    bold(j = 1, part = "all") %>%
    # surround(border.bottom = fp_border(color = "gray"), part = "all") %>%
    # surround(i = 1, border.bottom = fp_border(color = "black"), part = "header") %>%
    # surround(j = c(3:(length(overview_tbl)-1)), border.left = fp_border(color = "gray"), part = "all") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(2:nrow(overview_tbl)),
     digits = 0,
     suffix = "%") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(1),
     digits = 0,
     suffix = " days") %>%
    align(j = c(3:(length(overview_tbl)-1)), align = "center", part = "all") %>%
    align(j = c(1:(length(overview_tbl)-1)), align = "center", part = "header") %>%
    bg(j = c(1:3), bg = "#212070", part = "header") %>%
    bg(j = c(4:(length(overview_tbl)-1)), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:(length(overview_tbl)-1)), color = "white", part = "header") %>%
    color(j = 2, color = "#212070", part = "header") %>%
    width(j = 1, width = 1) %>%
    width(j = 2, width = 2.2) %>%
    width(j = c(4:(length(overview_tbl)-1)), width = 1.1) %>%
    height(height = 0.5, part = "body") 
    # style(i = 1 < 14, 
    #       ~ Overall + MSBI + `MSH- AMBULATORY CARE` + `MSH-MSDFP` + MSM + MSUS + MSW,
    #       pr_t = fp_text(color = "red", italic = TRUE, bold = TRUE)) %>%
    

}


metrics_overview_tbl_sub <- function(department, subspecialty){
# department <- "Medicine"
# subspecialty <- "Rheumatology"
    # Median Time to New Appointment
  waitTime_mshs_summary <- waitTime_mshs_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    dplyr::select(med_wait) %>%
    mutate(med_wait = as.numeric(med_wait))
  
  waitTime_site_summary <- waitTime_site_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = as.numeric(med_wait)) %>%
    pivot_wider(names_from = Site,
                values_from = med_wait,
                values_fill = NA) %>%
    dplyr::select(-New.PT2)
  
  waitTime_overall <- merge(waitTime_mshs_summary, waitTime_site_summary)
  waitTime_overall <- waitTime_overall %>% 
      rename(Year = Appt.Made.Year,
             Overall = med_wait) %>%
    mutate(Metric = "waitTime")
  
  # New Patients Scheduled <=14 days 
  newPTs_mshs <- waitTime_dist_specialty_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100)
  
  newPTs_site <- waitTime_dist_site_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100) %>%
    pivot_wider(names_from = Site,
                values_from = new_perc)
  
  newPTs_overall <- merge(newPTs_mshs, newPTs_site)
  newPTs_overall <- newPTs_overall %>% 
      rename(Quarter = Appt.Made.Year,
             Overall = new_perc) %>%
      mutate(Metric = "newPTs")
  
  
  # Quarterly Volume Change
  vol_var_mshs <- monthly_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Visit.Method == "Total") %>%
      group_by(Campus.Specialty.Group, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total) 
  
  nms <- c("Campus.Specialty.Group", "2022", "2023")
  Missing <- setdiff(nms, names(vol_var_mshs))  # Find names of missing columns
  vol_var_mshs[Missing] <- 0                    # Add them, filled with '0's
  vol_var_mshs <- vol_var_mshs[nms]

  vol_var_mshs <- vol_var_mshs %>%
      mutate(var_last_yr = round((.[[3]]-.[[2]])/.[[2]]*100)) %>%
      rename(Overall = var_last_yr) %>%
      mutate(Metric ="var_last_yr") %>%
      dplyr::select(Campus.Specialty.Group, Metric, Overall)
    
    vol_var_site <- monthly_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      filter(Visit.Method == "Total") %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total) %>%
      ungroup() 
    
    nms <- c("Campus.Specialty.Group", "Site",  "2022", "2023")
  Missing <- setdiff(nms, names(vol_var_site))  # Find names of missing columns
  vol_var_site[Missing] <- 0                    # Add them, filled with '0's
  vol_var_site <- vol_var_site[nms]
      
  vol_var_site <- vol_var_site %>%
  mutate(var_last_yr = round((.[[4]]-.[[3]])/.[[3]]*100)) %>%
      dplyr::select(Campus.Specialty.Group, Site, var_last_yr) %>%
      pivot_wider(names_from = Site,
                  values_from = var_last_yr)
    
    
    vol_var_overall <- merge(vol_var_mshs, vol_var_site)
    
    
    # Referrals Conversion Rate
    conversion_data <- monthly_referral_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      filter(Received.MonNum %in% ytd_month_list) %>%
    filter(Received.Year == reporting_year)
      
    
    conversion_rate_mshs <- conversion_data %>%
      mutate(Campus = "Overall") %>%
      group_by(Campus, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Campus) %>%
      pivot_wider(names_from = ApptStatusFinal,
                  values_from = total, 
                  values_fill = 0) 
    
    nms <- c("Campus", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate_mshs))  # Find names of missing columns
  conversion_rate_mshs[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate_mshs <- conversion_rate_mshs[nms]
  
  conversion_rate_mshs <- conversion_rate_mshs %>%    
  mutate(Total = rowSums(across(where(is.numeric)))) %>%
      mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
             `Completion Rate` = round(Arrived/Total,2)*100) %>%
      dplyr::select(Campus, `Conversion Rate`) %>%
      pivot_wider(names_from = Campus,
                  values_from = `Conversion Rate`)
    
    conversion_rate_site <- conversion_data %>%
      group_by(Site, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Site) %>%
     pivot_wider(names_from = ApptStatusFinal,
                 values_from = total, 
                 values_fill = 0) 
    
    nms <- c("Site", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate_site))  # Find names of missing columns
  conversion_rate_site[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate_site <- conversion_rate_site[nms]
  
  conversion_rate_site <- conversion_rate_site %>%
     mutate(Total = rowSums(across(where(is.numeric)))) %>%
     mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
            `Completion Rate` = round(Arrived/Total,2)*100) %>%
     dplyr::select(Site, `Conversion Rate`) %>%
     pivot_wider(names_from = Site,
                values_from = `Conversion Rate`) 
  
  
  conversion_rate_all <- cbind(conversion_rate_mshs, conversion_rate_site)
  conversion_rate_all$Metric <- "Conversion"
    
    
  # Productivity 
  provider_list <- unique((waitTime_prov_ytd %>% 
                             filter(Campus.Specialty.Group == department) %>%
                             filter(Campus.Specialty.SubGroup == subspecialty) %>%
                             filter(Appt.Made.Year == reporting_year))[,c("Provider","NPI")])
  provider_list <- provider_list %>% filter(!is.na(NPI))
  
    # % Physicians >=P50
    P50_mshs <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    P50_site <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p50_overall <- merge(P50_mshs, P50_site)
    p50_overall <- p50_overall %>%
      mutate(Metric = "p50")
    
    
    # % Physicians >=P75
    P75_mshs <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    
    # Physicians Above >=P75
    P75_site <- productivity_raw %>%
      filter(NPI %in% unique(provider_list$NPI)) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p75_overall <- merge(P75_mshs, P75_site)
    p75_overall <- p75_overall %>%
      mutate(Metric = "p75")
    
    
    # Open Encounters ---------------------------------------
    open_enc_mshs <- missing_chg_data %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Appt.Year == reporting_year) %>%
      group_by(group) %>%
      summarise(total = sum(total)) %>%
      mutate(perc = round(total/sum(total),2)*100) %>%
      filter(group == "Closed <=5 Days") %>%
      dplyr::select(-c(group, total)) %>%
      rename(Overall = perc)
    
    
    open_enc_site <- missing_chg_data %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Appt.Year == reporting_year) %>%
      group_by(SITE, group) %>%
      summarise(total = sum(total)) %>%
      mutate(perc = round(total/sum(total),2)*100) %>%
      filter(group == "Closed <=5 Days") %>%
      dplyr::select(-c(group, total)) %>%
      pivot_wider(names_from = SITE,
                  values_from = perc)
    
    open_enc_all <- cbind(open_enc_mshs, open_enc_site)
    open_enc_all$Metric <- "Open"
    
    
    metrics_merged <- bind_rows(waitTime_overall, newPTs_overall, vol_var_overall, open_enc_all, conversion_rate_all, p50_overall, p75_overall)
    metrics_merged <- metrics_merged %>%
      dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.Group , Quarter))
    
    # Metrics Overview Table Output ----------------------------------------------  
  overview_tbl <- data.frame(
    Metric = c("waitTime",
              "newPTs",
              "var_last_yr",
              "Open",
              "Conversion",
              "p50",
              "p75"),
    `Metric Group` = c(rep("Access & Volume",3),
                       rep("EPIC Open Encounters",1),
                       rep("Referrals", 1),
                       rep("Physician Productivity", 2)),
    `Metric Name` = c("Median Time to New Appointment",
              "% of New Patients Scheduled <=14 Days",
              "% of Volume Increase/Decrease from Prior Year",
              "% of Encounters Closed within 5 Days",
              "% of Referrals Converted to Scheduled Appointments (YTD)",
              "% of Physicians Above P50",
              "% of Physicians Above P75"),
    Benchmark = c("14 days",
                  "80%",
                  "TBD",
                  "100%",
                  "TBD",
                  "100%",
                  "100%")
  )
    
  overview_tbl <- left_join(overview_tbl, metrics_merged, by = "Metric")
  overview_tbl <- overview_tbl %>%
    dplyr::select(-c("Year")) 

  # Format table output 
  tbl_output <- 
    overview_tbl %>%
    arrange(factor(Metric.Group, levels = c("Access & Volume","Referrals","EPIC Open Encounters",
                                            "Physician Productivity",
                                            "Space"))) %>%
    dplyr::select(-Metric) %>%
    rename(Metric = Metric.Group) %>%
    flextable() %>%
    autofit() %>%
    merge_v(j = ~Metric) %>%
    merge_at(j = c(1:2), part = "header") %>%
    fontsize(size = 12, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    hline(border = fp_border(color="grey", width = 2), part="header") %>%
    hline_bottom(border = fp_border(color="grey", width = 2), part="all") %>%
    vline(j = 3, border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = c(3,4,5,7), border = fp_border(color="grey", width = 2), part="body") %>%
    fix_border_issues() %>%
    # bold(j = c(1:(length(overview_tbl)-1)), part = "header") %>%
    bold(j = 1, part = "all") %>%
    # surround(border.bottom = fp_border(color = "gray"), part = "all") %>%
    # surround(i = 1, border.bottom = fp_border(color = "black"), part = "header") %>%
    # surround(j = c(3:(length(overview_tbl)-1)), border.left = fp_border(color = "gray"), part = "all") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(2:nrow(overview_tbl)),
     digits = 0,
     suffix = "%") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(1),
     digits = 0,
     suffix = " days") %>%
    align(j = c(3:(length(overview_tbl)-1)), align = "center", part = "all") %>%
    align(j = c(1:(length(overview_tbl)-1)), align = "center", part = "header") %>%
    bg(j = c(1:3), bg = "#212070", part = "header") %>%
    bg(j = c(4:(length(overview_tbl)-1)), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:(length(overview_tbl)-1)), color = "white", part = "header") %>%
    color(j = 2, color = "#212070", part = "header") %>%
    width(j = 1, width = 1) %>%
    width(j = 2, width = 2.2) %>%
    width(j = c(4:(length(overview_tbl)-1)), width = 1.1) %>%
    height(height = 0.5, part = "body") 
    # style(i = 1 < 14, 
    #       ~ Overall + MSBI + `MSH- AMBULATORY CARE` + `MSH-MSDFP` + MSM + MSUS + MSW,
    #       pr_t = fp_text(color = "red", italic = TRUE, bold = TRUE)) %>%

}
  
```

```{r Metrics Overview Output (Office Visits) , echo = FALSE, warning = FALSE, message = FALSE}

metrics_overview_office_tbl <- function(department){
# department <- "Cardiovascular Institute/Cardiology"
    # Median Time to New Appointment
  waitTime_mshs_summary <- waitTime_mshs_group_office_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    dplyr::select(med_wait) %>%
    mutate(med_wait = as.numeric(med_wait))
  
  waitTime_site_summary <- waitTime_site_group_office_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = as.numeric(med_wait)) %>%
    pivot_wider(names_from = Site,
                values_from = med_wait,
                values_fill = NA) %>%
    dplyr::select(-New.PT2)
  
  waitTime_overall <- merge(waitTime_mshs_summary, waitTime_site_summary)
  waitTime_overall <- waitTime_overall %>% 
      rename(Year = Appt.Made.Year,
             Overall = med_wait) %>%
    mutate(Metric = "waitTime")
  
  # New Patients Scheduled <=14 days 
  newPTs_mshs <- waitTime_dist_specialty_group_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100)
  
  newPTs_site <- waitTime_dist_site_group_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100) %>%
    pivot_wider(names_from = Site,
                values_from = new_perc)
  
  newPTs_overall <- merge(newPTs_mshs, newPTs_site)
  newPTs_overall <- newPTs_overall %>% 
      rename(Quarter = Appt.Made.Year,
             Overall = new_perc) %>%
      mutate(Metric = "newPTs")
  
  
  # Quarterly Volume Change
  vol_var_mshs <- monthly_vol_office %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Visit.Method == "Total") %>%
      # mutate(Appt.Year = format(as.Date(Appt.YearQtr), "%Y")) %>%
      group_by(Campus.Specialty.Group, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total)
  
  nms <- c("Campus.Specialty.Group", "2022", "2023")
  Missing <- setdiff(nms, names(vol_var_mshs))  # Find names of missing columns
  vol_var_mshs[Missing] <- 0                    # Add them, filled with '0's
  vol_var_mshs <- vol_var_mshs[nms]
  
  vol_var_mshs <- vol_var_mshs %>%
      mutate(var_last_yr = round((.[[3]]-.[[2]])/.[[2]]*100)) %>%
      rename(Overall = var_last_yr) %>%
      mutate(Metric ="var_last_yr") %>%
      dplyr::select(Campus.Specialty.Group, Metric, Overall)
    
    vol_var_site <- monthly_vol_office %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Visit.Method == "Total") %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      # mutate(Appt.Year = format(as.Date(Appt.YearQtr), "%Y")) %>%
      group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total) %>%
      ungroup() 
    
     nms <- c("Campus.Specialty.Group", "Site",  "2022", "2023")
  Missing <- setdiff(nms, names(vol_var_site))  # Find names of missing columns
  vol_var_site[Missing] <- 0                    # Add them, filled with '0's
  vol_var_site <- vol_var_site[nms]
      
  vol_var_site <- vol_var_site %>%
      mutate(var_last_yr = round((.[[4]]-.[[3]])/.[[3]]*100)) %>%
      dplyr::select(Campus.Specialty.Group, Site, var_last_yr) %>%
      pivot_wider(names_from = Site,
                  values_from = var_last_yr)
    
    
    vol_var_overall <- merge(vol_var_mshs, vol_var_site)
    
    
    # Referrals Conversion Rate
    conversion_data <- monthly_referral_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Received.Year == reporting_year) %>%
      filter(Received.MonNum %in% ytd_month_list) 
      
    
    conversion_rate_mshs <- conversion_data %>%
      mutate(Campus = "Overall") %>%
      group_by(Campus, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Campus) %>%
      pivot_wider(names_from = ApptStatusFinal,
                  values_from = total, 
                  values_fill = 0)
    
      nms <- c("Campus", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate_mshs))  # Find names of missing columns
  conversion_rate_mshs[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate_mshs <- conversion_rate_mshs[nms]
  
  conversion_rate_mshs <- conversion_rate_mshs %>%    
      mutate(Total = rowSums(across(where(is.numeric)))) %>%
      mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
             `Completion Rate` = round(Arrived/Total,2)*100) %>%
      dplyr::select(Campus, `Conversion Rate`) %>%
      pivot_wider(names_from = Campus,
                  values_from = `Conversion Rate`)
    
    conversion_rate_site <- conversion_data %>%
      group_by(Site, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Site) %>%
     pivot_wider(names_from = ApptStatusFinal,
                 values_from = total, 
                 values_fill = 0)
    
    nms <- c("Site", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate_site))  # Find names of missing columns
  conversion_rate_site[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate_site <- conversion_rate_site[nms]
  
  conversion_rate_site <- conversion_rate_site %>%
     mutate(Total = rowSums(across(where(is.numeric)))) %>%
     mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
            `Completion Rate` = round(Arrived/Total,2)*100) %>%
     dplyr::select(Site, `Conversion Rate`) %>%
     pivot_wider(names_from = Site,
                values_from = `Conversion Rate`) 
  
  
  conversion_rate_all <- cbind(conversion_rate_mshs, conversion_rate_site)
  conversion_rate_all$Metric <- "Conversion"
    
    
    # % Physicians >=P50
    P50_mshs <- productivity_raw %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(Campus.Specialty.Group == department) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    P50_site <- productivity_raw %>%
      mutate(temp_site = ifelse(Site.x %in% c("MSW/MSM","MSM/MSW") , "MSW", Site.x)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(Campus.Specialty.Group == department) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p50_overall <- merge(P50_mshs, P50_site)
    p50_overall <- p50_overall %>%
      mutate(Metric = "p50")
    
    
    # % Physicians >=P75
    P75_mshs <- productivity_raw %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(Campus.Specialty.Group == department) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    
    # Physicians Above >=P75
    P75_site <- productivity_raw %>%
      mutate(temp_site = ifelse(Site.x %in% c("MSW/MSM","MSM/MSW") , "MSW", Site.x)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(Campus.Specialty.Group == department) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p75_overall <- merge(P75_mshs, P75_site)
    p75_overall <- p75_overall %>%
      mutate(Metric = "p75")
    
    
    metrics_merged <- bind_rows(waitTime_overall, newPTs_overall, vol_var_overall, conversion_rate_all, p50_overall, p75_overall)
    metrics_merged <- metrics_merged %>%
      dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.Group , Quarter))
    
    # Metrics Overview Table Output ----------------------------------------------  
  overview_tbl <- data.frame(
    Metric = c("waitTime",
              "newPTs",
              "var_last_yr",
              "Conversion",
              "p50",
              "p75"),
    `Metric Group` = c(rep("Access & Volume",3),
                       rep("Referrals", 1),
                       rep("Physician Productivity", 2)),
    `Metric Name` = c("Median Time to New Appointment",
              "% of New Patients Scheduled <=14 Days",
              "% of Office Volume Increase/Decrease from Prior Year",
              "% of Referrals Converted to Scheduled Appointments (YTD)",
              "% of Physicians Above P50",
              "% of Physicians Above P75"),
    Benchmark = c("14 days",
                  "80%",
                  "TBD",
                  "TBD",
                  "100%",
                  "100%")
  )
    
  overview_tbl <- left_join(overview_tbl, metrics_merged, by = "Metric")
  overview_tbl <- overview_tbl %>%
    dplyr::select(-c("Year")) 

  # Format table output 
  tbl_output <- 
    overview_tbl %>%
    arrange(factor(Metric.Group, levels = c("Access & Volume","Referrals", 
                                            "Physician Productivity",
                                            "Space"))) %>%
    dplyr::select(-Metric) %>%
    rename(Metric = Metric.Group) %>%
    flextable() %>%
    autofit() %>%
    merge_v(j = ~Metric) %>%
    merge_at(j = c(1:2), part = "header") %>%
    fontsize(size = 12, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    hline(border = fp_border(color="grey", width = 2), part="header") %>%
    hline_bottom(border = fp_border(color="grey", width = 2), part="all") %>%
    vline(j = 3, border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = c(3,4,6), border = fp_border(color="grey", width = 2), part="body") %>%
    fix_border_issues() %>%
    # bold(j = c(1:(length(overview_tbl)-1)), part = "header") %>%
    bold(j = 1, part = "all") %>%
    # surround(border.bottom = fp_border(color = "gray"), part = "all") %>%
    # surround(i = 1, border.bottom = fp_border(color = "black"), part = "header") %>%
    # surround(j = c(3:(length(overview_tbl)-1)), border.left = fp_border(color = "gray"), part = "all") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(2:nrow(overview_tbl)),
     digits = 0,
     suffix = "%") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(1),
     digits = 0,
     suffix = " days") %>%
    align(j = c(3:(length(overview_tbl)-1)), align = "center", part = "all") %>%
    align(j = c(1:(length(overview_tbl)-1)), align = "center", part = "header") %>%
    bg(j = c(1:3), bg = "#212070", part = "header") %>%
    bg(j = c(4:(length(overview_tbl)-1)), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:(length(overview_tbl)-1)), color = "white", part = "header") %>%
    color(j = 2, color = "#212070", part = "header") %>%
    width(j = 1, width = 1) %>%
    width(j = 2, width = 2.2) %>%
    width(j = c(4:(length(overview_tbl)-1)), width = 1.1) %>%
    height(height = 0.5, part = "body") 
    # style(i = 1 < 14, 
    #       ~ Overall + MSBI + `MSH- AMBULATORY CARE` + `MSH-MSDFP` + MSM + MSUS + MSW,
    #       pr_t = fp_text(color = "red", italic = TRUE, bold = TRUE)) %>%

}


metrics_overview_office_tbl_sub <- function(department, subspecialty){
# department <- "Medicine"
# subspecialty <- "Hospitalist"
    # Median Time to New Appointment
  waitTime_mshs_summary <- waitTime_mshs_office_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    dplyr::select(med_wait) %>%
    mutate(med_wait = as.numeric(med_wait))
  
  waitTime_site_summary <- waitTime_site_office_ytd %>%
    filter(Campus.Specialty.Group  == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>%
    mutate(med_wait = as.numeric(med_wait)) %>%
    pivot_wider(names_from = Site,
                values_from = med_wait,
                values_fill = NA) %>%
    dplyr::select(-New.PT2)
  
  waitTime_overall <- merge(waitTime_mshs_summary, waitTime_site_summary)
  waitTime_overall <- waitTime_overall %>% 
      rename(Year = Appt.Made.Year,
             Overall = med_wait) %>%
    mutate(Metric = "waitTime")
  
  # New Patients Scheduled <=14 days 
  newPTs_mshs <- waitTime_dist_specialty_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100)
  
  newPTs_site <- waitTime_dist_site_office_ytd %>%
    filter(Campus.Specialty.Group == department) %>%
    filter(Campus.Specialty.SubGroup  == subspecialty) %>%
    filter(Appt.Made.Year == reporting_year) %>%
    filter(New.PT2 == "New") %>% 
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year, New.PT2, group) %>%
    summarise(total = sum(total)) %>%
    mutate(new_perc = round(total/sum(total),2)) %>%
    filter(group %in% c("0-7","8-14")) %>%
    group_by(Campus.Specialty.Group, Site, Appt.Made.Year) %>%
    summarise(new_perc = sum(new_perc)*100) %>%
    pivot_wider(names_from = Site,
                values_from = new_perc)
  
  newPTs_overall <- merge(newPTs_mshs, newPTs_site)
  newPTs_overall <- newPTs_overall %>% 
      rename(Quarter = Appt.Made.Year,
             Overall = new_perc) %>%
      mutate(Metric = "newPTs")
  
  
  # Quarterly Volume Change
  vol_var_mshs <- monthly_vol_office %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      filter(Visit.Method == "Total") %>%
      # mutate(Appt.Year = format(as.Date(Appt.YearQtr), "%Y")) %>%
      group_by(Campus.Specialty.Group, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total)
  
  nms <- c("Campus.Specialty.Group", "2022", "2023")
  Missing <- setdiff(nms, names(vol_var_mshs))  # Find names of missing columns
  vol_var_mshs[Missing] <- 0                    # Add them, filled with '0's
  vol_var_mshs <- vol_var_mshs[nms]
  
  vol_var_mshs <- vol_var_mshs %>%
      mutate(var_last_yr = round((.[[3]]-.[[2]])/.[[2]]*100)) %>%
      rename(Overall = var_last_yr) %>%
      mutate(Metric ="var_last_yr") %>%
      dplyr::select(Campus.Specialty.Group, Metric, Overall)
    
    vol_var_site <- monthly_vol_office %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      filter(Visit.Method == "Total") %>%
      filter(Appt.MonNum %in% ytd_month_list) %>%
      # mutate(Appt.Year = format(as.Date(Appt.YearQtr), "%Y")) %>%
      group_by(Campus.Specialty.Group, Site, Appt.Year) %>%
      summarise(total = sum(monthly_vol)) %>%
      pivot_wider(names_from = Appt.Year,
                  values_from = total) %>%
      ungroup()
    
    nms <- c("Campus.Specialty.Group", "Site",  "2022", "2023")
  Missing <- setdiff(nms, names(vol_var_site))  # Find names of missing columns
  vol_var_site[Missing] <- 0                    # Add them, filled with '0's
  vol_var_site <- vol_var_site[nms]
      
  vol_var_site <- vol_var_site %>%
      mutate(var_last_yr = round((.[[4]]-.[[3]])/.[[3]]*100)) %>%
      dplyr::select(Campus.Specialty.Group, Site, var_last_yr) %>%
      pivot_wider(names_from = Site,
                  values_from = var_last_yr)
    
    
    vol_var_overall <- merge(vol_var_mshs, vol_var_site)
    
    
    # Referrals Conversion Rate
    conversion_data <- monthly_referral_vol %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      filter(Received.MonNum %in% ytd_month_list) %>%
    filter(Received.Year == reporting_year)
      
    
    conversion_rate_mshs <- conversion_data %>%
      mutate(Campus = "Overall") %>%
      group_by(Campus, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Campus) %>%
      pivot_wider(names_from = ApptStatusFinal,
                  values_from = total, 
                  values_fill = 0) 
    
    nms <- c("Campus", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate_mshs))  # Find names of missing columns
  conversion_rate_mshs[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate_mshs <- conversion_rate_mshs[nms]
  
  conversion_rate_mshs <- conversion_rate_mshs %>%    
      mutate(Total = rowSums(across(where(is.numeric)))) %>%
      mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
             `Completion Rate` = round(Arrived/Total,2)*100) %>%
      dplyr::select(Campus, `Conversion Rate`) %>%
      pivot_wider(names_from = Campus,
                  values_from = `Conversion Rate`)
    
    conversion_rate_site <- conversion_data %>%
      group_by(Site, ApptStatusFinal) %>%
      summarise(total = sum(total)) %>%
      group_by(Site) %>%
     pivot_wider(names_from = ApptStatusFinal,
                 values_from = total, 
                 values_fill = 0) 
    
    nms <- c("Site", "Arrived", "No Show", "Canceled", "Pending")
  Missing <- setdiff(nms, names(conversion_rate_site))  # Find names of missing columns
  conversion_rate_site[Missing] <- 0                    # Add them, filled with '0's
  conversion_rate_site <- conversion_rate_site[nms]
  
  conversion_rate_site <- conversion_rate_site %>%
     mutate(Total = rowSums(across(where(is.numeric)))) %>%
     mutate(`Conversion Rate` = round((Total - Pending)/Total,2)*100,
            `Completion Rate` = round(Arrived/Total,2)*100) %>%
     dplyr::select(Site, `Conversion Rate`) %>%
     pivot_wider(names_from = Site,
                values_from = `Conversion Rate`) 
  
  
  conversion_rate_all <- cbind(conversion_rate_mshs, conversion_rate_site)
  conversion_rate_all$Metric <- "Conversion"
    
    
    # % Physicians >=P50
    P50_mshs <- productivity_raw %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(Campus.Specialty.Group == department) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    P50_site <- productivity_raw %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(Campus.Specialty.Group == department) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=0.50, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p50_overall <- merge(P50_mshs, P50_site)
    p50_overall <- p50_overall %>%
      mutate(Metric = "p50")
    
    
    # % Physicians >=P75
    P75_mshs <- productivity_raw %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      mutate(temp_site = ifelse(Site %in% c("MSW/MSM","MSM/MSW", "MSM/ MSW", "MSW/ MSM") , "MSW", Site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(group) %>%
      summarise(total = n()) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      dplyr::select(-c(total,group)) 

    
    # Physicians Above >=P75
    P75_site <- productivity_raw %>%
      filter(Campus.Specialty.Group == department) %>%
      filter(Campus.Specialty.SubGroup  == subspecialty) %>%
      mutate(temp_site = ifelse(Site.x %in% c("MSW/MSM","MSM/MSW") , "MSW", Site.x)) %>%
      mutate(temp_site = ifelse(temp_site == "MSBk", "MSB", temp_site)) %>%
      mutate(temp_site = ifelse(temp_site == "MSH", "MSH-MSDFP", temp_site)) %>%
      filter(`Master Dept` %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(Site.x %!in% c("BIMG","MS DOCS","West Care/ West Park","HUDSON YARDS","MANHASSET","MSQ","Network")) %>%
      filter(!is.na(`Master Dept`)) %>%
      filter(Campus.Specialty.Group == department) %>%
      # filter(`2023 Reported CFTE` >=0.25) %>%
      dplyr::select(temp_site, NPI, Physician, `2023 Calculate %`) %>%
      distinct() %>%
      mutate(group = ifelse(`2023 Calculate %` >=.75, "Yes","No")) %>%
      group_by(temp_site, group) %>%
      summarise(total = n()) %>%
      group_by(temp_site) %>%
      mutate(Overall = round(total/sum(total),2)*100) %>%
      filter(group == "Yes") %>%
      rename(Site = temp_site) %>%
      dplyr::select(Site, Overall) %>%
      pivot_wider(names_from = Site,
                  values_from = Overall)
    
    p75_overall <- merge(P75_mshs, P75_site)
    p75_overall <- p75_overall %>%
      mutate(Metric = "p75")
    
    
    metrics_merged <- bind_rows(waitTime_overall, newPTs_overall, vol_var_overall, conversion_rate_all, p50_overall, p75_overall)
    metrics_merged <- metrics_merged %>%
      dplyr::select(-c(Campus.Specialty.Group, Campus.Specialty.Group , Quarter))
    
    # Metrics Overview Table Output ----------------------------------------------  
  overview_tbl <- data.frame(
    Metric = c("waitTime",
              "newPTs",
              "var_last_yr",
              "Conversion",
              "p50",
              "p75"),
    `Metric Group` = c(rep("Access & Volume",3),
                       rep("Referrals", 1),
                       rep("Physician Productivity", 2)),
    `Metric Name` = c("Median Time to New Appointment",
              "% of New Patients Scheduled <=14 Days",
              "% of Office Volume Increase/Decrease from Prior Year",
              "% of Referrals Converted to Scheduled Appointments (YTD)",
              "% of Physicians Above P50",
              "% of Physicians Above P75"),
    Benchmark = c("14 days",
                  "80%",
                  "TBD",
                  "TBD",
                  "100%",
                  "100%")
  )
    
  overview_tbl <- left_join(overview_tbl, metrics_merged, by = "Metric")
  overview_tbl <- overview_tbl %>%
    dplyr::select(-c("Campus.Specialty.SubGroup","Year")) 

  # Format table output 
  tbl_output <- 
    overview_tbl %>%
    arrange(factor(Metric.Group, levels = c("Access & Volume","Referrals", 
                                            "Physician Productivity",
                                            "Space"))) %>%
    dplyr::select(-Metric) %>%
    rename(Metric = Metric.Group) %>%
    flextable() %>%
    autofit() %>%
    merge_v(j = ~Metric) %>%
    merge_at(j = c(1:2), part = "header") %>%
    fontsize(size = 12, part = "all") %>%
    font(fontname = "Calibri", part = "all") %>%
    hline(border = fp_border(color="grey", width = 2), part="header") %>%
    hline_bottom(border = fp_border(color="grey", width = 2), part="all") %>%
    vline(j = 3, border = fp_border(color="grey", width = 0.5), part="body") %>%
    hline(i = c(3,4,6), border = fp_border(color="grey", width = 2), part="body") %>%
    fix_border_issues() %>%
    # bold(j = c(1:(length(overview_tbl)-1)), part = "header") %>%
    bold(j = 1, part = "all") %>%
    # surround(border.bottom = fp_border(color = "gray"), part = "all") %>%
    # surround(i = 1, border.bottom = fp_border(color = "black"), part = "header") %>%
    # surround(j = c(3:(length(overview_tbl)-1)), border.left = fp_border(color = "gray"), part = "all") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(2:nrow(overview_tbl)),
     digits = 0,
     suffix = "%") %>%
    colformat_double(
     j = c(4:(length(overview_tbl)-1)),
     i = c(1),
     digits = 0,
     suffix = " days") %>%
    align(j = c(3:(length(overview_tbl)-1)), align = "center", part = "all") %>%
    align(j = c(1:(length(overview_tbl)-1)), align = "center", part = "header") %>%
    bg(j = c(1:3), bg = "#212070", part = "header") %>%
    bg(j = c(4:(length(overview_tbl)-1)), bg = "#d80b8c", part = "header") %>%
    color(j = c(1:(length(overview_tbl)-1)), color = "white", part = "header") %>%
    color(j = 2, color = "#212070", part = "header") %>%
    width(j = 1, width = 1) %>%
    width(j = 2, width = 2.2) %>%
    width(j = c(4:(length(overview_tbl)-1)), width = 1.1) %>%
    height(height = 0.5, part = "body") 
    # style(i = 1 < 14, 
    #       ~ Overall + MSBI + `MSH- AMBULATORY CARE` + `MSH-MSDFP` + MSM + MSUS + MSW,
    #       pr_t = fp_text(color = "red", italic = TRUE, bold = TRUE)) %>%

}

# require(devtools)
# require(utils)
# require(versions)
# require(remotes)
# install_version("officer", version = "0.4.2", repos = "http://cran.us.r-project.org")
# 
# require(officer)
#   
```

```{r Action Plan Table Output, echo = FALSE, warning = FALSE, message = FALSE}

`Focus` = c(rep("Access & Volume",3),  rep("Referrals",3),
            rep("Productivity & Recruitment",3),
                   rep("Space",3), rep("Finance",3))
`Initiative` = c(rep("",15))
`Goals` = c(rep("",15))
Status = c(rep("",15))

actionPlan_output <- data.frame(`Focus`, `Initiative`,
                                `Goals`, Status)

actionPlan_output <- actionPlan_output %>%
  flextable() %>%
  autofit() %>%
  fontsize(size = 14, part = "all") %>%
  font(fontname = "Calibri", part = "all") %>%
  bold(j = 1, part = "all") %>%
  bold(j = c(1:4), part = "header") %>%
  merge_v(j = ~Focus) %>%
  set_header_labels(Focus = "Focus Area", Initiative = "Initiative Description", 
                    Goals = "Goals & Challenges", Status = "Status") %>%
  surround(border.bottom = fp_border(color = "gray"), part = "all") %>%
  surround(i = 1, border.bottom = fp_border(color = "black"), part = "header") %>%
  bg(j = c(2:4), bg = "#212070", part = "header") %>%
  color(j = c(2:4), color = "white", part = "header") %>%
  width(j = 1, width = 2) %>%
  width(j = c(2:3), width = 4.7) %>%
  width(j = 4, width = 1.5) %>%
  height(height = 0.35, part = "body")

```

```{r Metric Definitions, echo = FALSE, warning = FALSE, message = FALSE}

metrics_def <- data.frame(Metric = c("Net Operating Variance to Budget",
                                     "Patient Revenue Variance to Budget",
                                     "Expense Variance to Budget",
                                     "Physician Productivity",
                                     "Time to Appointment",
                                     "Referrals - Conversion Rate",
                                     "Referrals - Completion Rate",
                                     "Average Weekday Visits",
                                     "Variance from Benchmark",
                                     "% Utilization (By Turns)",
                                     "% Utilization (By Durations)",
                                     "Average Utilization by Hour"),
                          Definition = c("Difference between an actual surplus (or deficit) and a budgeted surplus (or deficit).",
                                         "Difference between actual patient revenue and budgeted patient revenue",
                                         "Difference between actual expense and budgeted expense",
                                         "A measure of the amount of patient care services provided, based on total worked",
                                         "Number of days between date-of-schedule and date-of-service.",
                                         "Percent of total number of appointments scheduled over total number of referrals received",
                                         "Percent of total number of arrived appointments over total number of referrals received.",
                                         "Total number of arrived visits over total number of business days in a time period.",
                                         "Difference between Average Weekday Volume and Expected Daily Volume Target based on total room count and visits/room/day benchmark (i.e. 10 rooms available per day and 10 visits/room/day benchmark equals to 100 expected daily volume target; 120 average weekday volume results in 20 Volume Variance to Benchmark).",
                                         "Average weekday volume over total number of rooms available over visits/room/day benchmark.",
                                         "Total sum of scheduled visit durations with 20% adjustment factor over total room time available. Total room time available is calculated based on Total Rooms Available per Day x Total Working Hours per Day (10 rooms available per day x 8 working hours per day = 80 hours of room time available per day).",
                                         "Total sum of scheduled visit durations with 20% adjustment factor over total room time available within the respective hour (2 30-minute visits scheduled at 9:00am and 9:30am with 1 rooms available = 60 minutes of visit duration / 60 room time available = 100% Utilization)."))


metrics_def_tbl <- flextable(metrics_def) %>%
  fontsize(size = 12, part = "all") %>%
  font(fontname = "Calibri", part = "all") %>%
  autofit() %>%
  bold(j = 1, part = "all") %>%
  bold(i = 1, part = "header") %>%
  bg(j = c(1:length(metrics_def)), bg = "#212070", part = "header") %>%
  color(j = c(1:length(metrics_def)), color = "white", part = "header") %>%
  border_inner_h(border = fp_border_default(width = 1, color = "lightgrey"), part="all") %>%
  # surround(i = 1, border.bottom = fp_border(color = "white"), part = "all") %>%
  width(j = 1, 3) %>%
  width(j = 2, 9) 


```

```{r Quarterly Performance Report PPT Ouput, ft.align = "center", echo = FALSE, warning = FALSE, message = FALSE}

specialties <- c(
  "Cardiovascular Institute/Cardiology",
  "Cardiovascular Surgery",
  "Dermatology",
  "Genetics & Genomic Sciences",
  "Geriatrics",
  "Neurology",
  "Neurosurgery",
  "OB-GYN",
  "Ophthalmology",
  "Orthopedics",
  "Otolaryngology",
  "Rehabilitation and Human Performance",
  "Surgery",
  "Thoracic Surgery",
  "Tisch Institute/Hematology Oncology",
  "Transplant Institute",
  "Breast Surgery",
  "Urology"
  )


for(i in specialties){

  i <- "Thoracic Surgery"
  # j <- "OMS"

  # 1. Import in pptx template ----------------------------------------------------
  ppt_temp <- read_pptx("template_performanceReport.pptx")
    
  # 2. Create Title Slide ------------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title Slide", master = "Default Theme")
  ppt_temp  <- ph_with(ppt_temp, value = paste0("Finance & Operational Performance Report"), 
                       location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <-  ph_with(ppt_temp, value = as.character(reporting_month), 
                       location = ph_location_label(ph_label = "Subtitle 2"))
  ppt_temp <-  ph_with(ppt_temp, value = i, 
                       location = ph_location_label(ph_label = "Text Placeholder 6"))
  
  # 3. Major Secions ------------------------------------------------------------
  # 3.2 All Subspecialties Combined --------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = i,
                      location = ph_location_label(ph_label = "Title 1"))
  
  # 3.2.1 Introduction  =========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ppt_temp %>% 
    ph_with(value = "Introduction", 
            location = ph_location_label(ph_label = "Title 1")) 
  
  
  # 3.2.2 Create Finance Metrics Slide ================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("Finance - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Net Operating Variance to Budget - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Revenue Variance to Budget - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Expense Variance to Budget - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  
  # 3.2.3 Create Payer Mix by Site Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Payer Mix"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_ytd(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_trending(i),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live; based on coverage associated to completed visits, not charges.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  # Create Open Encounteres Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "EPIC Open Encounters"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_open_enc_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_trending(i),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # 3.2.4 Create Productivity Metrics Slide ==========================================
  ## Create Section Header
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Physician Productivity",
                      location = ph_location_label(ph_label = "Title 1"))
  
  ## Productivity Summary -----------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Productivity Summary"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_summary_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_comparison_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data; excludes providers <0.25 CFTE",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Productivity Improvement Graph--------------------------------------------
  # ppt_temp <- ppt_temp %>%
  #   add_slide(layout = "Productivity_Improvement", master = "Default Theme")
  # ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Referral"," - ",i), 
  #                     location = ph_location_label(ph_label = "Title 1"))
  # ppt_temp <- ph_with(ppt_temp, value = productivity_summary_graph_function(i),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  # par_style <- fp_par(text.align = "left", padding.bottom = 5)
  # ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data; excludes providers <0.25 CFTE",
  #                                                  prop = text_style), fp_p = par_style),
  #                     location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Productivity by Provider -------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Physicians Above P75"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_100_function(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value =paste0(reporting_month," ", "Physicians P50-74"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_75_function(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
 ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of  2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
 
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Physicians Below P50"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_50_function(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of  2/21/2024; 2022 and 2022 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # 3.3 Create Volume & Access Slide -----------------------------------------------
  ## Section Header 
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Volume & Access - All Encounters",
                      location = ph_location_label(ph_label = "Title 1"))
  
  # 3.3.1 All Encounters -------------------------------------------------------
  ## Volume  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, paste0(reporting_month," ", "Encounter Volume"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Generate Volume Heat Map Title
  text_style <- fp_text(font.size = 16, bold = TRUE, font.family = "Calibri")
  par_style <- fp_par(text.align = "center")
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Volume by Geography", prop = text_style), fp_p = par_style),  
                      location = ph_location_label(ph_label = "Text Placeholder 7"))
  ### Generate and save volume heat map 
  dept_heat_map_function(i) 
  ppt_temp <- ph_with(ppt_temp, value = external_img(src = "vol_heat_map.png", height = 1.06/2, width = 1.39/2),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  
  ### Key Takeaways 
  vol_slide_takeaways <- block_list(fpar(ftext(paste0("Total volume for ",reporting_month," was ",dept_monthly_vol_takeaway(i)[2],
                                                      " (",dept_monthly_vol_takeaway(i)[1]," was in-person visits)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                    fpar(ftext(paste0("Average monthly volume was ",dept_monthly_vol_takeaway(i)[3]),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0("This is ",dept_monthly_vol_takeaway(i)[4]," change from prior YTD (total MSHS change: ",
                                                      dept_monthly_vol_takeaway(i)[8],"; median change across all departments: ", 
                                                      dept_monthly_vol_takeaway(i)[9],")"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0(dept_monthly_vol_takeaway(i)[5]," completed the largest volume with ",dept_monthly_vol_takeaway(i)[6],
                                                      " visits (",dept_monthly_vol_takeaway(i)[7]," of total volume)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = vol_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  
  ## Volume Comparison Table ===================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Volume Trending"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_tbl(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Access Metrics Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Access"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = overall_time_to_appt_dist_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = site_time_to_appt_function(i),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; Wait Time is total days from appointment scheduled to date of service (including weekends); Time to Appointment Horizon excludes MSDMG and NETWORK.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Key Takeaways 
  access_slide_takeaways <- block_list(fpar(ftext(paste0("Total new patient visits scheduled in ",reporting_month," was ",dept_access_takeaway(i)[1],
                                                         " (",dept_access_takeaway(i)[2]," of total visits scheduled)"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                       fpar(ftext(paste0(dept_access_takeaway(i)[3],
                                                         " of new in-office ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway(i)[7],"; median across all departments: ",
                                                         dept_access_takeaway(i)[10],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0(dept_access_takeaway(i)[4],
                                                         " of new telehealth ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway(i)[8],"; median across all departments: ",
                                                         dept_access_takeaway(i)[11],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0("Median wait time for new ",i," patients across all sites is ",
                                                         dept_access_takeaway(i)[5], " days"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = access_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  ### Office Encounters ------------------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Volume & Access - Office Visits",
                      location = ph_location_label(ph_label = "Title 1"))

  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, paste0(reporting_month," ", "Office Volume"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_office_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Generate Volume Heat Map Title
  text_style <- fp_text(font.size = 16, bold = TRUE, font.family = "Calibri")
  par_style <- fp_par(text.align = "center")
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Office Volume by Geography", prop = text_style), fp_p = par_style),  
                      location = ph_location_label(ph_label = "Text Placeholder 7"))
  ### Generate and save volume heat map 
  dept_heat_map_office_function(i) 
  ppt_temp <- ph_with(ppt_temp, value = external_img(src = "vol_heat_map.png", height = 1.06/2, width = 1.39/2),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  
  ### Key Takeaways 
  vol_slide_takeaways <- block_list(fpar(ftext(paste0("Total volume for ",reporting_month," was ",dept_monthly_vol_office_takeaway(i)[2],
                                                      " (",dept_monthly_vol_office_takeaway(i)[1]," was in-person visits)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                    fpar(ftext(paste0("Average monthly volume was ",dept_monthly_vol_office_takeaway(i)[3]),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0("This is ",dept_monthly_vol_office_takeaway(i)[4]," change from prior YTD (total MSHS change: ",
                                                      dept_monthly_vol_office_takeaway(i)[8],"; median change across all departments: ", 
                                                      dept_monthly_vol_office_takeaway(i)[9],")"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0(dept_monthly_vol_office_takeaway(i)[5]," completed the largest volume with ",dept_monthly_vol_office_takeaway(i)[6],
                                                      " visits (",dept_monthly_vol_office_takeaway(i)[7]," of total volume)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = vol_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  ## Volume Comparison Table ===================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Volume Trending"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_office_tbl(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Access Metrics Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Access"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = overall_time_to_appt_dist_office_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = site_time_to_appt_office_function(i),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; Wait Time is total days from appointment scheduled to date of service (including weekends); Time to Appointment Horizon excludes MSDMG and NETWORK.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Key Takeaways 
  access_slide_takeaways <- block_list(fpar(ftext(paste0("Total new patient visits scheduled in ",reporting_month," was ",dept_access_takeaway_office(i)[1],
                                                         " (",dept_access_takeaway_office(i)[2]," of total visits scheduled)"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                       fpar(ftext(paste0(dept_access_takeaway_office(i)[3],
                                                         " of new in-office ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_office(i)[7],"; median across all departments: ",
                                                         dept_access_takeaway_office(i)[10],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0(dept_access_takeaway_office(i)[4],
                                                         " of new telehealth ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_office(i)[8],"; median across all departments: ",
                                                         dept_access_takeaway_office(i)[11],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0("Median wait time for new ",i," patients across all sites is ",
                                                         dept_access_takeaway_office(i)[5], " days"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = access_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  ## Referrals Metric Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Referral"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = conversion_rate_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live; Conversion Rate is percent of scheduled appointments over referrals received; Completion Rate is percent of arrived appointments over referrals received.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  
  # 6. Create Metrics Overview/Action Plan Slide -------------------------------
  ## Section Header ============================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Metrics Overview & Action Plan",
                      location = ph_location_label(ph_label = "Title 1"))
  

  ## Metrics Overview Table ====================================================
  ### All Visit Types 
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Center", master = "Default Theme")
  ppt_temp <- ppt_temp %>% 
    ph_with(value = paste0(reporting_month," ", "Metrics Overview"," - ",i), 
            location = ph_location_label(ph_label = "Title 1")) 
  ppt_temp <- ph_with(ppt_temp, value = metrics_overview_tbl(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; physician productivity site mappings are based on cFTE attribution (MSW/MSM providers mapped to MSW, MSUS providers mapped to MSBI, and MSH providers mapped to MSH-MSDFP).",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Office Visits Only
  # ppt_temp <- ppt_temp %>%
  #   add_slide(layout = "Title and Content_Center", master = "Default Theme")
  # ppt_temp <- ppt_temp %>% 
  #   ph_with(value = paste0(reporting_month," ", "Metrics Overview"," - ",i), 
  #           location = ph_location_label(ph_label = "Title 1")) 
  # ppt_temp <- ph_with(ppt_temp, value = metrics_overview_office_tbl(i),
  #                     location = ph_location_label(ph_label = "Content Placeholder 2"))
  # text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  # par_style <- fp_par(text.align = "left", padding.bottom = 5)
  # ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; physician productivity site mappings are based on cFTE attribution (MSW/MSM providers mapped to MSW, MSUS providers mapped to MSBI, and MSH providers mapped to MSH-MSDFP).",
  #                                                  prop = text_style), fp_p = par_style),
  #                     location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # 2. Add Improving Access Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Diagram", master = "Default Theme")
  ppt_temp  <- ph_with(ppt_temp, value = paste0("Improving Access"), 
                       location = ph_location_label(ph_label = "Title 1"))
  
  ## Metric Definitions
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Center", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Metric Definitions", 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = metrics_def_tbl,
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  
  
  # Compiled Slide Output --------------------------------------------------------
  dir <- "~/qpr-processing/2023/"
  print(ppt_temp, target=paste0(dir,paste0(reporting_month, "_Performance Report_UPDATED_", gsub("/", "_", i),".pptx")))
  
}


```

```{r Quarterly Performance Report PPT Ouput Multiple Sections, ft.align = "center", echo = FALSE, warning = FALSE, message = FALSE}

specialties <- c(
  "Medicine",
  "Pediatrics",
  "Otolaryngology"
  )

subspecialties_count <- monthly_vol %>% 
  filter(!is.na(Campus.Specialty.SubGroup)) %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup, Site) %>%
  summarise(total = n()) %>%
  ungroup() %>%
  group_by(Campus.Specialty.Group, Campus.Specialty.SubGroup) %>%
  summarise(total = length(unique(Site)))
  


for(i in specialties){

  # i <- "Medicine"
  # j <- "OMS"

  subspecialties <- sort((subspecialties_count %>% filter(Campus.Specialty.Group == i))$Campus.Specialty.SubGroup)


  # 1. Import in pptx template ----------------------------------------------------
  ppt_temp <- read_pptx("template_performanceReport.pptx")
    
  # 2. Create Title Slide ------------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title Slide", master = "Default Theme")
  ppt_temp  <- ph_with(ppt_temp, value = paste0("Finance & Operational Performance Report"), 
                       location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <-  ph_with(ppt_temp, value = as.character(reporting_month), 
                       location = ph_location_label(ph_label = "Subtitle 2"))
  ppt_temp <-  ph_with(ppt_temp, value = i, 
                       location = ph_location_label(ph_label = "Text Placeholder 6"))
  
  # 3. Major Secions ------------------------------------------------------------
  # 3.2 All Subspecialties Combined --------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = i,
                      location = ph_location_label(ph_label = "Title 1"))
  
  # 3.2.1 Introduction  =========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ppt_temp %>% 
    ph_with(value = "Introduction", 
            location = ph_location_label(ph_label = "Title 1")) 
  
  
  # 3.2.2 Create Finance Metrics Slide ================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("Finance - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Net Operating Variance to Budget - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Revenue Variance to Budget - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Expense Variance to Budget - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  
  # 3.2.3 Create Payer Mix by Site Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Payer Mix"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_ytd(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_trending(i),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live; based on coverage associated to completed visits, not charges.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # Create Open Encounteres Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "EPIC Open Encounters"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_open_enc_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_trending(i),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # 3.2.4 Create Productivity Metrics Slide ==========================================
  ## Create Section Header
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Physician Productivity",
                      location = ph_location_label(ph_label = "Title 1"))
  
  ## Productivity Summary -----------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Productivity Summary"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_summary_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_comparison_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Productivity Improvement Graph--------------------------------------------
  # ppt_temp <- ppt_temp %>%
  #   add_slide(layout = "Productivity_Improvement", master = "Default Theme")
  # ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Referral"," - ",i), 
  #                     location = ph_location_label(ph_label = "Title 1"))
  # ppt_temp <- ph_with(ppt_temp, value = productivity_summary_graph_function(i),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  # par_style <- fp_par(text.align = "left", padding.bottom = 5)
  # ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data; excludes providers < CFTE",
  #                                                  prop = text_style), fp_p = par_style),
  #                     location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Productivity by Provider -------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Physicians Above P75"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_100_function(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value =paste0(reporting_month," ", "Physicians P50-74"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_75_function(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
 ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of  2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
 
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Physicians Below P50"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_50_function(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of  2/21/2024; 2022 and 2022 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # 3.3 Create Volume & Access Slide -----------------------------------------------
  ## Section Header 
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Volume & Access - All Encounters",
                      location = ph_location_label(ph_label = "Title 1"))
  
  # 3.3.1 All Encounters -------------------------------------------------------
  ## Volume  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, paste0(reporting_month," ", "Encounter Volume"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Generate Volume Heat Map Title
  text_style <- fp_text(font.size = 16, bold = TRUE, font.family = "Calibri")
  par_style <- fp_par(text.align = "center")
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Volume by Geography", prop = text_style), fp_p = par_style),  
                      location = ph_location_label(ph_label = "Text Placeholder 7"))
  ### Generate and save volume heat map 
  dept_heat_map_function(i) 
  ppt_temp <- ph_with(ppt_temp, value = external_img(src = "vol_heat_map.png", height = 1.06/2, width = 1.39/2),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  
  ### Key Takeaways 
  vol_slide_takeaways <- block_list(fpar(ftext(paste0("Total volume for ",reporting_month," was ",dept_monthly_vol_takeaway(i)[2],
                                                      " (",dept_monthly_vol_takeaway(i)[1]," was in-person visits)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                    fpar(ftext(paste0("Average monthly volume was ",dept_monthly_vol_takeaway(i)[3]),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0("This is ",dept_monthly_vol_takeaway(i)[4]," change from prior YTD (total MSHS change: ",
                                                      dept_monthly_vol_takeaway(i)[8],"; median change across all departments: ", 
                                                      dept_monthly_vol_takeaway(i)[9],")"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0(dept_monthly_vol_takeaway(i)[5]," completed the largest volume with ",dept_monthly_vol_takeaway(i)[6],
                                                      " visits (",dept_monthly_vol_takeaway(i)[7]," of total volume)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = vol_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  
  ## Volume Comparison Table ===================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Volume Trending"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_tbl(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Access Metrics Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Access"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = overall_time_to_appt_dist_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = site_time_to_appt_function(i),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; Wait Time is total days from appointment scheduled to date of service (including weekends); Time to Appointment Horizon excludes MSDMG and NETWORK.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Key Takeaways 
  access_slide_takeaways <- block_list(fpar(ftext(paste0("Total new patient visits scheduled in ",reporting_month," was ",dept_access_takeaway(i)[1],
                                                         " (",dept_access_takeaway(i)[2]," of total visits scheduled)"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                       fpar(ftext(paste0(dept_access_takeaway(i)[3],
                                                         " of new in-office ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway(i)[7],"; median across all departments: ",
                                                         dept_access_takeaway(i)[10],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0(dept_access_takeaway(i)[4],
                                                         " of new telehealth ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway(i)[8],"; median across all departments: ",
                                                         dept_access_takeaway(i)[11],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0("Median wait time for new ",i," patients across all sites is ",
                                                         dept_access_takeaway(i)[5], " days"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = access_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  ### Office Encounters ------------------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Volume & Access - Office Visits",
                      location = ph_location_label(ph_label = "Title 1"))

  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, paste0(reporting_month," ", "Office Volume"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_office_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Generate Volume Heat Map Title
  text_style <- fp_text(font.size = 16, bold = TRUE, font.family = "Calibri")
  par_style <- fp_par(text.align = "center")
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Office Volume by Geography", prop = text_style), fp_p = par_style),  
                      location = ph_location_label(ph_label = "Text Placeholder 7"))
  ### Generate and save volume heat map 
  dept_heat_map_office_function(i) 
  ppt_temp <- ph_with(ppt_temp, value = external_img(src = "vol_heat_map.png", height = 1.06/2, width = 1.39/2),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  
  ### Key Takeaways 
  vol_slide_takeaways <- block_list(fpar(ftext(paste0("Total volume for ",reporting_month," was ",dept_monthly_vol_office_takeaway(i)[2],
                                                      " (",dept_monthly_vol_office_takeaway(i)[1]," was in-person visits)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                    fpar(ftext(paste0("Average monthly volume was ",dept_monthly_vol_office_takeaway(i)[3]),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0("This is ",dept_monthly_vol_office_takeaway(i)[4]," change from prior YTD (total MSHS change: ",
                                                      dept_monthly_vol_office_takeaway(i)[8],"; median change across all departments: ", 
                                                      dept_monthly_vol_office_takeaway(i)[9],")"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0(dept_monthly_vol_office_takeaway(i)[5]," completed the largest volume with ",dept_monthly_vol_office_takeaway(i)[6],
                                                      " visits (",dept_monthly_vol_office_takeaway(i)[7]," of total volume)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = vol_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  ## Volume Comparison Table ===================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Volume Trending"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_office_tbl(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Access Metrics Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Access"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = overall_time_to_appt_dist_office_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = site_time_to_appt_office_function(i),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; Wait Time is total days from appointment scheduled to date of service (including weekends); Time to Appointment Horizon excludes MSDMG and NETWORK.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Key Takeaways 
  access_slide_takeaways <- block_list(fpar(ftext(paste0("Total new patient visits scheduled in ",reporting_month," was ",dept_access_takeaway_office(i)[1],
                                                         " (",dept_access_takeaway_office(i)[2]," of total visits scheduled)"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                       fpar(ftext(paste0(dept_access_takeaway_office(i)[3],
                                                         " of new in-office ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_office(i)[7],"; median across all departments: ",
                                                         dept_access_takeaway_office(i)[10],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0(dept_access_takeaway_office(i)[4],
                                                         " of new telehealth ",i,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_office(i)[8],"; median across all departments: ",
                                                         dept_access_takeaway_office(i)[11],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0("Median wait time for new ",i," patients across all sites is ",
                                                         dept_access_takeaway_office(i)[5], " days"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = access_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  ## Referrals Metric Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Referral"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = conversion_rate_function(i),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live; Conversion Rate is percent of scheduled appointments over referrals received; Completion Rate is percent of arrived appointments over referrals received.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  
  # 6. Create Metrics Overview/Action Plan Slide -------------------------------
  ## Section Header ============================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Metrics Overview & Action Plan",
                      location = ph_location_label(ph_label = "Title 1"))
  

  ## Metrics Overview Table ====================================================
  ### All Visit Types 
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Center", master = "Default Theme")
  ppt_temp <- ppt_temp %>% 
    ph_with(value = paste0(reporting_month," ", "Metrics Overview"," - ",i), 
            location = ph_location_label(ph_label = "Title 1")) 
  ppt_temp <- ph_with(ppt_temp, value = metrics_overview_tbl(i),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; physician productivity site mappings are based on cFTE attribution (MSW/MSM providers mapped to MSW, MSUS providers mapped to MSBI, and MSH providers mapped to MSH-MSDFP).",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Office Visits Only
  # ppt_temp <- ppt_temp %>%
  #   add_slide(layout = "Title and Content_Center", master = "Default Theme")
  # ppt_temp <- ppt_temp %>% 
  #   ph_with(value = paste0(reporting_month," ", "Metrics Overview"," - ",i), 
  #           location = ph_location_label(ph_label = "Title 1")) 
  # ppt_temp <- ph_with(ppt_temp, value = metrics_overview_office_tbl(i),
  #                     location = ph_location_label(ph_label = "Content Placeholder 2"))
  # text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  # par_style <- fp_par(text.align = "left", padding.bottom = 5)
  # ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; physician productivity site mappings are based on cFTE attribution (MSW/MSM providers mapped to MSW, MSUS providers mapped to MSBI, and MSH providers mapped to MSH-MSDFP).",
  #                                                  prop = text_style), fp_p = par_style),
  #                     location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  
  
  
  
  
  ### Volume & Access by Subspecialty -------------------------------------------
  for(j in subspecialties){
    
    # j <- "Chest"
    
    # 3. Major Secions ------------------------------------------------------------
  # 3.2 All Subspecialties Combined --------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = j,
                      location = ph_location_label(ph_label = "Title 1"))
  
  # 3.2.1 Introduction  =========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ppt_temp %>% 
    ph_with(value = "Introduction", 
            location = ph_location_label(ph_label = "Title 1")) 
  
  
  # 3.2.2 Create Finance Metrics Slide ================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("Finance - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Net Operating Variance to Budget - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Revenue Variance to Budget - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0("FPA Expense Variance to Budget - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  
  
  # 3.2.3 Create Payer Mix by Site Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Payer Mix"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_ytd_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_trending_sub(i,j),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live; payer mix based on coverage associated to completed visits, not charges.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # Create Open Encounteres Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "EPIC Open Encounters"," - ",i), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_open_enc_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # ppt_temp <- ph_with(ppt_temp, value = dept_payer_mix_trending(i),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # 3.2.4 Create Productivity Metrics Slide ==========================================
  ## Create Section Header
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Physician Productivity",
                      location = ph_location_label(ph_label = "Title 1"))
  
  ## Productivity Summary -----------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Payer_Mix_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Productivity Summary"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_summary_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_comparison_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 3"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Productivity Improvement Graph--------------------------------------------
  # ppt_temp <- ppt_temp %>%
  #   add_slide(layout = "Productivity_Improvement", master = "Default Theme")
  # ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Referral"," - ",j), 
  #                     location = ph_location_label(ph_label = "Title 1"))
  # ppt_temp <- ph_with(ppt_temp, value = productivity_summary_graph_function_sub(i,j),
  #                     location = ph_location_label(ph_label = "Chart Placeholder 6"))
  # text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  # par_style <- fp_par(text.align = "left", padding.bottom = 5)
  # ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data; excludes providers <0.25 CFTE",
  #                                                  prop = text_style), fp_p = par_style),
  #                     location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Productivity by Provider -------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Physicians Above P75"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_100_function_sub(i,j),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of 2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value =paste0(reporting_month," ", "Physicians P50-74"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_75_function_sub(i,j),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
 ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of  2/21/2024; 2022 and 2023 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
 
  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Wide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Physicians Below P50"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = productivity_provider_50_function_sub(i,j),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Productivity and charges data as of  2/21/2024; 2022 and 2022 Calculate %'s based on Jan-Dec annualized data.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  # 3.3 Create Volume & Access Slide -----------------------------------------------
  ## Section Header 
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Volume & Access - All Encounters",
                      location = ph_location_label(ph_label = "Title 1"))
  
  # 3.3.1 All Encounters -------------------------------------------------------
  ## Volume  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, paste0(reporting_month," ", "Encounter Volume"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Generate Volume Heat Map Title
  text_style <- fp_text(font.size = 16, bold = TRUE, font.family = "Calibri")
  par_style <- fp_par(text.align = "center")
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Volume by Geography", prop = text_style), fp_p = par_style),  
                      location = ph_location_label(ph_label = "Text Placeholder 7"))
  ### Generate and save volume heat map 
  dept_heat_map_function_sub(i,j) 
  ppt_temp <- ph_with(ppt_temp, value = external_img(src = "vol_heat_map.png", height = 1.06/2, width = 1.39/2),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  
  ### Key Takeaways 
  vol_slide_takeaways <- block_list(fpar(ftext(paste0("Total volume for ",reporting_month," was ",dept_monthly_vol_takeaway_sub(i,j)[2],
                                                      " (",dept_monthly_vol_takeaway_sub(i,j)[1]," was in-person visits)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                    fpar(ftext(paste0("Average monthly volume was ",dept_monthly_vol_takeaway_sub(i,j)[3]),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0("This is ",dept_monthly_vol_takeaway_sub(i,j)[4]," change from prior YTD (total MSHS change: ",
                                                      dept_monthly_vol_takeaway_sub(i,j)[8],"; median change across all departments: ", 
                                                      dept_monthly_vol_takeaway_sub(i,j)[9],")"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0(dept_monthly_vol_takeaway_sub(i,j)[5]," completed the largest volume with ",dept_monthly_vol_takeaway_sub(i,j)[6],
                                                      " visits (",dept_monthly_vol_takeaway_sub(i,j)[7]," of total volume)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = vol_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  ## Volume Comparison Table ===================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Volume Trending"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_tbl_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Access Metrics Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Access"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = overall_time_to_appt_dist_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = site_time_to_appt_function_sub(i,j),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; Wait Time is total days from appointment scheduled to date of service (including weekends); Time to Appointment Horizon excludes MSDMG and NETWORK.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Key Takeaways 
  access_slide_takeaways <- block_list(fpar(ftext(paste0("Total new patient visits scheduled in ",reporting_month," was ",dept_access_takeaway_sub(i,j)[1],
                                                         " (",dept_access_takeaway_sub(i,j)[2]," of total visits scheduled)"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                       fpar(ftext(paste0(dept_access_takeaway_sub(i,j)[3],
                                                         " of new in-sub ",j,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_sub(i,j)[7],"; median across all departments: ",
                                                         dept_access_takeaway_sub(i,j)[10],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0(dept_access_takeaway_sub(i,j)[4],
                                                         " of new telehealth ",j,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_sub(i,j)[8],"; median across all departments: ",
                                                         dept_access_takeaway_sub(i,j)[11],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0("Median wait time for new ",j," patients across all sites is ",
                                                         dept_access_takeaway_sub(i,j)[5], " days"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = access_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2))
  
  ### Office Encounters ------------------------------------------------------------
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Volume & Access - Office Visits",
                      location = ph_location_label(ph_label = "Title 1"))

  
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "1_Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, paste0(reporting_month," ", "Office Volume"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_office_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Generate Volume Heat Map Title
  text_style <- fp_text(font.size = 16, bold = TRUE, font.family = "Calibri")
  par_style <- fp_par(text.align = "center")
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Office Volume by Geography", prop = text_style), fp_p = par_style),  
                      location = ph_location_label(ph_label = "Text Placeholder 7"))
  ### Generate and save volume heat map 
  dept_heat_map_office_function_sub(i,j) 
  ppt_temp <- ph_with(ppt_temp, value = external_img(src = "vol_heat_map.png", height = 1.06/2, width = 1.39/2),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  
  ### Key Takeaways 
  vol_slide_takeaways <- block_list(fpar(ftext(paste0("Total volume for ",reporting_month," was ",dept_monthly_vol_office_takeaway_sub(i,j)[2],
                                                      " (",dept_monthly_vol_office_takeaway_sub(i,j)[1]," was in-person visits)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                    fpar(ftext(paste0("Average monthly volume was ",dept_monthly_vol_office_takeaway_sub(i,j)[3]),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0("This is ",dept_monthly_vol_office_takeaway_sub(i,j)[4]," change from prior YTD (total MSHS change: ",
                                                      dept_monthly_vol_office_takeaway_sub(i,j)[8],"; median change across all departments: ", 
                                                      dept_monthly_vol_office_takeaway_sub(i,j)[9],")"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))),
                                    fpar(ftext(paste0(dept_monthly_vol_office_takeaway_sub(i,j)[5]," completed the largest volume with ",dept_monthly_vol_office_takeaway_sub(i,j)[6],
                                                      " visits (",dept_monthly_vol_office_takeaway_sub(i,j)[7]," of total volume)"),
                                               prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = vol_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2)) 
  
  
  ## Volume Comparison Table ===================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Volume Trending"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = dept_monthly_vol_office_tbl_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ## Access Metrics Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Two Vertical Tables", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Access"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = overall_time_to_appt_dist_office_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  ppt_temp <- ph_with(ppt_temp, value = site_time_to_appt_office_function_sub(i,j),
                      location = ph_location_label(ph_label = "Table Placeholder 9"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; Wait Time is total days from appointment scheduled to date of service (including weekends); Time to Appointment Horizon excludes MSDMG and NETWORK.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Key Takeaways 
  access_slide_takeaways <- block_list(fpar(ftext(paste0("Total new patient visits scheduled in ",reporting_month," was ",dept_access_takeaway_office_sub(i,j)[1],
                                                         " (",dept_access_takeaway_office_sub(i,j)[2]," of total visits scheduled)"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=16, bold = TRUE))),
                                       fpar(ftext(paste0(dept_access_takeaway_office_sub(i,j)[3],
                                                         " of new in-sub ",j,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_office_sub(i,j)[7],"; median across all departments: ",
                                                         dept_access_takeaway_office_sub(i,j)[10],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0(dept_access_takeaway_office_sub(i,j)[4],
                                                         " of new telehealth ",j,
                                                         " patients are scheduled within 14 days (total MSHS: ",
                                                         dept_access_takeaway_office_sub(i,j)[8],"; median across all departments: ",
                                                         dept_access_takeaway_office_sub(i,j)[11],")"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))),
                                       fpar(ftext(paste0("Median wait time for new ",j," patients across all sites is ",
                                                         dept_access_takeaway_sub(i,j)[5], " days"),
                                                  prop = fp_text(font.family = 'Calibri',font.size=14))))
  
  
  ppt_temp <- ph_with(ppt_temp, value = access_slide_takeaways,  
                      location = ph_location_label(ph_label = "Text Placeholder 3"),
                      level_list = c(1,2,2,2))
  
  
  ## Referrals Metric Slide ========================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Referrals_Slide", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = paste0(reporting_month," ", "Referral"," - ",j), 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = conversion_rate_function_sub(i,j),
                      location = ph_location_label(ph_label = "Chart Placeholder 6"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only; metrics do not account for any data prior to Epic go-live; Conversion Rate is percent of scheduled appointments over referrals received; Completion Rate is percent of arrived appointments over referrals received.",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  
  
  # 6. Create Metrics Overview/Action Plan Slide -------------------------------
  ## Section Header ============================================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Metrics Overview & Action Plan",
                      location = ph_location_label(ph_label = "Title 1"))
  

  ## Metrics Overview Table ====================================================
  ### All Visit Types 
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Center", master = "Default Theme")
  ppt_temp <- ppt_temp %>% 
    ph_with(value = paste0(reporting_month," ", "Metrics Overview"," - ",j), 
            location = ph_location_label(ph_label = "Title 1")) 
  ppt_temp <- ph_with(ppt_temp, value = metrics_overview_tbl_sub(i,j),
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  par_style <- fp_par(text.align = "left", padding.bottom = 5)
  ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; physician productivity site mappings are based on cFTE attribution (MSW/MSM providers mapped to MSW, MSUS providers mapped to MSBI, and MSH providers mapped to MSH-MSDFP).",
                                                   prop = text_style), fp_p = par_style),
                      location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  ### Office Visits Only
  # ppt_temp <- ppt_temp %>%
  #   add_slide(layout = "Title and Content_Center", master = "Default Theme")
  # ppt_temp <- ppt_temp %>% 
  #   ph_with(value = paste0(reporting_month," ", "Metrics Overview"," - ",j), 
  #           location = ph_location_label(ph_label = "Title 1")) 
  # ppt_temp <- ph_with(ppt_temp, value = metrics_overview_office_tbl_sub(i,j),
  #                     location = ph_location_label(ph_label = "Content Placeholder 2"))
  # text_style <- fp_text(font.size = 10, italic = TRUE, color = "#7f7f7f", font.family = "Calibri")
  # par_style <- fp_par(text.align = "left", padding.bottom = 5)
  # ppt_temp <- ph_with(ppt_temp, value = fpar(ftext("Includes Epic data only - metrics do not account for any data prior to Epic go-live; physician productivity site mappings are based on cFTE attribution (MSW/MSM providers mapped to MSW, MSUS providers mapped to MSBI, and MSH providers mapped to MSH-MSDFP).",
  #                                                  prop = text_style), fp_p = par_style),
  #                     location = ph_location_label(ph_label = "Footer Placeholder 4"))
  
  } # Close Volume and Access Section by Subspecialty
  
  
  ## Action Plan Table =========================================================
  # ppt_temp <- ppt_temp %>%
  #   add_slide(layout = "Action_Plan_Slide", master = "Default Theme")
  # ppt_temp <- ppt_temp %>% 
  #   ph_with(value = paste0(reporting_YearQtr," ", "Action Plan"," - ",i), 
  #           location = ph_location_label(ph_label = "Title 1")) 
  # ppt_Temp <- ph_with(ppt_temp, value = actionPlan_output,
  #                     location = ph_location_label(ph_label = "Content Placeholder 8"))
  
  
  # Appendix 
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Section Header", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Appendix",
                      location = ph_location_label(ph_label = "Title 1"))
  
  # 2. Add Improving Access Slide ==============================================
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Diagram", master = "Default Theme")
  ppt_temp  <- ph_with(ppt_temp, value = paste0("Improving Access"), 
                       location = ph_location_label(ph_label = "Title 1"))
  
  ## Metric Definitions
  ppt_temp <- ppt_temp %>%
    add_slide(layout = "Title and Content_Center", master = "Default Theme")
  ppt_temp <- ph_with(ppt_temp, value = "Metric Definitions", 
                      location = ph_location_label(ph_label = "Title 1"))
  ppt_temp <- ph_with(ppt_temp, value = metrics_def_tbl,
                      location = ph_location_label(ph_label = "Content Placeholder 2"))
  
  
  # Compiled Slide Output --------------------------------------------------------
  dir <- "~/qpr-processing/2023/"
  print(ppt_temp, target=paste0(dir,paste0(reporting_month, "_Performance Report_UPDATED", gsub("/", "_", i),".pptx")))
  
}


```
